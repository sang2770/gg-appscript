<!-- js.html -->
<script>
  // === Global Variables ===
  let chartInstance = null;
  let projectProgressChart = null;
  let staffPerformanceChart = null;
  let allProjects = [];
  let allTasks = [];
  let allStaff = [];
  let currentSection = "overview";
  let currentUser = null; // Store current logged in user
  let isAuthenticated = false;
  let draggedItem = null;
  let draggedProjectId = null;
  let currentStatListData = [];

  // === Gantt Chart Variables ===
  let currentGanttDate = new Date();
  let expandedProjects = new Set(); // Lưu ID của các dự án đang xổ

  let openedFromProjectDetails = null;

  // === Constants matching backend ===
  const COL = {
    P_ID: "Mã dự án",
    P_NAME: "Tên dự án",
    P_DESC: "Mô tả dự án",
    P_MANAGER: "Quản lý dự án",
    P_START: "Ngày bắt đầu",
    P_END: "Ngày kết thúc",
    P_STATUS: "Trạng thái dự án",
    T_ID: "Mã nhiệm vụ",
    T_PID: "Mã dự án",
    T_NAME: "Tên nhiệm vụ",
    T_DESC: "Mô tả nhiệm vụ",
    T_ASSIGNEE: "Người thực hiện",
    T_STATUS: "Trạng thái",
    T_PRIORITY: "Ưu tiên",
    T_START: "Ngày bắt đầu",
    T_DUE: "Hạn chót",
    T_COMPLETION: "Tiến độ (%)",
    T_REPORT_DATE: "Ngày hoàn thành",
    T_TARGET: "Mục tiêu",
    T_RESULT_LINKS: "Link kết quả",
    T_IMAGES: "Hình ảnh",
    T_OUTPUT: "Kết quả đầu ra",
    T_NOTES: "Ghi chú",
    T_SCORE: "Điểm",
    S_ID: "Mã NV",
    S_NAME: "Họ tên",
    S_EMAIL: "Email",
    S_POS: "Chức vụ",
    S_ROLE: "Phân quyền",
    S_PASSWORD: "Mật khẩu",
    A_TIME: "Thời gian",
    A_ACTION: "Hành động",
    A_USER: "Người thực hiện",
    A_DETAILS: "Chi tiết",
    N_ID: "Mã thông báo",
    N_TIME: "Thời gian",
    N_USER: "Người nhận",
    N_CONTENT: "Nội dung", // ← THÊM N_USER
    RAW_DATA: "Dữ liệu thô",
  };

  // === Initialization ===
  document.addEventListener("DOMContentLoaded", function () {
    setupEventListeners();
    checkAuthenticationAndInitialize();
  });

  function checkAuthenticationAndInitialize() {
    showLoading("Đang kiểm tra đăng nhập...");

    google.script.run
      .withSuccessHandler(function (response) {
        hideLoading();

        if (response.requireLogin) {
          // User not logged in, show login modal
          showLoginModal();
        } else if (response.success) {
          // User is logged in, initialize app
          handleSuccessfulLogin(response);
        } else {
          // Error occurred
          showToast(response.error || "Lỗi khi kiểm tra đăng nhập", "error");
          showLoginModal();
        }
      })
      .withFailureHandler(function (error) {
        hideLoading();
        showToast("Lỗi kết nối: " + error.message, "error");
        showLoginModal();
      })
      .getInitialDataWithAuth();
  }

  function showLoginModal() {
    const loginModal = document.getElementById("login-modal");
    if (loginModal) {
      loginModal.classList.remove("opacity-0", "invisible");
      loginModal.querySelector(".bg-white\\/90").classList.remove("scale-95");
      loginModal.querySelector(".bg-white\\/90").classList.add("scale-100");

      // Focus on email input
      setTimeout(() => {
        document.getElementById("login-email")?.focus();
      }, 300);
    }
  }

  function hideLoginModal() {
    const loginModal = document.getElementById("login-modal");
    if (loginModal) {
      loginModal.querySelector(".bg-white\\/90").classList.remove("scale-100");
      loginModal.querySelector(".bg-white\\/90").classList.add("scale-95");

      setTimeout(() => {
        loginModal.classList.add("opacity-0", "invisible");
      }, 200);
    }
  }

  function handleLogin(email, password) {
    if (!email || !password) {
      showLoginError("Vui lòng nhập đầy đủ email và mật khẩu");
      return;
    }

    setLoginLoading(true);

    // Start loading data in parallel while authenticating
    document.getElementById("login-loading").classList.remove("hidden");

    google.script.run
      .withSuccessHandler(function (response) {
        setLoginLoading(false);
        document.getElementById("login-loading").classList.add("hidden");

        if (response.success) {
          hideLoginModal();
          hideLoginError();

          // Get user data and initialize
          google.script.run
            .withSuccessHandler(function (dataResponse) {
              if (dataResponse.success) {
                handleSuccessfulLogin(dataResponse);
                showToast("Đăng nhập thành công!", "success");
              } else {
                showToast(dataResponse.error || "Lỗi khi tải dữ liệu", "error");
              }
            })
            .withFailureHandler(function (error) {
              showToast("Lỗi khi tải dữ liệu: " + error.message, "error");
            })
            .getDataForUser();
        } else {
          showLoginError(response.error || "Đăng nhập thất bại");
        }
      })
      .withFailureHandler(function (error) {
        setLoginLoading(false);
        document.getElementById("login-loading").classList.add("hidden");
        showLoginError("Lỗi kết nối: " + error.message);
      })
      .authenticateUser(email, password);
  }

  function handleSuccessfulLogin(dataResponse) {
    currentUser = dataResponse.user;
    isAuthenticated = true;

    allProjects = dataResponse.projects || [];
    allTasks = dataResponse.tasks || [];
    allStaff = dataResponse.staff || [];

    updateUIForUser(currentUser);

    // Render UI ngay lập tức
    renderStats(dataResponse.summaryStats);
    renderProjects();
    renderTasks();
    renderStaff();
    renderChart(dataResponse.chartData);
    renderProjectProgressChart();
    renderTaskPriorityChart();
    renderTimelineProgressChart();
    renderProjectComparisonChart();
    renderStaffPerformanceChart();
    renderActivity(dataResponse.recentActivities);
    renderPriorityTasksMini();
    renderStaffPerformanceReport();
    renderTaskStats();
    renderProjectStats();

    setupGanttEventListeners();
    if (currentSection === "gantt") {
      renderGanttChart();
    }

    // ← THÊM: Load chat async sau 500ms để UI render xong trước
    setTimeout(() => {
      if (currentSection === "overview") {
        loadChatMessagesAsync();
      }
    }, 500);
  }

  function loadChatMessagesAsync() {
    const container = document.getElementById("chat-messages");
    if (!container) return;

    // Hiển thị loading
    container.innerHTML =
      '<div class="text-center text-gray-500 text-sm py-4"><i class="fas fa-spinner fa-spin mr-2"></i>Đang tải tin nhắn...</div>';

    google.script.run
      .withSuccessHandler(function (messages) {
        renderChatMessages(messages);
        updateChatBadge(messages.length);
      })
      .withFailureHandler(function (error) {
        console.error("Error loading chat:", error);
        container.innerHTML =
          '<div class="text-center text-red-500 text-sm">Lỗi tải tin nhắn</div>';
      })
      .getChatMessages();
  }

  function updateUIForUser(user) {
    const isAdminUser = isAdmin();
    const isManagerUser =
      user.role && user.role.toLowerCase().includes("quản lý");

    // Update user info in sidebar
    document.getElementById("user-info").classList.remove("hidden");
    document.getElementById("login-prompt").classList.add("hidden");

    const userAvatar = document.getElementById("user-avatar");
    const userName = document.getElementById("user-name");
    const userRole = document.getElementById("user-role");

    if (userAvatar && userName && userRole) {
      const initials = user.name
        .split(" ")
        .map((n) => n[0])
        .join("")
        .toUpperCase()
        .slice(0, 2);
      userAvatar.textContent = initials;
      userName.textContent = user.name;
      userRole.textContent = user.role;
    }

    // THAY ĐỔI: Kiểm tra xem nhân viên có phải là người phụ trách dự án nào không
    const isProjectManager = allProjects.some(
      (project) => project[COL.P_MANAGER] === user.name,
    );

    // Hide/show navigation items based on role
    const projectsNav = document.getElementById("projects-nav");
    const staffNav = document.getElementById("staff-nav");

    if (isAdminUser) {
      // Show all nav items for admin
      if (projectsNav) projectsNav.style.display = "flex";
      if (staffNav) staffNav.style.display = "flex";
      showAdminButtons();
    } else if (isManagerUser) {
      // Show projects nav for managers, hide staff nav
      if (projectsNav) projectsNav.style.display = "flex";
      if (staffNav) staffNav.style.display = "none";
      hideAdminButtons();
    } else {
      // THAY ĐỔI: Hiển thị tab Dự án cho nhân viên phụ trách dự án
      if (projectsNav) {
        projectsNav.style.display = isProjectManager ? "flex" : "none";
      }
      if (staffNav) staffNav.style.display = "none";
      hideAdminButtons();
    }

    // Hiển thị button thêm thông báo cho admin
    const addNotificationBtn = document.getElementById("add-notification-btn");
    if (isAdminUser) {
      if (addNotificationBtn) addNotificationBtn.classList.remove("hidden");
    } else {
      if (addNotificationBtn) addNotificationBtn.classList.add("hidden");
    }

    // Update page title to show current user
    updatePageTitle();
  }

  function hideAdminButtons() {
    // Hide admin-only buttons
    const adminButtons = ["add-staff-btn", "quick-add-staff"];

    adminButtons.forEach((buttonId) => {
      const button = document.getElementById(buttonId);
      if (button) {
        button.style.display = "none";
      }
    });

    // THAY ĐỔI: Kiểm tra xem người dùng có phải là người phụ trách dự án nào không
    const isProjectManager = allProjects.some(
      (project) => project[COL.P_MANAGER] === currentUser.name,
    );

    // Hiển thị/ẩn project buttons based on permissions
    const projectButtons = [
      "add-project-btn",
      "add-project-standalone",
      "quick-add-project",
    ];

    projectButtons.forEach((buttonId) => {
      const button = document.getElementById(buttonId);
      if (button) {
        if (isAdmin() || isManager()) {
          button.style.display = "";
        } else {
          button.style.display = "none";
        }
      }
    });

    // Kiểm tra và ẩn/hiện task buttons based on permissions
    const taskButtons = [
      "add-task-btn",
      "add-task-standalone",
      "quick-add-task",
    ];

    taskButtons.forEach((buttonId) => {
      const button = document.getElementById(buttonId);
      if (button) {
        if (canUserCreateTask()) {
          button.style.display = ""; // Hiển thị
        } else {
          button.style.display = "none"; // Ẩn
        }
      }
    });

    // Hide admin action buttons in cards
    document.addEventListener("DOMContentLoaded", function () {
      hideActionButtons();
    });
  }

  function showAdminButtons() {
    // Show admin-only buttons
    const adminButtons = [
      "add-project-btn",
      "add-project-standalone",
      "add-task-btn",
      "add-task-standalone",
      "add-staff-btn",
      "quick-add-project",
      "quick-add-task",
      "quick-add-staff",
    ];

    adminButtons.forEach((buttonId) => {
      const button = document.getElementById(buttonId);
      if (button) {
        button.style.display = "";
      }
    });
  }

  function hideActionButtons() {
    const actionButtons = document.querySelectorAll(
      ".edit-btn, .delete-btn, .copy-btn",
    );
    actionButtons.forEach((button) => {
      const type = button.dataset.type;
      const id = button.dataset.id;

      if (isAdmin()) {
        // Admin có quyền đối với tất cả
        return;
      }

      // Xử lý nút copy
      if (button.classList.contains("copy-btn")) {
        if (!canUserCopyResource(type, id)) {
          button.style.display = "none";
        }
        return;
      }

      // Logic cũ cho edit và delete buttons...
      if (isManager()) {
        // Quản lý có thể thao tác với project và task, nhưng không với staff
        if (type === "staff") {
          button.style.display = "none";
        }
      } else if (type === "project" || type === "staff") {
        // Nhân viên thường không thể sửa/xóa dự án và nhân viên
        button.style.display = "none";
      } else if (type === "task") {
        // Kiểm tra nếu task thuộc dự án mà người dùng quản lý
        const task = allTasks.find((t) => t[COL.T_ID] === id);
        if (task) {
          const projectId = task[COL.T_PID];
          const project = allProjects.find((p) => p[COL.P_ID] === projectId);

          // Hiển thị nút nếu người dùng là người quản lý dự án hoặc người được giao
          if (project && project[COL.P_MANAGER] === currentUser.name) {
            return; // Hiển thị nút
          }

          // Ẩn nút nếu người dùng không phải người được giao
          if (task[COL.T_ASSIGNEE] !== currentUser.name) {
            button.style.display = "none";
          }
        }
      }
    });
  }

  function handleLogout() {
    if (confirm("Bạn có chắc chắn muốn đăng xuất?")) {
      // showLoading('Đang đăng xuất...');

      google.script.run
        .withSuccessHandler(function (response) {
          // hideLoading();

          // Reset application state
          currentUser = null;
          isAuthenticated = false;
          allProjects = [];
          allTasks = [];
          allStaff = [];

          // Reset UI
          document.getElementById("user-info").classList.add("hidden");
          document.getElementById("login-prompt").classList.remove("hidden");

          // Clear all sections
          clearAllSections();

          // Show login modal
          showLoginModal();

          showToast("Đăng xuất thành công", "success");
        })
        .withFailureHandler(function (error) {
          // hideLoading();
          showToast("Lỗi khi đăng xuất: " + error.message, "error");
        })
        .logout();
    }
  }

  function showChangePasswordModal() {
    const modalHTML = `
    <div id="change-password-modal" class="modal">
      <div class="modal-content max-w-md">
        <div class="flex items-center justify-between mb-6">
          <h3 class="text-xl font-bold text-gray-900">Đổi mật khẩu</h3>
          <button type="button" class="close-modal text-gray-400 hover:text-gray-600">
            <i class="fas fa-times"></i>
          </button>
        </div>
        
        <form id="change-password-form">
          <div class="form-group">
            <label class="form-label">Mật khẩu mới *</label>
            <input type="password" name="newPassword" class="form-input" required placeholder="Nhập mật khẩu mới">
          </div>
          
          <div class="form-group">
            <label class="form-label">Nhập lại mật khẩu mới *</label>
            <input type="password" name="confirmPassword" class="form-input" required placeholder="Nhập lại mật khẩu mới">
          </div>
          
          <div class="flex justify-end space-x-3 mt-6">
            <button type="button" class="btn-secondary close-modal">Hủy</button>
            <button type="submit" class="btn-primary">Đổi mật khẩu</button>
          </div>
        </form>
      </div>
    </div>
  `;

    document.getElementById("modals-container").innerHTML = modalHTML;

    const modal = document.getElementById("change-password-modal");
    modal.classList.add("active");

    // Setup form submission
    const form = modal.querySelector("form");
    form.addEventListener("submit", function (e) {
      e.preventDefault();
      const newPassword = form.newPassword.value.trim();
      const confirmPassword = form.confirmPassword.value.trim();

      const submitBtn = form.querySelector('button[type="submit"]');
      setButtonLoading(submitBtn, true);

      google.script.run
        .withSuccessHandler(function (response) {
          setButtonLoading(submitBtn, false);
          if (response.success) {
            showToast(response.message, "success");
            closeModal("change-password-modal");
          } else {
            // Hiển thị lỗi trong modal thay vì toast
            const errorDiv =
              modal.querySelector("#change-password-error") ||
              document.createElement("div");
            if (!modal.querySelector("#change-password-error")) {
              errorDiv.id = "change-password-error";
              errorDiv.className =
                "p-3 bg-red-50 border border-red-200 rounded-xl mb-4";
              errorDiv.innerHTML =
                '<div class="flex items-center"><i class="fas fa-exclamation-circle text-red-500 mr-2"></i><span class="text-sm text-red-700"></span></div>';
              form.insertBefore(
                errorDiv,
                form.querySelector(".flex.justify-end"),
              );
            }
            errorDiv.querySelector("span").textContent = response.error;
            errorDiv.classList.remove("hidden");
          }
        })
        .withFailureHandler(function (error) {
          setButtonLoading(submitBtn, false);
          showToast("Lỗi: " + error.message, "error");
        })
        .changePassword(newPassword, confirmPassword);
    });

    // Setup close handlers
    const closeButtons = modal.querySelectorAll(".close-modal");
    closeButtons.forEach((btn) => {
      btn.addEventListener("click", (e) => {
        e.preventDefault();
        closeModal("change-password-modal");
      });
    });
  }

  function setLoginLoading(isLoading) {
    const submitBtn = document.getElementById("login-submit-btn");
    const btnText = document.getElementById("login-btn-text");

    if (isLoading) {
      submitBtn.classList.add("loading");
      submitBtn.disabled = true;
      btnText.textContent = "";
    } else {
      submitBtn.classList.remove("loading");
      submitBtn.disabled = false;
      btnText.textContent = "Đăng nhập";
    }
  }

  function showLoginError(message) {
    const errorDiv = document.getElementById("login-error");
    const errorMessage = document.getElementById("login-error-message");

    if (errorDiv && errorMessage) {
      errorMessage.textContent = message;
      errorDiv.classList.remove("hidden");
    }
  }

  function clearAllSections() {
    // Clear all section content
    const sectionsToSelect = [
      "#projects-grid",
      "#tasks-grid",
      "#staff-grid",
      "#project-task-tree",
      "#priority-tasks",
      "#recent-activity",
    ];

    sectionsToSelect.forEach((selector) => {
      const element = document.querySelector(selector);
      if (element) {
        element.innerHTML =
          '<div class="loading-card">Vui lòng đăng nhập</div>';
      }
    });

    // Clear stats
    const statsElements = [
      "total-projects",
      "completed-projects",
      "project-completion-rate",
      "total-tasks",
      "completed-tasks",
      "task-completion-rate",
      "active-tasks",
      "pending-tasks",
      "paused-tasks",
      "overdue-tasks",
      "overdue-total-tasks",
      "overdue-rate",
    ];

    statsElements.forEach((id) => {
      const element = document.getElementById(id);
      if (element) {
        element.textContent = "-";
      }
    });
  }

  function updatePageTitle() {
    const pageTitle = document.getElementById("page-title");
    if (pageTitle && currentUser) {
      const sectionTitles = {
        overview: "Tổng Quan",
        projects: "Quản lý Dự án",
        tasks: "Quản lý Nhiệm vụ",
        staff: "Quản lý Nhân viên",
      };

      const baseTitle = sectionTitles[currentSection] || "Dashboard";
      const userName = currentUser.name || "User";
      pageTitle.textContent = `${baseTitle} - ${userName}`;
    }
  }

  function isAdmin() {
    return (
      currentUser &&
      currentUser.role &&
      currentUser.role.toLowerCase().includes("admin")
    );
  }

  function isManager() {
    return (
      currentUser &&
      currentUser.role &&
      currentUser.role.toLowerCase().includes("quản lý")
    );
  }

  function hideLoginError() {
    const errorDiv = document.getElementById("login-error");
    if (errorDiv) {
      errorDiv.classList.add("hidden");
    }
  }

  // === Event Listeners ===
  function setupEventListeners() {
    // Navigation
    document.querySelectorAll(".nav-link").forEach((link) => {
      link.addEventListener("click", function (e) {
        e.preventDefault();
        const section = this.dataset.section;
        if (section !== "activity" && isAuthenticated) {
          switchSection(section);
        }
      });
    });

    document
      .getElementById("send-chat-btn")
      ?.addEventListener("click", sendChatMessage);
    document
      .getElementById("chat-input")
      ?.addEventListener("keypress", function (e) {
        if (e.key === "Enter") {
          sendChatMessage();
        }
      });

    document.addEventListener("click", handleQuickCompleteTask);

    document
      .getElementById("change-password-btn")
      ?.addEventListener("click", showChangePasswordModal);

    // Mobile menu
    document
      .getElementById("mobile-menu-btn")
      .addEventListener("click", toggleMobileMenu);
    document
      .getElementById("mobile-overlay")
      .addEventListener("click", closeMobileMenu);

    // Authentication buttons
    document
      .getElementById("login-btn")
      ?.addEventListener("click", showLoginModal);
    document
      .getElementById("logout-btn")
      ?.addEventListener("click", handleLogout);

    // Login form
    document
      .getElementById("login-form")
      ?.addEventListener("submit", function (e) {
        e.preventDefault();
        const email = document.getElementById("login-email").value.trim();
        const password = document.getElementById("login-password").value.trim();
        handleLogin(email, password);
      });

    // Quick add buttons - only work if user is authenticated and has permission
    document
      .getElementById("quick-add-project")
      ?.addEventListener("click", () => {
        // Thay đổi điều kiện từ isAdmin() thành isAdmin() || isManager()
        if (isAuthenticated && (isAdmin() || isManager())) openModal("project");
      });
    document.getElementById("quick-add-task")?.addEventListener("click", () => {
      if (isAuthenticated && isAdmin()) openModal("task");
    });
    document
      .getElementById("quick-add-staff")
      ?.addEventListener("click", () => {
        if (isAuthenticated && isAdmin()) openModal("staff");
      });

    // Add buttons
    document
      .getElementById("add-project-btn")
      ?.addEventListener("click", () => {
        // Thay đổi điều kiện từ isAdmin() thành isAdmin() || isManager()
        if (isAuthenticated && (isAdmin() || isManager())) openModal("project");
      });
    document
      .getElementById("add-project-standalone")
      ?.addEventListener("click", () => {
        // Thay đổi điều kiện từ isAdmin() thành isAdmin() || isManager()
        if (isAuthenticated && (isAdmin() || isManager())) openModal("project");
      });
    document.getElementById("add-task-btn")?.addEventListener("click", () => {
      if (isAuthenticated && canUserCreateTask()) openModal("task");
    });
    document
      .getElementById("add-task-standalone")
      ?.addEventListener("click", () => {
        if (isAuthenticated && canUserCreateTask()) openModal("task");
      });

    // Và dòng này:
    document.getElementById("quick-add-task")?.addEventListener("click", () => {
      if (isAuthenticated && canUserCreateTask()) openModal("task");
    });

    // Thêm event listener cho nút thêm thông báo
    document
      .getElementById("add-notification-btn")
      ?.addEventListener("click", () => {
        if (isAuthenticated && isAdmin()) openModal("notification");
      });

    // Search
    document
      .getElementById("projects-search")
      ?.addEventListener("input", (e) => {
        filterCards(".project-card", e.target.value.toLowerCase());
      });

    document.getElementById("tasks-search")?.addEventListener("input", (e) => {
      filterTaskRows(e.target.value.toLowerCase());
    });

    // Status filters
    document
      .getElementById("tasks-status-filter")
      ?.addEventListener("change", filterTasks);
    document
      .getElementById("projects-status-filter")
      ?.addEventListener("change", filterProjects);

    // Global click handler for action buttons
    document.addEventListener("click", function (e) {
      if (!isAuthenticated) return;

      if (
        e.target.matches(".add-task-from-project-btn") ||
        e.target.closest(".add-task-from-project-btn")
      ) {
        const btn = e.target.matches(".add-task-from-project-btn")
          ? e.target
          : e.target.closest(".add-task-from-project-btn");
        const projectId = btn.dataset.projectId;
        const projectName = btn.dataset.projectName;

        if (isAuthenticated && canUserCreateTask()) {
          openTaskModalForProject(projectId, projectName);
        } else {
          showToast("Bạn không có quyền tạo nhiệm vụ", "error");
        }
      }

      if (e.target.matches(".edit-btn") || e.target.closest(".edit-btn")) {
        const btn = e.target.matches(".edit-btn")
          ? e.target
          : e.target.closest(".edit-btn");
        const type = btn.dataset.type;
        const id = btn.dataset.id;

        // Check if opened from project details modal
        if (
          document.getElementById("project-details-modal") &&
          type === "task"
        ) {
          const projectDetailsModal = document.getElementById(
            "project-details-modal",
          );
          const projectName = projectDetailsModal
            .querySelector("h3")
            .textContent.replace("Chi tiết dự án: ", "");
          const projectId = allTasks.find((t) => t[COL.T_ID] === id)?.[
            COL.T_PID
          ];
          openedFromProjectDetails = { projectId, projectName };
        }

        if (canUserEditResource(type, id)) {
          openEditModal(type, id);
        } else {
          showToast("Bạn không có quyền chỉnh sửa mục này", "error");
        }
      }

      if (e.target.matches(".delete-btn") || e.target.closest(".delete-btn")) {
        const btn = e.target.matches(".delete-btn")
          ? e.target
          : e.target.closest(".delete-btn");
        const type = btn.dataset.type;
        const id = btn.dataset.id;
        const name = btn.dataset.name || id;

        // Check permissions
        if (canUserDeleteResource(type, id)) {
          confirmDelete(type, id, name);
        } else {
          showToast("Bạn không có quyền xóa mục này", "error");
        }
      }

      if (e.target.matches(".copy-btn") || e.target.closest(".copy-btn")) {
        const btn = e.target.matches(".copy-btn")
          ? e.target
          : e.target.closest(".copy-btn");
        const type = btn.dataset.type;
        const id = btn.dataset.id;
        const name = btn.dataset.name || id;

        // Check permissions
        if (canUserCopyResource(type, id)) {
          openCopyModal(type, id, name);
        } else {
          showToast("Bạn không có quyền tạo bản sao mục này", "error");
        }
      }

      if (
        e.target.matches(".submit-result-btn") ||
        e.target.closest(".submit-result-btn")
      ) {
        const btn = e.target.matches(".submit-result-btn")
          ? e.target
          : e.target.closest(".submit-result-btn");
        const taskId = btn.dataset.id;
        const taskName = btn.dataset.name || taskId;

        if (isAuthenticated && canUserSubmitResult(taskId)) {
          openSubmitResultModal(taskId, taskName);
        } else {
          showToast("Bạn không có quyền nộp kết quả cho nhiệm vụ này", "error");
        }
      }

      // THÊM: Xử lý nút view-project-btn
      if (
        e.target.matches(".view-project-btn") ||
        e.target.closest(".view-project-btn")
      ) {
        const btn = e.target.matches(".view-project-btn")
          ? e.target
          : e.target.closest(".view-project-btn");
        const projectId = btn.dataset.id;
        const projectName = btn.dataset.name;

        if (projectId) {
          showProjectDetailsModal(projectId, projectName);
        }
      }

      // Project expand/collapse
      if (
        e.target.matches(".project-expand-btn") ||
        e.target.closest(".project-expand-btn")
      ) {
        const btn = e.target.matches(".project-expand-btn")
          ? e.target
          : e.target.closest(".project-expand-btn");
      }
    });

    document
      .getElementById("refresh-btn")
      ?.addEventListener("click", function () {
        if (isAuthenticated) {
          this.querySelector("i").classList.add("fa-spin");
          refreshData();
          setTimeout(() => {
            this.querySelector("i").classList.remove("fa-spin");
            showToast("Đã làm mới dữ liệu!", "success");
          }, 1500);
        }
      });

    document
      .querySelector('[data-section="overview"]')
      ?.addEventListener("click", function () {
        if (isAuthenticated) {
          const container = document.getElementById("chat-messages");
          if (container && container.innerHTML.trim() === "") {
            loadChatMessagesAsync(); // Chỉ load nếu chưa có messages
          }
        }
      });

    // --- SỰ KIỆN CLICK CHO 4 BOX THỐNG KÊ ---
    // 1. Box Tổng dự án
    document
      .getElementById("total-projects")
      ?.closest(".modern-stat-card")
      ?.addEventListener("click", () => {
        openStatListModal("project", "all", "Danh sách tất cả dự án");
      });

    // 2. Box Tổng nhiệm vụ
    document
      .getElementById("total-tasks")
      ?.closest(".modern-stat-card")
      ?.addEventListener("click", () => {
        openStatListModal("task", "all", "Danh sách tất cả nhiệm vụ");
      });

    // 3. Box Nhiệm vụ đang làm
    document
      .getElementById("active-tasks")
      ?.closest(".modern-stat-card")
      ?.addEventListener("click", () => {
        openStatListModal("task", "active", "Danh sách nhiệm vụ đang làm");
      });

    // 4. Box Nhiệm vụ quá hạn
    document
      .getElementById("overdue-tasks")
      ?.closest(".modern-stat-card")
      ?.addEventListener("click", () => {
        openStatListModal("task", "overdue", "Danh sách nhiệm vụ quá hạn");
      });

    // Thêm phần Gantt chart listeners
    setupGanttEventListeners();
  }

  function openTaskModalFromProject(projectId, projectName) {
    openedFromProjectDetails = { projectId, projectName };
    openTaskModalForProject(projectId, projectName);
  }

  function filterTasks() {
    const searchTerm = document
      .getElementById("tasks-search")
      .value.toLowerCase();
    const statusFilter = document.getElementById("tasks-status-filter").value;

    // CHỈ chọn các project containers, không chọn stats cards
    const projectContainers = document.querySelectorAll(
      "#tasks-section .glass-card:has(table)",
    );
    projectContainers.forEach((container) => {
      const rows = container.querySelectorAll("tbody tr");
      let hasVisibleTasks = false;

      rows.forEach((row) => {
        const text = row.textContent.toLowerCase();
        const statusBadge = row.querySelector(".status-badge");
        const status = statusBadge ? statusBadge.textContent.trim() : "";

        const matchesSearch = text.includes(searchTerm);
        const matchesStatus = !statusFilter || status === statusFilter;
        const isVisible = matchesSearch && matchesStatus;

        row.style.display = isVisible ? "" : "none";
        if (isVisible) hasVisibleTasks = true;
      });

      container.style.display = hasVisibleTasks ? "" : "none";
    });
  }

  function filterProjects() {
    const searchTerm = document
      .getElementById("projects-search")
      .value.toLowerCase();
    const statusFilter = document.getElementById(
      "projects-status-filter",
    ).value;

    const cards = document.querySelectorAll(".project-card");
    cards.forEach((card) => {
      const text = card.textContent.toLowerCase();
      const statusBadge = card.querySelector(".status-badge");
      const status = statusBadge ? statusBadge.textContent.trim() : "";

      const matchesSearch = text.includes(searchTerm);
      const matchesStatus = !statusFilter || status === statusFilter;
      const isVisible = matchesSearch && matchesStatus;

      card.style.display = isVisible ? "block" : "none";
    });
  }

  function filterTaskRows(searchTerm) {
    // Chọn các containers có table (project containers), không chọn stats cards
    const allContainers = document.querySelectorAll(
      "#tasks-section .glass-card",
    );
    const projectContainers = Array.from(allContainers).filter(
      (container) => container.querySelector("table") !== null,
    );

    projectContainers.forEach((container) => {
      const rows = container.querySelectorAll("tbody tr");
      let hasVisibleTasks = false;

      rows.forEach((row) => {
        const text = row.textContent.toLowerCase();
        const isVisible = text.includes(searchTerm);
        row.style.display = isVisible ? "" : "none";
        if (isVisible) hasVisibleTasks = true;
      });

      // Ẩn/hiện cả project container dựa trên việc có task nào visible không
      container.style.display = hasVisibleTasks ? "" : "none";
    });
  }

  function showProjectDetailsModal(projectId, projectName) {
    // Lọc các nhiệm vụ thuộc dự án này
    const projectTasks = allTasks.filter(
      (task) => task[COL.T_PID] === projectId,
    );

    // Tính số liệu thống kê
    const totalTasks = projectTasks.length;
    const completedTasks = projectTasks.filter((task) =>
      (task[COL.T_STATUS] || "").toLowerCase().includes("hoàn thành"),
    ).length;
    const inProgressTasks = projectTasks.filter((task) =>
      (task[COL.T_STATUS] || "").toLowerCase().includes("đang"),
    ).length;
    const pendingTasks = projectTasks.filter((task) =>
      (task[COL.T_STATUS] || "").toLowerCase().includes("chưa"),
    ).length;
    const overdueTasks = projectTasks.filter(
      (task) =>
        isTaskOverdue(task[COL.T_DUE]) &&
        !(task[COL.T_STATUS] || "").toLowerCase().includes("hoàn thành"),
    ).length;
    // Tính tổng % tiến độ của tất cả task
    const totalPercent = projectTasks.reduce(
      (sum, task) => sum + parseInt(task[COL.T_COMPLETION] || 0),
      0,
    );
    // Tính trung bình cộng: (Tổng %) / (Số lượng task)
    const projectProgress =
      totalTasks > 0 ? Math.round(totalPercent / totalTasks) : 0;

    // Tạo HTML cho modal
    const modalHTML = `
        <div id="project-details-modal" class="modal">
            <div class="modal-content" style="max-width: 46rem;">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-xl font-bold text-gray-900">Chi tiết dự án: ${projectName} (${projectId})</h3>
                    <button type="button" class="close-modal text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <div class="mb-6">
                    <div class="grid grid-cols-4 gap-4 mb-6">
                        <div class="glass-card p-4 text-center">
                            <h4 class="text-lg font-semibold text-gray-700">${totalTasks}</h4>
                            <p class="text-sm text-gray-500">Tổng nhiệm vụ</p>
                        </div>
                        <div class="glass-card p-4 text-center bg-green-50">
                            <h4 class="text-lg font-semibold text-green-600">${completedTasks}</h4>
                            <p class="text-sm text-gray-500">Hoàn thành</p>
                        </div>
                        <div class="glass-card p-4 text-center bg-blue-50">
                            <h4 class="text-lg font-semibold text-blue-600">${inProgressTasks}</h4>
                            <p class="text-sm text-gray-500">Đang thực hiện</p>
                        </div>
                        <div class="glass-card p-4 text-center bg-red-50">
                            <h4 class="text-lg font-semibold text-red-600">${overdueTasks}</h4>
                            <p class="text-sm text-gray-500">Quá hạn</p>
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <div class="flex items-center justify-between mb-2">
                            <h4 class="font-semibold text-gray-700">Tiến độ dự án</h4>
                            <span class="text-sm font-semibold">${projectProgress}%</span>
                        </div>
                        <div class="h-2 bg-gray-200 rounded-full">
                            <div class="h-full bg-gradient-to-r from-blue-500 to-purple-600 rounded-full" style="width: ${projectProgress}%"></div>
                        </div>
                    </div>
                </div>
                
                <h4 class="font-semibold text-gray-900 mb-4">Danh sách nhiệm vụ (${totalTasks})</h4>
                
                <div class="max-h-96 overflow-y-auto">
                    ${
                      totalTasks > 0
                        ? `<div class="space-y-3">
                            ${projectTasks.map((task) => createTaskListItem(task)).join("")}
                        </div>`
                        : `<div class="text-center py-8 text-gray-500">
                            <i class="fas fa-tasks text-4xl mb-2 opacity-30"></i>
                            <p>Chưa có nhiệm vụ nào trong dự án này</p>
                        </div>`
                    }
                </div>
                
                <div class="flex justify-between mt-6">
                    <button onclick="openTaskModalFromProject('${projectId}', '${projectName}')" class="btn-secondary">
                        <i class="fas fa-plus mr-2"></i>Thêm nhiệm vụ
                    </button>
                    <button type="button" class="btn-primary close-modal">Đóng</button>
                </div>
            </div>
        </div>
    `;

    // Thêm modal vào DOM
    document.getElementById("modals-container").innerHTML = modalHTML;

    // Hiển thị modal
    const modal = document.getElementById("project-details-modal");
    modal.classList.add("active");

    // Setup close handler
    const closeButtons = modal.querySelectorAll(".close-modal");
    closeButtons.forEach((btn) => {
      btn.addEventListener("click", (e) => {
        e.preventDefault();
        closeModal("project-details-modal");
      });
    });
  }

  // Hàm tạo item cho danh sách nhiệm vụ trong modal
  function createTaskListItem(task) {
    const taskId = task[COL.T_ID] || "N/A";
    const taskName = task[COL.T_NAME] || "Chưa có tên";
    const taskAssignee = task[COL.T_ASSIGNEE] || "Chưa gán";
    const taskStatus = task[COL.T_STATUS] || "Chưa bắt đầu";
    const taskPriority = task[COL.T_PRIORITY] || "Trung bình";
    const taskDueDate = formatDateForDisplay(task[COL.T_DUE]);
    const taskCompletion = parseInt(task[COL.T_COMPLETION] || 0);
    const isOverdue =
      isTaskOverdue(task[COL.T_DUE]) &&
      !taskStatus.toLowerCase().includes("hoàn thành");
    const taskProjectId = task[COL.T_PID];

    const statusClass = getStatusClass(taskStatus);
    const priorityClass = getPriorityClass(taskPriority);

    return `
        <div class="glass-card p-4 hover:shadow-md transition-shadow ${isOverdue ? "border-l-4 border-red-500" : ""} task-clickable cursor-pointer draggable-item" 
             data-id="${taskId}" 
             data-project-id="${taskProjectId}"
             draggable="true">
            <div class="flex items-center justify-between">
                <div class="flex-1">
                    <h5 class="font-medium text-gray-900">${taskName} <span class="text-gray-500 text-xs">(${taskId})</span></h5>
                    
                    <div class="flex flex-wrap items-center gap-2 mt-2">
                        <span class="status-badge ${statusClass}">${taskStatus}</span>
                        <span class="status-badge ${priorityClass}">${taskPriority}</span>
                        ${isOverdue ? '<span class="status-badge status-overdue">Quá hạn</span>' : ""}
                    </div>
                </div>
                
                <div class="ml-4 flex flex-col items-end">
                    <div class="flex items-center space-x-1 mb-2">
                        ${(() => {
                          const project = allProjects.find(
                            (p) => p[COL.P_ID] === task[COL.T_PID],
                          );
                          const isProjectManager =
                            project &&
                            project[COL.P_MANAGER] === currentUser.name;
                          const canCopyDelete = isAdmin() || isProjectManager;

                          // Kiểm tra xem có nên hiển thị nút nộp kết quả hay không
                          const taskIsOverdue = isTaskOverdue(task[COL.T_DUE]);
                          const canSubmitResult = taskIsOverdue
                            ? canUserSubmitResultForOverdueTask(taskId)
                            : isAdmin() ||
                              isProjectManager ||
                              task[COL.T_ASSIGNEE] === currentUser.name;

                          return `
                            ${canSubmitResult ? `<button class="action-btn action-btn-view submit-result-btn" data-type="task" data-id="${taskId}" data-name="${taskName}" title="Nộp kết quả"><i class="fas fa-upload"></i></button>` : ""}
                            ${canCopyDelete ? `<button class="action-btn action-btn-copy copy-btn" data-type="task" data-id="${taskId}" data-name="${taskName}" title="Tạo bản sao"><i class="fas fa-copy"></i></button>` : ""}
                            ${canSubmitResult ? `<button class="action-btn action-btn-edit edit-btn" data-type="task" data-id="${taskId}" title="Chỉnh sửa"><i class="fas fa-edit"></i></button>` : ""}
                            ${canCopyDelete ? `<button class="action-btn action-btn-delete delete-btn" data-type="task" data-id="${taskId}" data-name="${taskName}" title="Xóa"><i class="fas fa-trash"></i></button>` : ""}
                          `;
                        })()}
                    </div>
                    <div class="flex items-center text-sm text-gray-600 mb-1">
                        <i class="fas fa-user mr-1"></i>
                        <span>${taskAssignee}</span>
                    </div>
                    <div class="flex items-center text-sm text-gray-600">
                        <i class="fas fa-calendar-alt mr-1"></i>
                        <span>${taskDueDate}</span>
                    </div>
                </div>
            </div>
            
            <div class="mt-3">
                <div class="flex items-center justify-between text-xs mb-1">
                    <span class="text-gray-600">Tiến độ</span>
                    <span class="${getProgressTextColor(taskCompletion)} font-semibold">${taskCompletion}%</span>
                </div>
                <div class="h-2 bg-gray-200 rounded-full">
                    <div class="h-full ${getProgressGradient(taskCompletion)} rounded-full transition-all duration-300" style="width: ${taskCompletion}%"></div>
                </div>
            </div>
        </div>
    `;
  }

  function canUserEditResource(type, id) {
    if (isAdmin()) return true;

    if (isManager()) {
      // Managers can edit projects and any tasks
      if (type === "project") {
        return true;
      }

      if (type === "task") {
        // Manager có thể sửa tất cả các task
        return true;
      }
    }

    // THÊM: Người dùng thường có thể sửa dự án họ phụ trách
    if (type === "project") {
      const project = allProjects.find((p) => p[COL.P_ID] === id);
      if (project && project[COL.P_MANAGER] === currentUser.name) {
        return true;
      }
      return false;
    }

    // Người dùng thường có thể sửa task trong dự án mà họ quản lý
    if (type === "task") {
      const task = allTasks.find((t) => t[COL.T_ID] === id);
      if (!task) return false;

      // Kiểm tra nếu task thuộc về dự án mà người dùng là quản lý
      const projectId = task[COL.T_PID];
      const project = allProjects.find((p) => p[COL.P_ID] === projectId);

      if (project && project[COL.P_MANAGER] === currentUser.name) {
        return true;
      }

      // Hoặc task được giao cho người dùng này
      return task[COL.T_ASSIGNEE] === currentUser.name;
    }

    return false;
  }

  function canUserDeleteResource(type, id) {
    if (isAdmin()) return true;

    if (isManager()) {
      // Managers can delete projects and any tasks
      if (type === "project") {
        return true;
      }

      if (type === "task") {
        // Manager có thể xóa tất cả các task
        return true;
      }
    }

    // THÊM: Người dùng thường có thể xóa dự án họ phụ trách
    if (type === "project") {
      const project = allProjects.find((p) => p[COL.P_ID] === id);
      if (project && project[COL.P_MANAGER] === currentUser.name) {
        return true;
      }
      return false;
    }

    // Người dùng thường có thể xóa task trong dự án mà họ quản lý
    if (type === "task") {
      const task = allTasks.find((t) => t[COL.T_ID] === id);
      if (!task) return false;

      // Kiểm tra nếu task thuộc về dự án mà người dùng là quản lý
      const projectId = task[COL.T_PID];
      const project = allProjects.find((p) => p[COL.P_ID] === projectId);

      if (project && project[COL.P_MANAGER] === currentUser.name) {
        return true;
      }

      // Hoặc task được giao cho người dùng này
      return task[COL.T_ASSIGNEE] === currentUser.name;
    }

    return false;
  }

  // === Navigation ===
  function switchSection(sectionName) {
    // Update active nav link
    document.querySelectorAll(".nav-link").forEach((link) => {
      link.classList.remove("active");
    });
    document
      .querySelector(`[data-section="${sectionName}"]`)
      .classList.add("active");

    // Update page title
    const titles = {
      overview: "Tổng Quan",
      projects: "Quản lý Dự án",
      tasks: "Quản lý Nhiệm vụ",
      staff: "Quản lý Nhân viên",
      gantt: "Sơ đồ Gantt", // Thêm tiêu đề cho tab Gantt
      calendar: "Lịch Nhiệm vụ", // Thêm tiêu đề cho tab Calendar
    };
    document.getElementById("page-title").textContent =
      titles[sectionName] || "Dashboard";

    // Show/hide sections
    document.querySelectorAll(".section").forEach((section) => {
      section.classList.remove("active");
    });
    document.getElementById(`${sectionName}-section`).classList.add("active");

    currentSection = sectionName;

    // Nếu chuyển sang tab Gantt, render biểu đồ
    if (sectionName === "gantt") {
      // Thêm timeout để đảm bảo DOM được cập nhật trước khi thiết lập event listeners
      setTimeout(() => {
        renderGanttChart();
        // setupGanttEventListeners() đã được gọi trong renderGanttChart() nên không cần gọi lại ở đây
      }, 10);
    }

    // Nếu chuyển sang tab Calendar, render calendar view
    if (sectionName === "calendar") {
      setTimeout(() => {
        initializeCalendar();
      }, 10);
    }

    // Close mobile menu if open
    closeMobileMenu();
  }

  function toggleMobileMenu() {
    const sidebar = document.getElementById("sidebar");
    const overlay = document.getElementById("mobile-overlay");

    sidebar.classList.add("open");
    overlay.classList.remove("hidden");
    setTimeout(() => overlay.classList.remove("opacity-0"), 10);
  }

  function closeMobileMenu() {
    const sidebar = document.getElementById("sidebar");
    const overlay = document.getElementById("mobile-overlay");

    sidebar.classList.remove("open");
    overlay.classList.add("opacity-0");
    setTimeout(() => overlay.classList.add("hidden"), 300);
  }

  // === Data Rendering ===
  function renderStats(stats) {
    // 1. TÍNH TOÁN LẠI TỪ DỮ LIỆU THỰC TẾ (allProjects, allTasks)
    const totalProjects = allProjects.length;
    const completedProjects = allProjects.filter((p) =>
      (p[COL.P_STATUS] || "").toLowerCase().includes("hoàn thành"),
    ).length;

    // Tính Tỷ lệ dự án (Trung bình cộng tiến độ các dự án)
    const sumAllProjectProgress = allProjects.reduce((acc, proj) => {
      const pTasks = allTasks.filter((t) => t[COL.T_PID] === proj[COL.P_ID]);
      const pProgress =
        pTasks.length > 0
          ? pTasks.reduce((s, t) => s + parseInt(t[COL.T_COMPLETION] || 0), 0) /
            pTasks.length
          : 0;
      return acc + pProgress;
    }, 0);
    const projectCompletionRate =
      totalProjects > 0 ? Math.round(sumAllProjectProgress / totalProjects) : 0;

    const totalTasks = allTasks.length;
    const completedTasks = allTasks.filter((t) =>
      (t[COL.T_STATUS] || "").toLowerCase().includes("hoàn thành"),
    ).length;
    const taskCompletionRate =
      totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;

    const pendingTasks = allTasks.filter((t) =>
      (t[COL.T_STATUS] || "").toLowerCase().includes("chưa"),
    ).length;
    const ongoingTasks = allTasks.filter((t) =>
      (t[COL.T_STATUS] || "").toLowerCase().includes("đang"),
    ).length;
    const pausedTasks = allTasks.filter((t) =>
      (t[COL.T_STATUS] || "").toLowerCase().includes("tạm dừng"),
    ).length;
    const activeTasks = ongoingTasks + pendingTasks + pausedTasks;

    const overdueTasks = allTasks.filter(
      (task) =>
        isTaskOverdue(task[COL.T_DUE]) &&
        !(task[COL.T_STATUS] || "").toLowerCase().includes("hoàn thành"),
    ).length;
    const overdueRate =
      totalTasks > 0 ? Math.round((overdueTasks / totalTasks) * 100) : 0;

    // 2. CẬP NHẬT UI
    document.getElementById("total-projects").textContent = totalProjects;
    document.getElementById("completed-projects").textContent =
      completedProjects;
    document.getElementById("project-completion-rate").textContent =
      `${projectCompletionRate}%`;

    document.getElementById("total-tasks").textContent = totalTasks;
    document.getElementById("completed-tasks").textContent = completedTasks;
    document.getElementById("task-completion-rate").textContent =
      `${taskCompletionRate}%`;

    document.getElementById("active-tasks").textContent = activeTasks;
    document.getElementById("pending-tasks").textContent = pendingTasks;
    document.getElementById("paused-tasks").textContent = pausedTasks;

    document.getElementById("overdue-tasks").textContent = overdueTasks;
    document.getElementById("overdue-total-tasks").textContent = totalTasks;
    document.getElementById("overdue-rate").textContent = `${overdueRate}%`;
  }

  function createPriorityTaskCard(task) {
    const taskId = task[COL.T_ID] || "N/A";
    const taskName = task[COL.T_NAME] || "Chưa có tên";
    const taskDesc = task[COL.T_DESC] || ""; // Thêm mô tả
    const taskProjectId = task[COL.T_PID] || "N/A";
    const taskAssignee = task[COL.T_ASSIGNEE] || "Chưa gán";
    const taskDueDate = formatDateForDisplay(task[COL.T_DUE]);
    const taskCompletion = parseInt(task[COL.T_COMPLETION] || 0);

    // Tìm tên dự án từ mã dự án
    const project = allProjects.find((p) => p[COL.P_ID] === taskProjectId);
    const projectName = project ? project[COL.P_NAME] : "";
    const projectDisplay = projectName
      ? `${projectName} (${taskProjectId})`
      : taskProjectId;

    const isOverdue = isTaskOverdue(task[COL.T_DUE]);

    return `
        <div class="priority-task-card" data-id="${taskId}">
            <div class="mb-3">
                <div class="flex items-start justify-between mb-1">
                    <h5 class="font-medium text-gray-900 text-sm leading-tight">${taskName}</h5>
                    ${isOverdue ? '<span class="status-badge status-overdue text-xs">Quá hạn</span>' : ""}
                </div>
                ${taskDesc ? `<p class="text-xs text-gray-600 mb-2 leading-relaxed">${taskDesc}</p>` : ""}
                <div class="text-xs text-gray-600 space-y-1">
                    <div><i class="fas fa-folder mr-1"></i>Dự án: ${projectDisplay}</div>
                    <div><i class="fas fa-user mr-1"></i>${taskAssignee}</div>
                    <div><i class="fas fa-calendar mr-1"></i>${taskDueDate}</div>
                </div>
            </div>
            <div class="flex items-center space-x-2">
                <span class="text-xs font-medium min-w-[30px] ${getProgressTextColor(taskCompletion)}">${taskCompletion}%</span>
                <div class="flex-1 h-2 bg-gray-200 rounded-full">
                    <div class="h-full ${getProgressGradient(taskCompletion)} rounded-full transition-all duration-300" style="width: ${taskCompletion}%"></div>
                </div>
            </div>
        </div>
    `;
  }

  function renderProjects() {
    const container = document.getElementById("projects-grid");
    if (!container) return;

    // Chỉ lấy các dự án mà người dùng có quyền xem
    const userProjects = getUserAllowedProjects();

    if (!userProjects || userProjects.length === 0) {
      container.innerHTML = '<div class="loading-card">Chưa có dự án nào</div>';
      return;
    }

    container.innerHTML = userProjects
      .map((project) => createProjectCard(project, true))
      .join("");
  }

  function createProjectCard(project, isDetailed = false) {
    const projectId = project[COL.P_ID] || "N/A";
    const projectName = project[COL.P_NAME] || "Chưa có tên";
    const projectDesc = project[COL.P_DESC] || "Không có mô tả";
    const projectManager = project[COL.P_MANAGER] || "Chưa gán";
    const projectStatus = project[COL.P_STATUS] || "Chưa bắt đầu";
    const startDate = formatDateForDisplay(project[COL.P_START]);
    const endDate = formatDateForDisplay(project[COL.P_END]);

    const statusClass = getStatusClass(projectStatus);

    // Tính toán tiến độ
    const pTasks = allTasks.filter((t) => t[COL.T_PID] === projectId);
    const totalPct = pTasks.reduce(
      (sum, t) => sum + parseInt(t[COL.T_COMPLETION] || 0),
      0,
    );
    const prog = pTasks.length > 0 ? Math.round(totalPct / pTasks.length) : 0;

    // SỬA: Thêm class 'project-clickable cursor-pointer' và 'data-name' vào thẻ div cha
    return `
        <div class="project-card project-clickable cursor-pointer" data-id="${projectId}" data-name="${projectName}">
            <div class="relative mb-4">
              <div class="absolute top-0 right-0 flex space-x-1">
                <button class="action-btn action-btn-edit add-task-from-project-btn" data-project-id="${projectId}" data-project-name="${projectName}" title="Thêm nhiệm vụ">
                  <i class="fas fa-plus"></i>
                </button>
                <button class="action-btn action-btn-view view-project-btn" data-type="project" data-id="${projectId}" data-name="${projectName}" title="Xem chi tiết">
                  <i class="fas fa-eye"></i>
                </button>
                ${
                  isAdmin() ||
                  (project[COL.P_MANAGER] === currentUser.name && isManager())
                    ? `
                  <button class="action-btn action-btn-copy copy-btn" data-type="project" data-id="${projectId}" data-name="${projectName}" title="Tạo bản sao">
                    <i class="fas fa-copy"></i>
                  </button>
                `
                    : ""
                }
                ${
                  isAdmin() || project[COL.P_MANAGER] === currentUser.name
                    ? `
                  <button class="action-btn action-btn-edit edit-btn" data-type="project" data-id="${projectId}" title="Chỉnh sửa">
                    <i class="fas fa-edit"></i>
                  </button>
                `
                    : ""
                }
                ${
                  isAdmin() ||
                  (project[COL.P_MANAGER] === currentUser.name && isManager())
                    ? `
                  <button class="action-btn action-btn-delete delete-btn" data-type="project" data-id="${projectId}" data-name="${projectName}" title="Xóa">
                    <i class="fas fa-trash"></i>
                  </button>
                `
                    : ""
                }
              </div>
              
              <div class="pr-20">
                <div class="mb-3">
                  <span class="status-badge ${statusClass}">${projectStatus}</span>
                </div>
              
                <h4 class="font-semibold text-gray-900 text-md mb-1">${projectName} (${projectId})</h4>
                <p class="text-sm text-gray-600 mb-2">${projectDesc}</p>
              </div>
            </div>
            
            ${
              isDetailed
                ? `
                <div class="space-y-2 text-xs text-gray-600">
                    <div class="flex items-center">
                        <i class="fas fa-calendar-alt w-4 mr-2 text-green-500"></i>
                        <span>Bắt đầu: ${startDate}</span>
                        
                        <i class="fas fa-calendar-check w-4 mr-2 text-red-500 ml-4"></i>
                        <span>Kết thúc: ${endDate}</span>
                    </div>
    
                    <div class="flex items-center justify-between">
                      <div class="flex items-center">
                        <i class="fas fa-user-tie w-4 mr-2 text-purple-500"></i>
                        <span>Quản lý: ${projectManager}</span>
                      </div>
                      <div class="flex items-center text-xs text-gray-600 bg-gray-100 px-2 py-1 rounded-full">
                        <i class="fas fa-tasks mr-1"></i>
                        <span>${pTasks.length} nhiệm vụ</span>
                      </div>
                    </div>

                    <div class="pt-2 border-t border-gray-100 mt-2">
                        <div class="flex justify-between mb-1">
                            <span class="font-medium">Tiến độ</span>
                            <span class="font-bold text-blue-600">${prog}%</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-1.5">
                            <div class="bg-gradient-to-r from-blue-500 to-purple-600 h-1.5 rounded-full transition-all duration-500" style="width: ${prog}%"></div>
                        </div>
                    </div>
                </div>
            `
                : ""
            }
        </div>
    `;
  }

  function renderTasks() {
    const container = document.getElementById("tasks-grid");
    if (!container) return;

    // 1. Lọc nhiệm vụ (Giữ nguyên logic cũ)
    let userTasks = [];
    if (isAdmin()) {
      userTasks = allTasks;
    } else {
      const userProjects = getUserAllowedProjects();
      userTasks = allTasks.filter((task) => {
        if (task[COL.T_ASSIGNEE] === currentUser.name) return true;
        const projectId = task[COL.T_PID];
        const project = allProjects.find((p) => p[COL.P_ID] === projectId);
        if (project && project[COL.P_MANAGER] === currentUser.name) return true;
        return false;
      });
    }

    if (!userTasks || userTasks.length === 0) {
      container.innerHTML =
        '<div class="loading-card">Chưa có nhiệm vụ nào</div>';
      return;
    }

    // 2. Nhóm tasks theo project
    const tasksByProject = {};
    userTasks.forEach((task) => {
      const projectId = task[COL.T_PID];
      if (!tasksByProject[projectId]) {
        tasksByProject[projectId] = [];
      }
      tasksByProject[projectId].push(task);
    });

    // --- SỬA: SẮP XẾP DANH SÁCH DỰ ÁN ĐỂ KHÔNG BỊ NHẢY ---
    // Lấy danh sách Project ID và sắp xếp (ví dụ theo ID tăng dần DA001, DA002...)
    const sortedProjectIds = Object.keys(tasksByProject).sort((a, b) => {
      // Sắp xếp theo logic string (hoặc bạn có thể custom theo ngày tạo nếu muốn)
      return a.localeCompare(b);
    });
    // ------------------------------------------------------

    container.className = "space-y-6";

    let html = "";
    // Duyệt qua danh sách ID đã sắp xếp
    sortedProjectIds.forEach((projectId) => {
      const project = allProjects.find((p) => p[COL.P_ID] === projectId);
      // Fallback nếu không tìm thấy project (trường hợp task mồ côi)
      const projectName = project ? project[COL.P_NAME] : `Dự án ${projectId}`;
      const projectStatus = project ? project[COL.P_STATUS] : "";
      const projectManager = project ? project[COL.P_MANAGER] : "";
      const projectStart = project
        ? formatDateForDisplay(project[COL.P_START])
        : "";
      const projectEnd = project
        ? formatDateForDisplay(project[COL.P_END])
        : "";

      // Lấy tasks của dự án này (đã được sort theo thứ tự trong mảng JSON nhờ logic backend reorder)
      const tasks = tasksByProject[projectId];

      html += `
      <div class="glass-card">
      <div class="bg-gradient-to-r from-blue-50 to-purple-50 px-2 py-2 border-b border-gray-100">
        <div class="flex items-center justify-between">
          <h3 class="text-lg font-semibold text-gray-900 flex items-center">
            ${projectName} (${projectId})
            <span class="status-badge ${getStatusClass(projectStatus)} ml-3 text-xs">${projectStatus || "Chưa bắt đầu"}</span>
          </h3>
          <div class="flex items-center space-x-3">
            <div class="flex items-center space-x-2">
              <span class="text-xs text-gray-500"> ${projectManager || "Chưa gán"} • ${projectStart} - ${projectEnd}</span>
              <span class="text-sm text-gray-600 bg-white px-3 py-1 rounded-full">${tasks.length} nhiệm vụ</span>
            </div>
            <button class="bg-gray-100 hover:bg-gray-200 text-gray-700 py-1 px-3 text-sm rounded-lg transition-colors duration-200 add-task-from-project-btn" data-project-id="${projectId}" data-project-name="${projectName}" title="Thêm nhiệm vụ">
              + Thêm
            </button>
          </div>
        </div>
      </div>
      <div class="overflow-x-auto">
        <table class="min-w-full table-auto">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Nhiệm vụ</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Người thực hiện</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Trạng thái</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Ưu tiên</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Tiến độ</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Link kết quả</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Điểm</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Link ảnh</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Ngày bắt đầu</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Hạn chót</th>
              <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Thao tác</th>
            </tr>
          </thead>
          <tbody class="bg-white divide-y divide-gray-200">
            ${tasks.map((task) => createTaskTableRowSimple(task)).join("")}
          </tbody>
        </table>
      </div>
      </div>
    `;
    });

    container.innerHTML = html;
  }

  function createTaskTableRowSimple(task) {
    const taskId = task[COL.T_ID] || "N/A";
    const taskName = task[COL.T_NAME] || "Chưa có tên";
    const taskAssignee = task[COL.T_ASSIGNEE] || "Chưa gán";
    const taskStatus = task[COL.T_STATUS] || "Chưa bắt đầu";
    const taskPriority = task[COL.T_PRIORITY] || "Trung bình";
    const taskStartDate = formatDateForDisplay(task[COL.T_START]);
    const taskDueDate = formatDateForDisplay(task[COL.T_DUE]);
    const taskCompletion = parseInt(task[COL.T_COMPLETION] || 0);
    const taskScore = task[COL.T_SCORE] || "";
    const taskImages = task[COL.T_IMAGES] || [];
    const taskProjectId = task[COL.T_PID]; // Lấy Project ID

    const statusClass = getStatusClass(taskStatus);
    const priorityClass = getPriorityClass(taskPriority);
    const isOverdue =
      isTaskOverdue(task[COL.T_DUE]) &&
      !taskStatus.toLowerCase().includes("hoàn thành");
    const isCompleted = taskStatus.toLowerCase().includes("hoàn thành");

    return `
    <tr class="hover:bg-gray-50 ${isOverdue ? "bg-red-overdue" : ""} task-clickable cursor-pointer draggable-item" 
        data-id="${taskId}" 
        data-project-id="${taskProjectId}" 
        draggable="true">
      <td class="px-4 py-4">
        <div class="flex items-start">
            <input type="checkbox" 
                   class="quick-complete-checkbox" 
                   data-id="${taskId}" 
                   data-name="${taskName}"
                   ${isCompleted ? "checked disabled" : ""} 
                   title="${isCompleted ? "Đã hoàn thành" : "Click để hoàn thành"}">
            <div>
                <div class="font-medium text-gray-900 text-sm leading-tight">${taskName}</div>
                <div class="text-xs text-gray-500 mt-1">${taskId}</div>
            </div>
        </div>
      </td>
      <td class="px-4 py-4 text-sm text-gray-900">${taskAssignee}</td>
      <td class="px-4 py-4">
        <span class="status-badge ${statusClass}">${taskStatus}</span>
        ${isOverdue ? '<span class="status-badge status-overdue ml-1">Quá hạn</span>' : ""}
      </td>
      <td class="px-4 py-4">
        <span class="status-badge ${priorityClass}">${taskPriority}</span>
      </td>
      <td class="px-4 py-4">
        <div class="flex items-center space-x-2">
          <div class="w-16 h-2 bg-gray-200 rounded-full">
            <div class="h-full ${getProgressColor(taskCompletion)} rounded-full transition-all duration-300" style="width: ${taskCompletion}%"></div>
          </div>
          <span class="text-sm ${getProgressTextColor(taskCompletion)} font-medium">${taskCompletion}%</span>
        </div>
      </td>
      <td class="px-4 py-4">
        <div class="text-sm">
          ${
            task[COL.T_RESULT_LINKS]
              ? task[COL.T_RESULT_LINKS]
                  .split("\n")
                  .filter((link) => link.trim() !== "")
                  .map(
                    (link, index) =>
                      `<a href="${link.trim()}" target="_blank" class="text-blue-600 hover:underline text-xs block">Link ${index + 1}</a>`,
                  )
                  .join("")
              : '<span class="text-gray-400 text-xs">Chưa có</span>'
          }
        </div>
      </td>
      <td class="px-4 py-4 text-center">
        ${taskScore ? `<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">${taskScore}/100</span>` : '<span class="text-gray-400 text-xs">Chưa chấm</span>'}
      </td>
      <td class="px-4 py-4">
        <div class="text-sm">
          ${
            taskImages.length > 0
              ? `<div class="flex flex-wrap gap-1">${taskImages
                  .slice(0, 2)
                  .map(
                    (img, index) =>
                      `<a href="${img.data}" target="_blank" class="text-blue-600 hover:text-blue-800 text-xs" title="${img.description || `Hình ${index + 1}`}"><i class="fas fa-image mr-1"></i>Hình ${index + 1}</a>`,
                  )
                  .join(
                    "",
                  )}${taskImages.length > 2 ? `<span class="text-gray-500 text-xs">+${taskImages.length - 2} ảnh</span>` : ""}</div>`
              : '<span class="text-gray-400 text-xs">Chưa có</span>'
          }
        </div>
      </td>
      <td class="px-4 py-4 text-sm text-gray-900">${taskStartDate}</td>
      <td class="px-4 py-4 text-sm text-gray-900">${taskDueDate}</td>
      <td class="px-4 py-4 text-right">
        <div class="flex space-x-1 justify-end">
          ${(() => {
            const project = allProjects.find(
              (p) => p[COL.P_ID] === task[COL.T_PID],
            );
            const isProjectManager =
              project && project[COL.P_MANAGER] === currentUser.name;
            const canCopyDelete = isAdmin() || isProjectManager;

            // Kiểm tra xem có nên hiển thị nút nộp kết quả hay không
            const taskIsOverdue = isTaskOverdue(task[COL.T_DUE]);
            const canSubmitResult = taskIsOverdue
              ? canUserSubmitResultForOverdueTask(taskId)
              : isAdmin() ||
                isProjectManager ||
                task[COL.T_ASSIGNEE] === currentUser.name;

            return `
              ${canSubmitResult ? `<button class="action-btn action-btn-view submit-result-btn" data-type="task" data-id="${taskId}" data-name="${taskName}" title="Nộp kết quả"><i class="fas fa-upload"></i></button>` : ""}
              ${canCopyDelete ? `<button class="action-btn action-btn-copy copy-btn" data-type="task" data-id="${taskId}" data-name="${taskName}" title="Tạo bản sao"><i class="fas fa-copy"></i></button>` : ""}
              ${canSubmitResult ? `<button class="action-btn action-btn-edit edit-btn" data-type="task" data-id="${taskId}" title="Chỉnh sửa"><i class="fas fa-edit"></i></button>` : ""}
              ${canCopyDelete ? `<button class="action-btn action-btn-delete delete-btn" data-type="task" data-id="${taskId}" data-name="${taskName}" title="Xóa"><i class="fas fa-trash"></i></button>` : ""}
            `;
          })()}
        </div>
      </td>
    </tr>
  `;
  }

  function renderStaff() {
    const container = document.getElementById("staff-grid");
    if (!container) return;

    if (!allStaff || allStaff.length === 0) {
      container.innerHTML =
        '<div class="loading-card">Chưa có nhân viên nào</div>';
      return;
    }

    container.innerHTML = allStaff
      .map((staff) => createStaffCard(staff))
      .join("");
  }

  function createStaffCard(staff) {
    const staffId = staff[COL.S_ID] || "N/A";
    const staffName = staff[COL.S_NAME] || "Chưa có tên";
    const staffEmail = staff[COL.S_EMAIL] || "";
    const staffPosition = staff[COL.S_POS] || "Chưa có chức vụ";
    const staffRole = staff[COL.S_ROLE] || "Nhân viên";

    const initials = staffName
      .split(" ")
      .map((n) => n[0])
      .join("")
      .toUpperCase()
      .slice(0, 2);
    let roleClass = "user-role-user";

    if (staffRole.toLowerCase().includes("admin")) {
      roleClass = "user-role-admin";
    } else if (staffRole.toLowerCase().includes("quản lý")) {
      roleClass = "user-role-manager";
    }

    return `
      <div class="staff-card" data-id="${staffId}">
          <div class="staff-avatar">
              ${initials}
          </div>
          <h4 class="font-semibold text-gray-900 mb-1">${staffName}</h4>
          <p class="text-sm text-gray-600 mb-1">${staffPosition}</p>
          <p class="text-xs text-gray-500 mb-2">${staffEmail}</p>
          <div class="flex justify-center mb-4">
              <span class="user-role-badge ${roleClass}">${staffRole}</span>
          </div>
          <div class="flex justify-center space-x-2">
              <button class="action-btn action-btn-edit edit-btn" data-type="staff" data-id="${staffId}" title="Chỉnh sửa">
                  <i class="fas fa-edit"></i>
              </button>
              <button class="action-btn action-btn-delete delete-btn" data-type="staff" data-id="${staffId}" data-name="${staffName}" title="Xóa">
                  <i class="fas fa-trash"></i>
              </button>
          </div>
      </div>
  `;
  }

  function renderChart(chartData) {
    const ctx = document.getElementById("status-chart");
    const message = document.getElementById("chart-message");

    if (!ctx) return;

    // Destroy existing chart
    if (chartInstance) {
      chartInstance.destroy();
    }

    if (!chartData || !chartData.labels || chartData.labels.length === 0) {
      message.textContent = chartData?.message || "Không có dữ liệu biểu đồ";
      message.classList.remove("hidden");
      return;
    }

    message.classList.add("hidden");

    const colors = [
      "rgba(59, 130, 246, 0.8)",
      "rgba(16, 185, 129, 0.8)",
      "rgba(245, 158, 11, 0.8)",
      "rgba(239, 68, 68, 0.8)",
      "rgba(139, 92, 246, 0.8)",
    ];

    chartInstance = new Chart(ctx, {
      type: "doughnut",
      data: {
        labels: chartData.labels,
        datasets: [
          {
            data: chartData.data,
            backgroundColor: colors.slice(0, chartData.labels.length),
            borderColor: colors
              .slice(0, chartData.labels.length)
              .map((c) => c.replace("0.8", "1")),
            borderWidth: 2,
            hoverOffset: 8,
          },
        ],
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        cutout: "65%",
        plugins: {
          legend: {
            position: "bottom",
            labels: {
              padding: 15, // GIẢM từ 20 xuống 15
              usePointStyle: true,
              font: {
                size: 10, // GIẢM từ 12 xuống 10
              },
            },
          },
        },
        animation: {
          duration: 1000,
          easing: "easeOutCubic",
        },
      },
    });
  }

  function renderProjectProgressChart() {
    const ctx = document.getElementById("project-progress-chart");
    const message = document.getElementById("project-chart-message");

    if (!ctx) return;

    // Destroy existing chart
    if (projectProgressChart) {
      projectProgressChart.destroy();
    }

    if (!allProjects || allProjects.length === 0) {
      message.textContent = "Không có dữ liệu dự án";
      message.classList.remove("hidden");
      return;
    }

    message.classList.add("hidden");

    // Initialize progress ranges
    const progressRanges = {
      "0-25%": { count: 0, projects: [] },
      "26-50%": { count: 0, projects: [] },
      "51-75%": { count: 0, projects: [] },
      "76-99%": { count: 0, projects: [] },
      "100%": { count: 0, projects: [] },
    };

    // Group projects by progress ranges
    allProjects.forEach((project) => {
      const projectTasks = allTasks.filter(
        (task) => task[COL.T_PID] === project[COL.P_ID],
      );
      const completedTasks = projectTasks.filter((task) =>
        (task[COL.T_STATUS] || "").toLowerCase().includes("hoàn thành"),
      ).length;
      const totalTasks = projectTasks.length;
      const progress =
        totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;

      const projectName = project[COL.P_NAME] || "Chưa có tên";

      // Determine which range the project belongs to
      if (progress === 100) {
        progressRanges["100%"].count++;
        progressRanges["100%"].projects.push(projectName);
      } else if (progress >= 76) {
        progressRanges["76-99%"].count++;
        progressRanges["76-99%"].projects.push(projectName);
      } else if (progress >= 51) {
        progressRanges["51-75%"].count++;
        progressRanges["51-75%"].projects.push(projectName);
      } else if (progress >= 26) {
        progressRanges["26-50%"].count++;
        progressRanges["26-50%"].projects.push(projectName);
      } else {
        progressRanges["0-25%"].count++;
        progressRanges["0-25%"].projects.push(projectName);
      }
    });

    // Prepare chart data
    const labels = Object.keys(progressRanges);
    const data = Object.values(progressRanges).map((range) => range.count);
    const colors = [
      "rgba(239, 68, 68, 0.8)", // Red for 0-25%
      "rgba(245, 158, 11, 0.8)", // Orange for 26-50%
      "rgba(59, 130, 246, 0.8)", // Blue for 51-75%
      "rgba(16, 185, 129, 0.8)", // Green for 76-99%
      "rgba(34, 197, 94, 0.8)", // Dark green for 100%
    ];

    projectProgressChart = new Chart(ctx, {
      type: "bar",
      data: {
        labels: labels,
        datasets: [
          {
            label: "Số lượng dự án",
            data: data,
            backgroundColor: colors,
            borderColor: colors.map((c) => c.replace("0.8", "1")),
            borderWidth: 2,
            borderRadius: 8,
          },
        ],
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            display: false,
          },
          tooltip: {
            callbacks: {
              title: function (context) {
                return `Khoảng tiến độ: ${context[0].label}`;
              },
              label: function (context) {
                return `Số lượng: ${context.parsed.y} dự án`;
              },
              afterLabel: function (context) {
                const rangeKey = context.label;
                const projects = progressRanges[rangeKey].projects;
                if (projects.length > 0) {
                  const maxDisplay = 5; // Hiển thị tối đa 5 dự án trong tooltip
                  let result = "\nDự án:";
                  projects.slice(0, maxDisplay).forEach((project) => {
                    result += `\n• ${project}`;
                  });
                  if (projects.length > maxDisplay) {
                    result += `\n... và ${projects.length - maxDisplay} dự án khác`;
                  }
                  return result;
                }
                return "";
              },
            },
            titleFont: {
              size: 14,
              weight: "bold",
            },
            bodyFont: {
              size: 12,
            },
            footerFont: {
              size: 11,
            },
            padding: 12,
            cornerRadius: 8,
            displayColors: true,
          },
        },
        scales: {
          y: {
            beginAtZero: true,
            ticks: {
              stepSize: 1,
              callback: function (value) {
                return Math.floor(value); // Chỉ hiển thị số nguyên
              },
            },
            title: {
              display: true,
              text: "Số lượng dự án",
            },
          },
          x: {
            title: {
              display: true,
              text: "Khoảng tiến độ",
            },
          },
        },
        animation: {
          duration: 1000,
          easing: "easeOutCubic",
        },
      },
    });
  }

  // === New Staff Performance Chart ===
  function renderStaffPerformanceChart() {
    const ctx = document.getElementById("staff-performance-chart");
    const message = document.getElementById("staff-chart-message");

    if (!ctx) return;

    // Destroy existing chart
    if (staffPerformanceChart) {
      staffPerformanceChart.destroy();
    }

    if (
      !allStaff ||
      allStaff.length === 0 ||
      !allTasks ||
      allTasks.length === 0
    ) {
      message.textContent = "Không có dữ liệu nhân viên hoặc nhiệm vụ";
      message.classList.remove("hidden");
      return;
    }

    message.classList.add("hidden");

    // Calculate staff performance
    const staffPerformance = allStaff
      .map((staff) => {
        const staffName = staff[COL.S_NAME] || "Không tên";
        const assignedTasks = allTasks.filter(
          (task) => task[COL.T_ASSIGNEE] === staffName,
        );
        const completedTasks = assignedTasks.filter((task) =>
          (task[COL.T_STATUS] || "").toLowerCase().includes("hoàn thành"),
        );
        const completionRate =
          assignedTasks.length > 0
            ? Math.round((completedTasks.length / assignedTasks.length) * 100)
            : 0;

        return {
          name: staffName,
          totalTasks: assignedTasks.length,
          completedTasks: completedTasks.length,
          completionRate: completionRate,
        };
      })
      .filter((staff) => staff.totalTasks > 0); // Only show staff with assigned tasks

    if (staffPerformance.length === 0) {
      message.textContent = "Chưa có nhiệm vụ nào được giao";
      message.classList.remove("hidden");
      return;
    }

    staffPerformanceChart = new Chart(ctx, {
      type: "bar",
      data: {
        labels: staffPerformance.map((s) => s.name),
        datasets: [
          {
            label: "Tổng số nhiệm vụ",
            data: staffPerformance.map((s) => s.totalTasks),
            backgroundColor: "rgba(16, 185, 129, 0.6)",
            borderColor: "rgba(16, 185, 129, 1)",
            borderWidth: 2,
            borderRadius: 6,
            yAxisID: "y",
          },
          {
            label: "Tỷ lệ hoàn thành (%)",
            data: staffPerformance.map((s) => s.completionRate),
            type: "line",
            backgroundColor: "rgba(99, 102, 241, 0.2)",
            borderColor: "rgba(99, 102, 241, 1)",
            borderWidth: 3,
            pointBackgroundColor: "rgba(99, 102, 241, 1)",
            pointBorderColor: "#fff",
            pointBorderWidth: 2,
            pointRadius: 5,
            pointHoverRadius: 7,
            yAxisID: "y1",
            tension: 0.4,
          },
        ],
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: {
          mode: "index",
          intersect: false,
        },
        plugins: {
          legend: {
            position: "top",
            labels: {
              usePointStyle: true,
              font: {
                size: 11,
              },
            },
          },
          tooltip: {
            callbacks: {
              label: function (context) {
                const staffData = staffPerformance[context.dataIndex];
                if (context.dataset.label === "Tổng số nhiệm vụ") {
                  return `${context.dataset.label}: ${context.parsed.y}`;
                } else {
                  return `${context.dataset.label}: ${context.parsed.y}%`;
                }
              },
              afterLabel: function (context) {
                if (context.datasetIndex === 0) {
                  // Only show for total tasks
                  const staffData = staffPerformance[context.dataIndex];
                  return `Hoàn thành: ${staffData.completedTasks}/${staffData.totalTasks}`;
                }
                return "";
              },
            },
          },
        },
        scales: {
          x: {
            ticks: {
              maxRotation: 45,
              minRotation: 0,
              font: {
                size: 10,
              },
            },
          },
          y: {
            type: "linear",
            display: true,
            position: "left",
            title: {
              display: true,
              text: "Số lượng nhiệm vụ",
            },
            beginAtZero: true,
          },
          y1: {
            type: "linear",
            display: true,
            position: "right",
            title: {
              display: true,
              text: "Tỷ lệ (%)",
            },
            beginAtZero: true,
            max: 100,
            grid: {
              drawOnChartArea: false,
            },
            ticks: {
              callback: function (value) {
                return value + "%";
              },
            },
          },
        },
        animation: {
          duration: 1000,
          easing: "easeOutCubic",
        },
      },
    });
  }

  function renderActivity(activities) {
    const container = document.getElementById("recent-activity");
    if (!container) return;

    if (!activities || activities.length === 0) {
      container.innerHTML =
        '<div class="loading-card">Không có hoạt động nào</div>';
      return;
    }

    const displayActivities = activities.slice(0, 22);

    container.innerHTML = displayActivities
      .map(
        (activity) => `
        <div class="activity-item">
            <div class="flex items-start space-x-3">
                <div class="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center flex-shrink-0">
                    <i class="fas fa-history text-blue-600 text-xs"></i>
                </div>
                <div class="flex-1 min-w-0">
                    <p class="text-sm font-medium text-gray-900">${activity[COL.A_ACTION] || "Hành động"}</p>
                    <p class="text-xs text-gray-600 mt-1">${activity[COL.A_DETAILS] || ""}</p>
                    <p class="text-xs text-gray-500 mt-1">
                        ${activity[COL.A_USER] || "Ai đó"} • ${formatDateForDisplay(activity[COL.A_TIME], true)}
                    </p>
                </div>
            </div>
        </div>
    `,
      )
      .join("");
  }

  function openTaskModalForProject(projectId, projectName) {
    openModal("task");
    // Pre-select project after modal opens
    setTimeout(() => {
      const projectSelect = document.querySelector('select[name="projectId"]');
      if (projectSelect) {
        projectSelect.value = projectId;
        projectSelect.dispatchEvent(new Event("change"));
      }
    }, 100);
  }

  // === Enhanced Modal Management ===
  function openModal(type, data = null) {
    const isEdit = data !== null;
    const modalId = `${type}-modal`;

    // Remove existing modal
    const existingModal = document.getElementById(modalId);
    if (existingModal) {
      existingModal.remove();
    }

    let modalHTML = "";

    if (type === "project") {
      modalHTML = createProjectModal(isEdit, data);
    } else if (type === "task") {
      modalHTML = createTaskModal(isEdit, data);
    } else if (type === "staff") {
      modalHTML = createStaffModal(isEdit, data);
    }
    // ✅ THÊM VÀO ĐÂY:
    else if (type === "notification") {
      modalHTML = createNotificationModal(isEdit, data);
    }

    document.getElementById("modals-container").innerHTML = modalHTML;

    const modal = document.getElementById(modalId);
    modal.classList.add("active");

    // Setup form submission
    const form = modal.querySelector("form");
    if (form) {
      form.addEventListener("submit", function (e) {
        e.preventDefault();
        if (isEdit) {
          handleEdit(type, data);
        } else {
          handleAdd(type);
        }
      });
    }

    // Setup close handlers - Fixed
    const closeButtons = modal.querySelectorAll(".close-modal");
    closeButtons.forEach((btn) => {
      btn.addEventListener("click", (e) => {
        e.preventDefault();
        closeModal(modalId);
      });
    });
  }

  function openEditModal(type, id) {
    let data = null;

    if (type === "project") {
      data = allProjects.find((p) => p[COL.P_ID] === id);
    } else if (type === "task") {
      data = allTasks.find((t) => t[COL.T_ID] === id);
    } else if (type === "staff") {
      data = allStaff.find((s) => s[COL.S_ID] === id);
    }

    if (data) {
      openModal(type, data);
    } else {
      showToast(`Không tìm thấy ${type} với ID: ${id}`, "error");
    }
  }

  function closeModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
      modal.classList.remove("active");
      setTimeout(() => {
        if (modal.parentNode) {
          modal.remove();
        }

        // If task modal closed from project details, reopen project details immediately
        if (modalId === "task-modal" && openedFromProjectDetails) {
          const { projectId, projectName } = openedFromProjectDetails;
          openedFromProjectDetails = null;
          showProjectDetailsModal(projectId, projectName);
        }
      }, 300);
    }
  }

  function createProjectModal(isEdit, data) {
    const title = isEdit ? "Chỉnh sửa dự án" : "Tạo dự án mới";
    const submitText = isEdit ? "Cập nhật" : "Tạo dự án";

    // Lọc danh sách người có thể được chọn làm quản lý dự án
    let eligibleManagers = [];

    // THAY ĐỔI: Đảm bảo người quản lý hiện tại của dự án luôn được hiển thị trong danh sách
    if (isEdit && data && data[COL.P_MANAGER]) {
      // Kiểm tra xem người quản lý hiện tại có trong danh sách nhân viên không
      const currentManager = allStaff.find(
        (staff) => staff[COL.S_NAME] === data[COL.P_MANAGER],
      );

      // Nếu không tìm thấy, thêm một đối tượng giả vào danh sách nhân viên tạm thời
      if (!currentManager) {
        const tempStaff = [...allStaff];
        tempStaff.push({
          [COL.S_NAME]: data[COL.P_MANAGER],
          [COL.S_EMAIL]: "",
        });

        if (isAdmin()) {
          eligibleManagers = tempStaff;
        } else if (isManager()) {
          // Quản lý chỉ có thể chọn chính họ và người quản lý hiện tại
          eligibleManagers = tempStaff.filter(
            (staff) =>
              staff[COL.S_NAME] === currentUser.name ||
              staff[COL.S_NAME] === data[COL.P_MANAGER],
          );
        } else {
          // Người dùng thường chỉ có thể chọn chính họ hoặc người quản lý hiện tại nếu họ là người quản lý
          if (data[COL.P_MANAGER] === currentUser.name) {
            eligibleManagers = tempStaff.filter(
              (staff) =>
                staff[COL.S_NAME] === currentUser.name ||
                staff[COL.S_NAME] === data[COL.P_MANAGER],
            );
          }
        }
      } else {
        // Xử lý bình thường nếu người quản lý đã có trong danh sách
        if (isAdmin()) {
          eligibleManagers = allStaff;
        } else if (isManager()) {
          // Quản lý chỉ có thể chọn chính họ và người quản lý hiện tại
          eligibleManagers = allStaff.filter(
            (staff) =>
              staff[COL.S_NAME] === currentUser.name ||
              staff[COL.S_NAME] === data[COL.P_MANAGER],
          );
        } else {
          // Người dùng thường chỉ có thể chọn chính họ nếu họ là người quản lý dự án
          if (data[COL.P_MANAGER] === currentUser.name) {
            eligibleManagers = allStaff.filter(
              (staff) => staff[COL.S_NAME] === currentUser.name,
            );
          }
        }
      }
    } else {
      // Nếu là tạo mới hoặc không có người quản lý
      if (isAdmin()) {
        eligibleManagers = allStaff;
      } else if (isManager()) {
        eligibleManagers = allStaff.filter(
          (staff) => staff[COL.S_NAME] === currentUser.name,
        );
      }
    }

    setTimeout(() => {
      const startDateInput = document.querySelector(
        '#project-modal input[name="startDate"]',
      );
      const endDateInput = document.querySelector(
        '#project-modal input[name="endDate"]',
      );

      if (startDateInput && endDateInput) {
        startDateInput.addEventListener("change", function () {
          if (endDateInput.value && this.value > endDateInput.value) {
            endDateInput.value = this.value;
          }
          endDateInput.setAttribute("min", this.value);
        });

        endDateInput.addEventListener("change", function () {
          if (startDateInput.value && this.value < startDateInput.value) {
            startDateInput.value = this.value;
          }
          startDateInput.setAttribute("max", this.value);
        });
      }
    }, 100);

    return `
      <div id="project-modal" class="modal">
          <div class="modal-content">
              <div class="flex items-center justify-between mb-6">
                  <h3 class="text-xl font-bold text-gray-900">${title}</h3>
                  <button type="button" class="close-modal text-gray-400 hover:text-gray-600">
                      <i class="fas fa-times"></i>
                  </button>
              </div>
              
              <form id="project-form">
                  ${isEdit ? `<input type="hidden" name="id" value="${data[COL.P_ID]}">` : ""}
                  
                  <div class="form-group">
                      <label class="form-label required">Tên dự án</label>
                      <input type="text" name="name" class="form-input" required value="${isEdit ? data[COL.P_NAME] || "" : ""}" ${isEdit && !isAdmin() && !isManager() ? "disabled" : ""}>

                  </div>
                  
                  <div class="form-group">
                      <label class="form-label">Mô tả</label>
                      <textarea name="description" class="form-textarea" ${isEdit && !isAdmin() && !isManager() ? "disabled" : ""}>${isEdit ? data[COL.P_DESC] || "" : ""}</textarea>
                  </div>
                  
                  <div class="form-group">
                      <label class="form-label">Quản lý dự án</label>
                      <select name="manager" class="form-select" ${isEdit && !isAdmin() && !isManager() ? "disabled" : ""} ${isManager() && !isAdmin() ? "disabled" : ""}>
                          <option value="">-- Chọn quản lý --</option>
                          ${eligibleManagers
                            .map((staff) => {
                              let selected = "";
                              if (isEdit) {
                                selected =
                                  data[COL.P_MANAGER] === staff[COL.S_NAME]
                                    ? "selected"
                                    : "";
                              } else if (isManager() && !isAdmin()) {
                                // Auto-select manager khi tạo mới
                                selected =
                                  staff[COL.S_NAME] === currentUser.name
                                    ? "selected"
                                    : "";
                              }
                              const staffEmail = staff[COL.S_EMAIL]
                                ? ` (${staff[COL.S_EMAIL]})`
                                : "";
                              return `<option value="${staff[COL.S_NAME]}" ${selected}>${staff[COL.S_NAME]}${staffEmail}</option>`;
                            })
                            .join("")}
                      </select>
                  </div>
                  
                  <div class="grid grid-cols-3 gap-4">
                      <div class="form-group">
                          <label class="form-label required">Ngày bắt đầu</label>
                          <input type="date" name="startDate" class="form-input" required value="${isEdit ? formatDateForInput(data[COL.P_START]) : ""}" ${isEdit && !isAdmin() && !isManager() ? "disabled" : ""}>
                      </div>
                      <div class="form-group">
                          <label class="form-label required">Ngày kết thúc</label>
                          <input type="date" name="endDate" class="form-input" required value="${isEdit ? formatDateForInput(data[COL.P_END]) : ""}" ${isEdit && !isAdmin() && !isManager() ? "disabled" : ""}>
                      </div>
                      <div class="form-group">
                          <label class="form-label">Trạng thái</label>
                          <select name="status" class="form-select">
                              <option value="Chưa bắt đầu" ${isEdit && data[COL.P_STATUS] === "Chưa bắt đầu" ? "selected" : ""}>Chưa bắt đầu</option>
                              <option value="Đang thực hiện" ${isEdit && data[COL.P_STATUS] === "Đang thực hiện" ? "selected" : ""}>Đang thực hiện</option>
                              <option value="Hoàn thành" ${isEdit && data[COL.P_STATUS] === "Hoàn thành" ? "selected" : ""}>Hoàn thành</option>
                              <option value="Tạm dừng" ${isEdit && data[COL.P_STATUS] === "Tạm dừng" ? "selected" : ""}>Tạm dừng</option>
                              <option value="Hủy bỏ" ${isEdit && data[COL.P_STATUS] === "Hủy bỏ" ? "selected" : ""}>Hủy bỏ</option>
                          </select>
                      </div>
                  </div>              
                  
                  <div class="flex justify-end space-x-3 mt-6">
                      <button type="button" class="btn-secondary close-modal">Hủy</button>
                      <button type="submit" class="btn-primary">${submitText}</button>
                  </div>
              </form>
          </div>
      </div>
  `;
  }

  function createTaskModal(isEdit, data) {
    const title = isEdit ? "Chỉnh sửa nhiệm vụ" : "Tạo nhiệm vụ mới";
    const submitText = isEdit ? "Cập nhật" : "Tạo nhiệm vụ";

    // Lọc danh sách nhân viên có thể giao việc
    let assignableStaff = [];

    if (isAdmin()) {
      // Admin có thể giao việc cho tất cả
      assignableStaff = allStaff;
    } else if (isManager()) {
      // Quản lý có thể giao việc cho tất cả trừ Admin
      assignableStaff = allStaff.filter((staff) => {
        const role = (staff[COL.S_ROLE] || "").toLowerCase();
        return !role.includes("admin");
      });
    } else {
      // Kiểm tra xem nhân viên có phụ trách dự án nào không
      const isProjectManager = allProjects.some(
        (project) => project[COL.P_MANAGER] === currentUser.name,
      );

      if (isProjectManager) {
        // Nhân viên phụ trách dự án có thể giao việc cho tất cả trừ Admin
        assignableStaff = allStaff.filter((staff) => {
          const role = (staff[COL.S_ROLE] || "").toLowerCase();
          return !role.includes("admin");
        });
      } else {
        // Người dùng thường chỉ có thể giao việc cho chính mình
        assignableStaff = allStaff.filter(
          (staff) => staff[COL.S_NAME] === currentUser.name,
        );
      }
    }

    // Kiểm tra xem có phải task được giao cho user hiện tại không
    const isAssignedTask =
      isEdit && data && data[COL.T_ASSIGNEE] === currentUser.name && !isAdmin();
    const taskProjectId = isEdit && data ? data[COL.T_PID] : "";
    const isProjectManagerForThisTask =
      taskProjectId &&
      allProjects.find(
        (p) =>
          p[COL.P_ID] === taskProjectId &&
          p[COL.P_MANAGER] === currentUser.name,
      );

    // Determine if fields should be disabled
    const shouldDisableTopFields =
      isAssignedTask && !isProjectManagerForThisTask;

    setTimeout(() => {
      const statusSelect = document.querySelector(
        '#task-modal select[name="status"]',
      );
      const completionInput = document.querySelector(
        '#task-modal input[name="completion"]',
      );

      if (statusSelect && completionInput) {
        statusSelect.addEventListener("change", function () {
          if (this.value === "Hoàn thành") {
            completionInput.value = 100;
          }
        });
      }
    }, 100);

    setTimeout(() => {
      const projectSelect = document.querySelector(
        '#task-modal select[name="projectId"]',
      );
      const assigneeSelect = document.querySelector(
        '#task-modal select[name="assignee"]',
      );
      const startDateInput = document.querySelector(
        '#task-modal input[name="startDate"]',
      );
      const dueDateInput = document.querySelector(
        '#task-modal input[name="dueDate"]',
      );

      function updateTaskDateLimits() {
        const projectId = projectSelect.value;
        const project = allProjects.find((p) => p[COL.P_ID] === projectId);

        if (project) {
          const projectStart = formatDateForInput(project[COL.P_START]);
          const projectEnd = formatDateForInput(project[COL.P_END]);

          if (projectStart) {
            startDateInput.setAttribute("min", projectStart);
            dueDateInput.setAttribute("min", projectStart);
            if (!startDateInput.value) {
              startDateInput.value = projectStart;
            }
          }
          if (projectEnd) {
            startDateInput.setAttribute("max", projectEnd);
            dueDateInput.setAttribute("max", projectEnd);
            if (!dueDateInput.value) {
              dueDateInput.value = projectEnd;
            }
          }
        }

        // Set min date cho due date dựa trên start date hiện tại
        if (startDateInput.value) {
          dueDateInput.setAttribute("min", startDateInput.value);
        }

        // Set min date cho report date dựa trên start date hiện tại
        if (startDateInput.value) {
          dueDateInput.setAttribute("min", startDateInput.value);
          const reportDateInput = document.querySelector(
            '#task-modal input[name="reportDate"]',
          );
          if (reportDateInput) {
            reportDateInput.setAttribute("min", startDateInput.value);
          }
        }
      }

      function updateAssigneePermission() {
        const selectedProjectId = projectSelect.value;
        const selectedProject = allProjects.find(
          (p) => p[COL.P_ID] === selectedProjectId,
        );

        if (isAdmin()) {
          assigneeSelect.disabled = false;
        } else if (
          selectedProject &&
          selectedProject[COL.P_MANAGER] === currentUser.name
        ) {
          // Chỉ Admin và người phụ trách dự án mới được chọn tự do
          assigneeSelect.disabled = false;
        } else {
          assigneeSelect.disabled = true;
          assigneeSelect.value = currentUser.name;
        }
      }

      if (projectSelect && startDateInput && dueDateInput) {
        projectSelect.addEventListener("change", updateTaskDateLimits);
        projectSelect.addEventListener("change", updateAssigneePermission);
        updateTaskDateLimits(); // Initial call
        updateAssigneePermission(); // Initial call

        startDateInput.addEventListener("change", function () {
          if (dueDateInput.value && this.value > dueDateInput.value) {
            dueDateInput.value = this.value;
          }
          dueDateInput.setAttribute("min", this.value);
          // Thêm logic cho report date
          const reportDateInput = document.querySelector(
            '#task-modal input[name="reportDate"]',
          );
          if (reportDateInput) {
            reportDateInput.setAttribute("min", this.value);
          }
        });

        dueDateInput.addEventListener("change", function () {
          if (startDateInput.value && this.value < startDateInput.value) {
            startDateInput.value = this.value;
          }
          startDateInput.setAttribute("max", this.value);
        });
      }
    }, 100);

    return `
      <div id="task-modal" class="modal">
          <div class="modal-content">
              <div class="flex items-center justify-between mb-6">
                  <h3 class="text-xl font-bold text-gray-900">${title}</h3>
                  <button type="button" class="close-modal text-gray-400 hover:text-gray-600">
                      <i class="fas fa-times"></i>
                  </button>
              </div>
              
              <form id="task-form">
                  ${isEdit ? `<input type="hidden" name="id" value="${data[COL.T_ID]}">` : ""}
                  
                  <div class="form-group">
                    <label class="form-label required">Tên nhiệm vụ</label>
                    <input type="text" name="name" class="form-input" required value="${isEdit ? data[COL.T_NAME] || "" : ""}" ${shouldDisableTopFields ? "disabled" : ""}>
                  </div>

                  <div class="form-group">
                    <label class="form-label required">Thuộc dự án</label>
                    <select name="projectId" class="form-select" required ${shouldDisableTopFields ? "disabled" : ""}>
                      <option value="">-- Chọn dự án --</option>
                      ${(isAdmin() || isManager()
                        ? allProjects
                        : getUserAllowedProjects()
                      )
                        .map((project) => {
                          const selected =
                            isEdit && data[COL.T_PID] === project[COL.P_ID]
                              ? "selected"
                              : "";
                          return `<option value="${project[COL.P_ID]}" ${selected}>${project[COL.P_NAME]} (${project[COL.P_ID]})</option>`;
                        })
                        .join("")}
                    </select>
                  </div>

                  <div class="form-group">
                    <label class="form-label">Mô tả</label>
                    <textarea name="description" class="form-textarea" ${shouldDisableTopFields ? "disabled" : ""}>${isEdit ? data[COL.T_DESC] || "" : ""}</textarea>
                  </div>
                  
                  <div class="grid grid-cols-2 gap-4">
                      <div class="form-group">
                        <label class="form-label">Người thực hiện</label>
                        <select name="assignee" class="form-select" ${shouldDisableTopFields ? "disabled" : ""}>
                          <option value="">-- Chọn người thực hiện --</option>
                          ${assignableStaff
                            .map((staff) => {
                              let selected = "";
                              if (isEdit) {
                                selected =
                                  data[COL.T_ASSIGNEE] === staff[COL.S_NAME]
                                    ? "selected"
                                    : "";
                              } else if (!isAdmin()) {
                                // Nếu không phải admin thì auto-select user hiện tại
                                selected =
                                  staff[COL.S_NAME] === currentUser.name
                                    ? "selected"
                                    : "";
                              }
                              const staffEmail = staff[COL.S_EMAIL]
                                ? ` (${staff[COL.S_EMAIL]})`
                                : "";
                              return `<option value="${staff[COL.S_NAME]}" ${selected}>${staff[COL.S_NAME]}${staffEmail}</option>`;
                            })
                            .join("")}
                        </select>
                      </div>
                      <div class="form-group">
                          <label class="form-label">Ưu tiên</label>
                          <select name="priority" class="form-select" ${shouldDisableTopFields ? "disabled" : ""}>
                              <option value="Thấp" ${isEdit && data[COL.T_PRIORITY] === "Thấp" ? "selected" : ""}>Thấp</option>
                              <option value="Trung bình" ${isEdit && data[COL.T_PRIORITY] === "Trung bình" ? "selected" : "selected"}>Trung bình</option>
                              <option value="Cao" ${isEdit && data[COL.T_PRIORITY] === "Cao" ? "selected" : ""}>Cao</option>
                          </select>
                      </div>
                  </div>
                  
                  <div class="grid grid-cols-2 gap-4">
                      <div class="form-group">
                          <label class="form-label required">Ngày bắt đầu</label>
                          <input type="date" name="startDate" class="form-input" required value="${isEdit ? formatDateForInput(data[COL.T_START]) : ""}" ${shouldDisableTopFields ? "disabled" : ""}>
                      </div>
                      <div class="form-group">
                          <label class="form-label required">Hạn chót</label>
                          <input type="date" name="dueDate" class="form-input" required value="${isEdit ? formatDateForInput(data[COL.T_DUE]) : ""}" ${shouldDisableTopFields ? "disabled" : ""}>
                      </div>
                  </div>
                  
                  <div class="grid grid-cols-3 gap-4">
                      <div class="form-group">
                          <label class="form-label">Trạng thái</label>
                          <select name="status" class="form-select">
                              <option value="Chưa bắt đầu" ${isEdit && data[COL.T_STATUS] === "Chưa bắt đầu" ? "selected" : "selected"}>Chưa bắt đầu</option>
                              <option value="Đang thực hiện" ${isEdit && data[COL.T_STATUS] === "Đang thực hiện" ? "selected" : ""}>Đang thực hiện</option>
                              <option value="Hoàn thành" ${isEdit && data[COL.T_STATUS] === "Hoàn thành" ? "selected" : ""}>Hoàn thành</option>
                              <option value="Tạm dừng" ${isEdit && data[COL.T_STATUS] === "Tạm dừng" ? "selected" : ""}>Tạm dừng</option>
                          </select>
                      </div>
                      <div class="form-group">
                          <label class="form-label">Tiến độ (%)</label>
                          <input type="number" name="completion" class="form-input" min="0" max="100" value="${isEdit ? parseInt(data[COL.T_COMPLETION] || 0) : 0}">
                      </div>
                      <div class="form-group">
                        <label class="form-label">Ngày hoàn thành</label>
                        <input type="date" name="reportDate" class="form-input" value="${isEdit ? formatDateForInput(data[COL.T_REPORT_DATE]) : ""}">
                      </div>
                  </div>

                  <div class="form-group">
                    <label class="form-label">Mục tiêu</label>
                    <textarea name="target" class="form-textarea">${isEdit ? data[COL.T_TARGET] || "" : ""}</textarea>
                  </div>

                  <div class="form-group">
                    <label class="form-label">Link kết quả</label>
                    <textarea name="resultLinks" class="form-textarea" placeholder="Nhập mỗi link trên một dòng">${isEdit ? data[COL.T_RESULT_LINKS] || "" : ""}</textarea>
                  </div>

                  <div class="form-group">
                    <label class="form-label">Kết quả đầu ra</label>
                    <textarea name="output" class="form-textarea">${isEdit ? data[COL.T_OUTPUT] || "" : ""}</textarea>
                  </div>
                  
                  <div class="form-group">
                      <label class="form-label">Ghi chú</label>
                      <textarea name="notes" class="form-textarea">${isEdit ? data[COL.T_NOTES] || "" : ""}</textarea>
                  </div>
                  
                  <div class="flex justify-end space-x-3 mt-6">
                      <button type="button" class="btn-secondary close-modal">Hủy</button>
                      <button type="submit" class="btn-primary">${submitText}</button>
                  </div>
              </form>
          </div>
      </div>
  `;
  }

  function createStaffModal(isEdit, data) {
    const title = isEdit ? "Chỉnh sửa nhân viên" : "Thêm nhân viên mới";
    const submitText = isEdit ? "Cập nhật" : "Thêm nhân viên";

    // Thêm validation khi nhập liệu
    setTimeout(() => {
      const nameInput = document.querySelector(
        '#staff-modal input[name="name"]',
      );
      const emailInput = document.querySelector(
        '#staff-modal input[name="email"]',
      );

      function validateInputs() {
        const name = nameInput.value.trim();
        const email = emailInput.value.trim();
        const currentId = isEdit ? data[COL.S_ID] : null;

        if (name) {
          const errors = validateStaffData(name, email, isEdit, currentId);
          showStaffValidationError(errors);

          const submitBtn = document.querySelector(
            '#staff-modal button[type="submit"]',
          );
          submitBtn.disabled = errors.length > 0;
          submitBtn.style.opacity = errors.length > 0 ? "0.5" : "1";
        }
      }

      nameInput.addEventListener("blur", validateInputs);
      emailInput.addEventListener("blur", validateInputs);
    }, 100);

    return `
      <div id="staff-modal" class="modal">
          <div class="modal-content">
              <div class="flex items-center justify-between mb-6">
                  <h3 class="text-xl font-bold text-gray-900">${title}</h3>
                  <button type="button" class="close-modal text-gray-400 hover:text-gray-600">
                      <i class="fas fa-times"></i>
                  </button>
              </div>
              
              <form id="staff-form">
              <div id="staff-validation-error" class="hidden mb-4"></div>
                  ${isEdit ? `<input type="hidden" name="id" value="${data[COL.S_ID]}">` : ""}
                  
                  <div class="form-group">
                      <label class="form-label">Họ tên *</label>
                      <input type="text" name="name" class="form-input" required value="${isEdit ? data[COL.S_NAME] || "" : ""}">
                  </div>
                  
                  <div class="form-group">
                      <label class="form-label">Email</label>
                      <input type="email" name="email" class="form-input" value="${isEdit ? data[COL.S_EMAIL] || "" : ""}">
                  </div>
                  
                  <div class="form-group">
                      <label class="form-label">Chức vụ</label>
                      <input type="text" name="position" class="form-input" value="${isEdit ? data[COL.S_POS] || "" : ""}">
                  </div>
                  
                  <div class="form-group">
                      <label class="form-label">Phân quyền</label>
                      <select name="role" class="form-select">
                          <option value="Nhân viên" ${isEdit && data[COL.S_ROLE] === "Nhân viên" ? "selected" : "selected"}>Nhân viên</option>
                          <option value="Quản lý" ${isEdit && data[COL.S_ROLE] === "Quản lý" ? "selected" : ""}>Quản lý</option>
                          <option value="Admin" ${isEdit && data[COL.S_ROLE] === "Admin" ? "selected" : ""}>Admin</option>
                      </select>
                  </div>
                  
                  <div class="form-group">
                      <label class="form-label">Mật khẩu *</label>
                      <input type="text" name="password" class="form-input" required 
                             value="${isEdit ? data[COL.S_PASSWORD] || "" : ""}"
                             placeholder="Nhập mật khẩu">
                  </div>
                  
                  <div class="flex justify-end space-x-3 mt-6">
                      <button type="button" class="btn-secondary close-modal">Hủy</button>
                      <button type="submit" class="btn-accent">${submitText}</button>
                  </div>
              </form>
          </div>
      </div>
  `;
  }

  // === Enhanced Form Handlers with Button Loading ===
  function handleAdd(type) {
    if (!isAuthenticated) {
      showToast("Vui lòng đăng nhập", "error");
      return;
    }

    const form = document.getElementById(`${type}-form`);
    const submitBtn = form.querySelector('button[type="submit"]');
    const formData = new FormData(form);

    let data = {};
    for (let [key, value] of formData.entries()) {
      data[key] = value;
    }

    if (type === "task") {
      const disabledFields = form.querySelectorAll(
        "input[disabled], textarea[disabled], select[disabled]",
      );
      disabledFields.forEach((field) => {
        if (field.name && field.value) {
          data[field.name] = field.value;
        }
      });
    }

    const tempId = `TEMP_${Date.now()}`;

    // Optimistic update
    addOptimisticUpdate(type, data, tempId);
    closeModal(`${type}-modal`);
    showToast(
      `${type.charAt(0).toUpperCase() + type.slice(1)} đang được tạo...`,
      "info",
    );

    // Set button loading state
    setButtonLoading(submitBtn, true);

    let apiMethod = "";
    if (type === "project") apiMethod = "addProjectWithAuth";
    else if (type === "task") apiMethod = "addTaskWithAuth";
    else if (type === "staff") apiMethod = "addStaffWithAuth";
    else if (type === "notification") apiMethod = "addNotificationWithAuth";

    google.script.run
      .withSuccessHandler(function (response) {
        setButtonLoading(submitBtn, false);
        if (response.success) {
          // Update temp ID with real ID
          if (type === "project") {
            const index = allProjects.findIndex((p) => p[COL.P_ID] === tempId);
            if (index !== -1) allProjects[index][COL.P_ID] = response.projectId;
          } else if (type === "task") {
            const index = allTasks.findIndex((t) => t[COL.T_ID] === tempId);
            if (index !== -1) allTasks[index][COL.T_ID] = response.taskId;
          } else if (type === "staff") {
            const index = allStaff.findIndex((s) => s[COL.S_ID] === tempId);
            if (index !== -1) allStaff[index][COL.S_ID] = response.staffId;
          }
          showToast(
            `${type.charAt(0).toUpperCase() + type.slice(1)} đã được tạo thành công!`,
            "success",
          );

          // Refresh data after 1 second
          setTimeout(() => refreshData(), 1000);
        } else {
          showToast(response.error || "Có lỗi xảy ra", "error");
        }
      })
      .withFailureHandler(function (error) {
        setButtonLoading(submitBtn, false);
        showToast("Lỗi: " + error.message, "error");
      })
      [apiMethod](data);
  }

  function handleEdit(type, originalData) {
    if (!isAuthenticated) {
      showToast("Vui lòng đăng nhập", "error");
      return;
    }

    const form = document.getElementById(`${type}-form`);
    const submitBtn = form.querySelector('button[type="submit"]');
    const formData = new FormData(form);

    let data = {};
    for (let [key, value] of formData.entries()) {
      if (key !== "id") data[key] = value;
    }

    if (type === "task") {
      const disabledFields = form.querySelectorAll(
        "input[disabled], textarea[disabled], select[disabled]",
      );
      disabledFields.forEach((field) => {
        if (field.name && field.name !== "id" && field.value) {
          data[field.name] = field.value;
        }
      });
    }

    const id = formData.get("id");

    // Optimistic update
    updateOptimisticUpdate(type, id, data);
    closeModal(`${type}-modal`);
    showToast(
      `${type.charAt(0).toUpperCase() + type.slice(1)} đang được cập nhật...`,
      "info",
    );

    // Set button loading state
    setButtonLoading(submitBtn, true);

    let apiMethod = "";
    if (type === "project") apiMethod = "updateProjectWithAuth";
    else if (type === "task") apiMethod = "updateTaskWithAuth";
    else if (type === "staff") apiMethod = "updateStaffWithAuth";

    google.script.run
      .withSuccessHandler(function (response) {
        setButtonLoading(submitBtn, false);
        if (response.success) {
          showToast(
            `${type.charAt(0).toUpperCase() + type.slice(1)} đã được cập nhật thành công!`,
            "success",
          );

          // ← SỬA: Chỉ render lại phần cần thiết thay vì refresh toàn bộ
          if (type === "project") {
            google.script.run
              .withSuccessHandler((projects) => {
                allProjects = projects;
                renderProjects();
                renderProjectStats();
                renderStats();
                renderProjectProgressChart();
                renderProjectComparisonChart();
              })
              .getProjects();
          } else if (type === "task") {
            google.script.run
              .withSuccessHandler((tasks) => {
                allTasks = tasks;
                renderTasks();
                renderTaskStats();
                renderStats();
                renderPriorityTasksMini();
                renderStaffPerformanceReport();
                renderProjects();
                renderProjectStats();
              })
              .getTasks();
          } else if (type === "staff") {
            google.script.run
              .withSuccessHandler((staff) => {
                allStaff = staff;
                renderStaff();
                renderStaffPerformanceReport();
              })
              .getStaffList();
          }
        } else {
          // Rollback optimistic update
          updateOptimisticUpdate(type, id, originalData);
          showToast(response.error || "Có lỗi xảy ra", "error");
        }
      })
      .withFailureHandler(function (error) {
        setButtonLoading(submitBtn, false);
        updateOptimisticUpdate(type, id, originalData);
        showToast("Lỗi: " + error.message, "error");
      })
      [apiMethod](id, data);
  }

  function confirmDelete(type, id, name) {
    if (!isAuthenticated) {
      showToast("Vui lòng đăng nhập", "error");
      return;
    }

    if (confirm(`Bạn có chắc chắn muốn xóa ${type} "${name}"?`)) {
      // Find the delete button and set loading
      const deleteBtn = document.querySelector(
        `[data-type="${type}"][data-id="${id}"].delete-btn`,
      );
      if (deleteBtn) setButtonLoading(deleteBtn, true);

      showToast(
        `${type.charAt(0).toUpperCase() + type.slice(1)} đang được xóa...`,
        "info",
      );

      let apiMethod = "";
      if (type === "project") apiMethod = "deleteProjectWithAuth";
      else if (type === "task") apiMethod = "deleteTaskWithAuth";
      else if (type === "staff") apiMethod = "deleteStaffWithAuth";

      google.script.run
        .withSuccessHandler(function (response) {
          if (deleteBtn) setButtonLoading(deleteBtn, false);
          if (response.success) {
            showToast(
              `${type.charAt(0).toUpperCase() + type.slice(1)} đã được xóa thành công!`,
              "success",
            );
            // Immediate refresh after successful delete
            refreshData();
          } else {
            showToast(response.error || "Có lỗi xảy ra", "error");
          }
        })
        .withFailureHandler(function (error) {
          if (deleteBtn) setButtonLoading(deleteBtn, false);
          showToast("Lỗi: " + error.message, "error");
        })
        [apiMethod](id);
    }
  }

  function refreshData() {
    if (!isAuthenticated) return;

    // showLoading('Đang cập nhật dữ liệu...');

    google.script.run
      .withSuccessHandler(function (response) {
        // hideLoading();
        if (response.success) {
          handleSuccessfulLogin(response);
        } else {
          showToast(response.error || "Lỗi khi tải dữ liệu", "error");
        }
      })
      .withFailureHandler(function (error) {
        // hideLoading();
        showToast("Lỗi khi tải dữ liệu: " + error.message, "error");
      })
      .getDataForUser();
  }

  // === Button Loading State Management ===
  function setButtonLoading(button, isLoading) {
    if (!button) return;

    if (isLoading) {
      button.classList.add("loading");
      button.disabled = true;
      // Store original content
      if (!button.dataset.originalContent) {
        button.dataset.originalContent = button.innerHTML;
      }
      button.innerHTML = "";
    } else {
      button.classList.remove("loading");
      button.disabled = false;
      // Restore original content
      if (button.dataset.originalContent) {
        button.innerHTML = button.dataset.originalContent;
      }
    }
  }

  function filterCards(selector, searchTerm) {
    const cards = document.querySelectorAll(selector);
    cards.forEach((card) => {
      const text = card.textContent.toLowerCase();
      const id = card.dataset.id.toLowerCase();
      const isVisible = text.includes(searchTerm) || id.includes(searchTerm);
      card.style.display = isVisible ? "block" : "none";
    });
  }

  function getStatusClass(status) {
    const statusLower = status.toLowerCase();
    if (statusLower.includes("hoàn thành")) return "status-completed";
    if (statusLower.includes("đang")) return "status-active";
    if (statusLower.includes("quá hạn")) return "status-overdue";
    if (statusLower.includes("tạm dừng")) return "status-paused";
    if (statusLower.includes("hủy bỏ")) return "status-canceled";
    return "status-pending";
  }

  function getStatusIconClass(status) {
    const statusLower = (status || "").toLowerCase();
    if (statusLower.includes("hoàn thành")) return "text-green-500";
    if (statusLower.includes("đang")) return "text-blue-500";
    if (statusLower.includes("tạm dừng")) return "text-yellow-500";
    if (statusLower.includes("hủy bỏ")) return "text-red-500";
    return "text-gray-500";
  }

  function getPriorityClass(priority) {
    const priorityLower = priority.toLowerCase();
    if (priorityLower.includes("cao")) return "priority-high";
    if (priorityLower.includes("thấp")) return "priority-low";
    return "priority-medium";
  }

  function isTaskOverdue(dueDate) {
    if (!dueDate) return false;
    try {
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      const due = new Date(dueDate);
      due.setHours(0, 0, 0, 0);
      return due < today;
    } catch (e) {
      return false;
    }
  }

  function canUserSubmitResultForOverdueTask(taskId) {
    // Admin có thể nộp kết quả cho tất cả task, kể cả quá hạn
    if (isAdmin()) return true;

    const task = allTasks.find((t) => t[COL.T_ID] === taskId);
    if (!task) return false;

    // Người quản lý dự án có thể nộp kết quả cho task quá hạn
    const project = allProjects.find((p) => p[COL.P_ID] === task[COL.T_PID]);
    if (project && project[COL.P_MANAGER] === currentUser.name) return true;

    // Người được giao nhiệm vụ KHÔNG thể nộp kết quả cho task quá hạn
    return false;
  }

  function formatDateForDisplay(dateInput, includeTime = false) {
    if (!dateInput) return "N/A";
    try {
      const date = new Date(dateInput);
      if (isNaN(date.getTime())) return dateInput;

      const day = String(date.getDate()).padStart(2, "0");
      const month = String(date.getMonth() + 1).padStart(2, "0");
      const year = date.getFullYear();

      let formatted = `${day}/${month}/${year}`;

      if (includeTime) {
        const hours = String(date.getHours()).padStart(2, "0");
        const minutes = String(date.getMinutes()).padStart(2, "0");
        formatted += ` ${hours}:${minutes}`;
      }

      return formatted;
    } catch (e) {
      return dateInput;
    }
  }

  function formatDateForInput(dateInput) {
    if (!dateInput) return "";
    try {
      const date = new Date(dateInput);
      if (isNaN(date.getTime())) return "";

      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, "0");
      const day = String(date.getDate()).padStart(2, "0");

      return `${year}-${month}-${day}`;
    } catch (e) {
      return "";
    }
  }

  function formatDate(date) {
    if (!date || date === "") return "";
    try {
      if (!(date instanceof Date)) {
        date = new Date(date);
      }

      const day = String(date.getDate()).padStart(2, "0");
      const month = String(date.getMonth() + 1).padStart(2, "0");
      const year = date.getFullYear();

      return `${day}/${month}/${year}`;
    } catch (e) {
      return "";
    }
  }

  function showLoading(message = "Đang xử lý...") {
    const overlay = document.getElementById("loading-overlay");
    if (overlay) {
      overlay.classList.remove("hidden");
    }
  }

  function hideLoading() {
    const overlay = document.getElementById("loading-overlay");
    if (overlay) {
      overlay.classList.add("hidden");
    }
  }

  function showToast(message, type = "info") {
    const container = document.getElementById("toast-container");
    if (!container) return;

    const toast = document.createElement("div");
    toast.className = `toast ${type}`;

    const icons = {
      success: "fa-check-circle text-green-500",
      error: "fa-exclamation-circle text-red-500",
      info: "fa-info-circle text-blue-500",
    };

    toast.innerHTML = `
        <div class="flex items-center space-x-3">
            <i class="fas ${icons[type] || icons.info}"></i>
            <span class="flex-1">${message}</span>
            <button onclick="this.parentElement.parentElement.remove()" class="text-gray-400 hover:text-gray-600">
                <i class="fas fa-times"></i>
            </button>
        </div>
    `;

    container.appendChild(toast);

    // Show animation
    setTimeout(() => toast.classList.add("show"), 100);

    // Auto remove after 5 seconds
    setTimeout(() => {
      toast.classList.remove("show");
      setTimeout(() => toast.remove(), 300);
    }, 5000);
  }

  function getUserAllowedProjects() {
    if (isAdmin()) {
      return allProjects;
    }

    if (isManager()) {
      // Quản lý chỉ thấy dự án họ quản lý hoặc có nhiệm vụ
      const managerProjects = allProjects.filter(
        (project) => project[COL.P_MANAGER] === currentUser.name,
      );

      // Thêm các dự án mà quản lý có nhiệm vụ
      const managerTasks = allTasks.filter(
        (task) => task[COL.T_ASSIGNEE] === currentUser.name,
      );
      const taskProjectIds = [
        ...new Set(managerTasks.map((task) => task[COL.T_PID])),
      ];

      const projectIds = new Set([
        ...managerProjects.map((p) => p[COL.P_ID]),
        ...taskProjectIds,
      ]);

      return allProjects.filter((project) => projectIds.has(project[COL.P_ID]));
    }

    // Người dùng thường - dự án họ có nhiệm vụ hoặc quản lý
    const userTasks = allTasks.filter(
      (task) => task[COL.T_ASSIGNEE] === currentUser.name,
    );
    const userTaskProjectIds = [
      ...new Set(userTasks.map((task) => task[COL.T_PID])),
    ];

    // Thêm các dự án mà người dùng là người quản lý
    const managedProjects = allProjects.filter(
      (project) => project[COL.P_MANAGER] === currentUser.name,
    );
    const managedProjectIds = managedProjects.map((p) => p[COL.P_ID]);

    const projectIds = new Set([...userTaskProjectIds, ...managedProjectIds]);

    return allProjects.filter((project) => projectIds.has(project[COL.P_ID]));
  }

  function canUserCreateTask() {
    if (isAdmin() || isManager()) {
      return true;
    }

    // User thường có thể tạo task nếu họ là người được phụ trách dự án hoặc đã có task
    if (currentUser) {
      // Kiểm tra xem user có phải là người phụ trách dự án nào không
      const userManagedProjects = allProjects.filter(
        (project) => project[COL.P_MANAGER] === currentUser.name,
      );

      if (userManagedProjects.length > 0) {
        return true;
      }

      // Hoặc kiểm tra nếu user đã có nhiệm vụ trong hệ thống
      if (allTasks) {
        const userTasks = allTasks.filter(
          (task) => task[COL.T_ASSIGNEE] === currentUser.name,
        );
        return userTasks.length > 0;
      }
    }

    return false;
  }

  function createNotificationModal(isEdit, data) {
    return `
    <div id="notification-modal" class="modal">
      <div class="modal-content">
        <div class="flex items-center justify-between mb-6">
          <h3 class="text-xl font-bold text-gray-900">Tạo thông báo mới</h3>
          <button type="button" class="close-modal text-gray-400 hover:text-gray-600">
            <i class="fas fa-times"></i>
          </button>
        </div>
        
        <form id="notification-form">
          <div class="form-group">
            <label class="form-label">Nội dung thông báo *</label>
            <textarea name="content" class="form-textarea" required placeholder="Nhập nội dung thông báo..."></textarea>
          </div>
          
          <div class="form-group">
            <label class="form-label">Người nhận</label>
            <select name="recipient" class="form-select">
              <option value="">Tất cả mọi người</option>
              ${allStaff
                .map(
                  (staff) =>
                    `<option value="${staff[COL.S_NAME]}">${staff[COL.S_NAME]} (${staff[COL.S_EMAIL] || "No email"})</option>`,
                )
                .join("")}
            </select>
          </div>
          
          <div class="form-group">
            <label class="form-label">Loại thông báo</label>
            <select name="type" class="form-select">
              <option value="Thông báo">Thông báo chung</option>
              <option value="Khẩn cấp">Khẩn cấp</option>
              <option value="Công việc">Công việc</option>
              <option value="Hệ thống">Hệ thống</option>
            </select>
          </div>
          
          <div class="flex justify-end space-x-3 mt-6">
            <button type="button" class="btn-secondary close-modal">Hủy</button>
            <button type="submit" class="btn-primary">Gửi thông báo</button>
          </div>
        </form>
      </div>
    </div>
  `;
  }

  // === Gantt Chart Functions ===
  function renderGanttChart() {
    if (currentSection !== "gantt") return;

    const ganttContainer = document.getElementById("gantt-container");
    const ganttHeader = document.getElementById("gantt-header");
    const ganttItems = document.getElementById("gantt-items");
    const currentPeriod = document.getElementById("current-period");

    if (!ganttContainer || !ganttHeader || !ganttItems || !currentPeriod)
      return;

    // Cập nhật tiêu đề kỳ hiển thị
    const monthName = currentGanttDate.toLocaleString("vi-VN", {
      month: "long",
    });
    const year = currentGanttDate.getFullYear();
    currentPeriod.textContent = `${monthName} ${year}`;

    // Tạo header với ngày trong tháng
    const daysInMonth = new Date(
      currentGanttDate.getFullYear(),
      currentGanttDate.getMonth() + 1,
      0,
    ).getDate();
    const firstDay = new Date(
      currentGanttDate.getFullYear(),
      currentGanttDate.getMonth(),
      1,
    );
    const daysHeader = document.querySelector(".gantt-days");

    // Sửa lại CSS cho phần header ngày để hiển thị ngang
    daysHeader.style.display = "flex";
    daysHeader.style.flexDirection = "row";

    let daysHTML = "";
    for (let day = 1; day <= daysInMonth; day++) {
      const date = new Date(
        currentGanttDate.getFullYear(),
        currentGanttDate.getMonth(),
        day,
      );
      const isWeekend = date.getDay() === 0 || date.getDay() === 6;
      const isToday = isSameDate(date, new Date());
      const dayName = date.toLocaleString("vi-VN", { weekday: "short" });

      daysHTML += `
      <div class="gantt-day ${isWeekend ? "weekend" : ""} ${isToday ? "today" : ""}">
        <div class="gantt-day-number">${day}</div>
        <div class="gantt-day-label">${dayName}</div>
      </div>
    `;
    }
    daysHeader.innerHTML = daysHTML;

    // Hiển thị dự án và nhiệm vụ
    let itemsHTML = "";

    // Tự động expand dự án đầu tiên nếu chưa có dự án nào được expand
    if (expandedProjects.size === 0 && allProjects.length > 0) {
      expandedProjects.add(allProjects[0][COL.P_ID]);
    }

    // Hiển thị cả dự án và nhiệm vụ theo nhóm
    allProjects.forEach((project) => {
      const projectStartDate = new Date(project[COL.P_START]);
      const projectEndDate = new Date(project[COL.P_END]);

      // Kiểm tra xem dự án có hiển thị trong tháng hiện tại không
      if (
        isDateInMonth(projectStartDate, currentGanttDate) ||
        isDateInMonth(projectEndDate, currentGanttDate) ||
        (projectStartDate < firstDay &&
          projectEndDate >
            new Date(
              currentGanttDate.getFullYear(),
              currentGanttDate.getMonth() + 1,
              0,
            ))
      ) {
        // === RENDER PROJECT ===
        const projectGanttBarStyle = calculateGanttBarStyle(
          projectStartDate,
          projectEndDate,
          currentGanttDate,
          daysInMonth,
        );
        const projectTasks = allTasks.filter(
          (task) => task[COL.T_PID] === project[COL.P_ID],
        );
        const completedProjectTasks = projectTasks.filter((task) =>
          (task[COL.T_STATUS] || "").toLowerCase().includes("hoàn thành"),
        ).length;
        const projectProgressPercent =
          projectTasks.length > 0
            ? Math.round((completedProjectTasks / projectTasks.length) * 100)
            : 0;
        const projectIsOverdue =
          new Date() > projectEndDate && projectProgressPercent < 100;
        const projectFormattedStartDate = formatDateForGantt(
          project[COL.P_START],
        );
        const projectFormattedEndDate = formatDateForGantt(project[COL.P_END]);
        const projectDescription = project[COL.P_DESC] || "Không có mô tả";
        const projectId = project[COL.P_ID];

        itemsHTML += `
        <div class="gantt-project-group" data-project-id="${projectId}">
          <div class="gantt-item" data-id="${projectId}" data-type="project">
            <div class="gantt-item-label">
              <button class="gantt-toggle-btn mr-2" data-project="${projectId}">
                <i class="fas fa-chevron-right"></i>
              </button>
              <i class="fas fa-folder ${getStatusIconClass(project[COL.P_STATUS])} mr-2"></i>
              <span class="truncate">${project[COL.P_NAME]}</span>
              <span class="gantt-task-count">${projectTasks.length}</span>
              
              <div class="gantt-item-actions">
                <button class="action-btn action-btn-edit add-task-from-project-btn mr-1" data-project-id="${projectId}" data-project-name="${project[COL.P_NAME]}" title="Thêm nhiệm vụ">
                  <i class="fas fa-plus"></i>
                </button>
                <button class="action-btn action-btn-view view-project-btn mr-1" data-type="project" data-id="${projectId}" data-name="${project[COL.P_NAME]}" title="Xem chi tiết">
                  <i class="fas fa-eye"></i>
                </button>
                ${
                  isAdmin() ||
                  (project[COL.P_MANAGER] === currentUser.name && isManager())
                    ? `
                  <button class="action-btn action-btn-copy copy-btn mr-1" data-type="project" data-id="${projectId}" data-name="${project[COL.P_NAME]}" title="Tạo bản sao">
                    <i class="fas fa-copy"></i>
                  </button>
                `
                    : ""
                }
                ${
                  isAdmin() || project[COL.P_MANAGER] === currentUser.name
                    ? `
                  <button class="action-btn action-btn-edit edit-btn mr-1" data-type="project" data-id="${projectId}" title="Chỉnh sửa">
                    <i class="fas fa-edit"></i>
                  </button>
                `
                    : ""
                }
                ${
                  isAdmin() ||
                  (project[COL.P_MANAGER] === currentUser.name && isManager())
                    ? `
                  <button class="action-btn action-btn-delete delete-btn" data-type="project" data-id="${projectId}" data-name="${project[COL.P_NAME]}" title="Xóa">
                    <i class="fas fa-trash"></i>
                  </button>
                `
                    : ""
                }
              </div>
            </div>
            
            <div class="gantt-item-timeline">
              <div class="gantt-bar gantt-bar-project ${projectIsOverdue ? "gantt-bar-overdue" : ""}" style="${projectGanttBarStyle}" data-tooltip="${project[COL.P_NAME]}: ${projectDescription}">
                <div class="gantt-bar-label">${projectFormattedStartDate} - ${projectFormattedEndDate}: ${projectDescription}</div>
                <div class="gantt-progress" style="width: ${projectProgressPercent}%"></div>
              </div>
            </div>
          </div>
          
          <div class="gantt-project-tasks hidden" id="gantt-tasks-${projectId}">
            ${projectTasks
              .map((task) => {
                const taskStartDate = new Date(task[COL.T_START]);
                const taskEndDate = new Date(task[COL.T_DUE]);

                const projectEndDate = new Date(project[COL.P_END]);
                const lastDayOfMonth = new Date(
                  currentGanttDate.getFullYear(),
                  currentGanttDate.getMonth() + 1,
                  0,
                );

                // Hiển thị tất cả nhiệm vụ nếu dự án kết thúc trong hoặc sau tháng hiện tại
                if (projectEndDate >= firstDay) {
                  // Tính toán các giá trị Gantt cho task
                  const taskGanttBarStyle = calculateGanttBarStyle(
                    taskStartDate,
                    taskEndDate,
                    currentGanttDate,
                    daysInMonth,
                  );
                  const taskProgressPercent = parseInt(
                    task[COL.T_COMPLETION] || 0,
                  );
                  const taskIsOverdue =
                    isTaskOverdue(task[COL.T_DUE]) &&
                    !(task[COL.T_STATUS] || "")
                      .toLowerCase()
                      .includes("hoàn thành");
                  const taskAssignee = task[COL.T_ASSIGNEE] || "Chưa gán";
                  const taskStatus = task[COL.T_STATUS] || "Chưa bắt đầu";
                  const taskPriority = task[COL.T_PRIORITY] || "Trung bình";
                  const taskFormattedStartDate = formatDateForGantt(
                    task[COL.T_START],
                  );
                  const taskFormattedEndDate = formatDateForGantt(
                    task[COL.T_DUE],
                  );
                  const taskDescription = task[COL.T_DESC] || "Không có mô tả";

                  // Xử lý các link nếu có
                  const taskLinks = task[COL.T_RESULT_LINKS]
                    ? task[COL.T_RESULT_LINKS]
                        .split("\n")
                        .filter((link) => link.trim() !== "")
                    : [];
                  const hasLinks = taskLinks.length > 0;

                  const isCompleted = taskStatus
                    .toLowerCase()
                    .includes("hoàn thành");

                  // SỬA: Thêm class task-clickable vào div gantt-item-label
                  return `
                  <div class="gantt-item gantt-task-item draggable-item" 
                      data-id="${task[COL.T_ID]}" 
                      data-type="task" 
                      data-project-id="${task[COL.T_PID]}"
                      draggable="true">
                    <div class="gantt-item-label task-clickable cursor-pointer" data-id="${task[COL.T_ID]}">
                      <input type="checkbox" 
                            class="quick-complete-checkbox ml-2" 
                            data-id="${task[COL.T_ID]}" 
                            data-name="${task[COL.T_NAME]}"
                            ${isCompleted ? "checked disabled" : ""} 
                            style="margin-right: 8px;">
                            
                      <i class="fas fa-circle ${getStatusIcon(taskStatus)} mr-2" style="font-size: 8px;"></i>
                      <div class="flex flex-col min-w-0">
                        <span class="truncate">${task[COL.T_NAME]} ${taskPriority.toLowerCase().includes("cao") ? '<i class="fas fa-star text-yellow-400 ml-1"></i>' : ""}</span>
                        <span class="text-xs text-gray-500 truncate">${taskAssignee} - ${taskStatus} - ${taskPriority}</span>
                        ${
                          hasLinks
                            ? `<div class="flex gap-2 mt-1">
                            ${taskLinks
                              .map(
                                (link, index) => `
                              <a href="${link}" target="_blank" class="text-xs text-blue-600 hover:underline flex items-center">
                                <i class="fas fa-link mr-1"></i>Link ${index + 1}
                              </a>
                            `,
                              )
                              .join("")}
                          </div>`
                            : ""
                        }
                      </div>
                      
                      <div class="gantt-item-actions">
                        ${(() => {
                          const isProjectManager =
                            project &&
                            project[COL.P_MANAGER] === currentUser.name;
                          const canCopyDelete = isAdmin() || isProjectManager;

                          // Kiểm tra xem có nên hiển thị nút nộp kết quả hay không
                          const taskIsOverdue = isTaskOverdue(task[COL.T_DUE]);
                          const canSubmitResult = taskIsOverdue
                            ? canUserSubmitResultForOverdueTask(task[COL.T_ID])
                            : isAdmin() ||
                              isProjectManager ||
                              task[COL.T_ASSIGNEE] === currentUser.name;

                          return `
                            ${canSubmitResult ? `<button class="action-btn action-btn-view submit-result-btn mr-1" data-type="task" data-id="${task[COL.T_ID]}" data-name="${task[COL.T_NAME]}" title="Nộp kết quả"><i class="fas fa-upload"></i></button>` : ""}
                            ${canCopyDelete ? `<button class="action-btn action-btn-copy copy-btn mr-1" data-type="task" data-id="${task[COL.T_ID]}" data-name="${task[COL.T_NAME]}" title="Tạo bản sao"><i class="fas fa-copy"></i></button>` : ""}
                            ${canSubmitResult ? `<button class="action-btn action-btn-edit edit-btn mr-1" data-type="task" data-id="${task[COL.T_ID]}" title="Chỉnh sửa"><i class="fas fa-edit"></i></button>` : ""}
                            ${canCopyDelete ? `<button class="action-btn action-btn-delete delete-btn" data-type="task" data-id="${task[COL.T_ID]}" data-name="${task[COL.T_NAME]}" title="Xóa"><i class="fas fa-trash"></i></button>` : ""}
                            `;
                        })()}
                      </div>
                    </div>
                    
                    <div class="gantt-item-timeline">
                        ${
                          isDateInMonth(taskStartDate, currentGanttDate) ||
                          isDateInMonth(taskEndDate, currentGanttDate) ||
                          (taskStartDate < firstDay &&
                            taskEndDate >
                              new Date(
                                currentGanttDate.getFullYear(),
                                currentGanttDate.getMonth() + 1,
                                0,
                              ))
                            ? `<div class="gantt-bar gantt-bar-task ${taskIsOverdue ? "gantt-bar-overdue" : ""}" style="${taskGanttBarStyle}" data-tooltip="${task[COL.T_NAME]}: ${taskDescription}">
                            <div class="gantt-bar-label">${taskFormattedStartDate} - ${taskFormattedEndDate}: ${taskDescription}</div>
                            <div class="gantt-progress" style="width: ${taskProgressPercent}%"></div>
                        </div>`
                            : `<div class="gantt-non-visible-task" style="height: 20px; display: flex; align-items: center; justify-content: center; color: #666; font-size: 11px; font-style: italic;">
                            ${taskFormattedStartDate} - ${taskFormattedEndDate}: Không hiển thị trong tháng này
                        </div>`
                        }
                    </div>
                  </div>
                `;
                }
                return "";
              })
              .join("")}
          </div>
        </div>
      `;
      }
    });

    // Hiển thị thông báo nếu không có dữ liệu
    if (itemsHTML === "") {
      itemsHTML = `
      <div class="text-center py-16 text-gray-500">
        <i class="fas fa-calendar-times text-4xl mb-3 opacity-30"></i>
        <p>Không có dự án hoặc nhiệm vụ nào trong ${monthName} ${year}</p>
      </div>
    `;
    }
    // Render dữ liệu
    ganttItems.innerHTML = itemsHTML;
    // Thêm sự kiện toggle cho các nút mũi tên
    document.querySelectorAll(".gantt-toggle-btn").forEach((btn) => {
      // Xóa event listeners cũ trước khi thêm mới để tránh duplicate
      btn.removeEventListener("click", toggleGanttProject);
      btn.addEventListener("click", toggleGanttProject);
    });

    // Khôi phục trạng thái xổ của các dự án
    expandedProjects.forEach((projectId) => {
      const taskContainer = document.getElementById(`gantt-tasks-${projectId}`);
      const toggleBtn = document.querySelector(
        `.gantt-toggle-btn[data-project="${projectId}"]`,
      );

      if (taskContainer && toggleBtn) {
        taskContainer.classList.remove("hidden");
        const icon = toggleBtn.querySelector("i");
        if (icon) {
          icon.classList.remove("fa-chevron-right");
          icon.classList.add("fa-chevron-down");
        }
      }
    });
  }

  // Hàm xử lý sự kiện toggle cho các nút mũi tên trong Gantt chart
  function toggleGanttProject(event) {
    const projectId = this.dataset.project;
    const taskContainer = document.getElementById(`gantt-tasks-${projectId}`);
    const icon = this.querySelector("i");

    if (taskContainer.classList.contains("hidden")) {
      taskContainer.classList.remove("hidden");
      icon.classList.remove("fa-chevron-right");
      icon.classList.add("fa-chevron-down");
      expandedProjects.add(projectId); // Thêm vào danh sách dự án đang xổ
    } else {
      taskContainer.classList.add("hidden");
      icon.classList.remove("fa-chevron-down");
      icon.classList.add("fa-chevron-right");
      expandedProjects.delete(projectId); // Xóa khỏi danh sách dự án đang xổ
    }
  }

  // Hàm tính toán style cho gantt bar
  function calculateGanttBarStyle(
    startDate,
    endDate,
    currentMonth,
    daysInMonth,
  ) {
    // Đảm bảo ngày bắt đầu và kết thúc hợp lệ
    if (!startDate || isNaN(startDate.getTime())) {
      startDate = new Date(
        currentMonth.getFullYear(),
        currentMonth.getMonth(),
        1,
      );
    }

    if (!endDate || isNaN(endDate.getTime())) {
      endDate = new Date(
        currentMonth.getFullYear(),
        currentMonth.getMonth(),
        daysInMonth,
      );
    }

    // Ngày đầu và cuối tháng
    const monthStart = new Date(
      currentMonth.getFullYear(),
      currentMonth.getMonth(),
      1,
    );
    const monthEnd = new Date(
      currentMonth.getFullYear(),
      currentMonth.getMonth(),
      daysInMonth,
    );

    // Nếu cả startDate và endDate đều nằm ngoài tháng hiện tại
    if (startDate < monthStart && endDate > monthEnd) {
      return "left: 0; width: 100%;";
    }

    // Điều chỉnh startDate và endDate trong phạm vi tháng hiện tại
    const effectiveStartDate = startDate < monthStart ? monthStart : startDate;
    const effectiveEndDate = endDate > monthEnd ? monthEnd : endDate;

    // Tính phần trăm bắt đầu và độ rộng
    const totalDays = daysInMonth;
    const startDay = effectiveStartDate.getDate();
    const endDay = effectiveEndDate.getDate();

    const leftPercent = ((startDay - 1) / totalDays) * 100;
    const widthPercent = ((endDay - startDay + 1) / totalDays) * 100;

    return `left: ${leftPercent}%; width: ${widthPercent}%;`;
  }

  // Kiểm tra xem một ngày có nằm trong tháng không
  function isDateInMonth(date, monthDate) {
    if (!date || isNaN(date.getTime())) return false;
    return (
      date.getMonth() === monthDate.getMonth() &&
      date.getFullYear() === monthDate.getFullYear()
    );
  }

  // Kiểm tra xem hai ngày có giống nhau không
  function isSameDate(date1, date2) {
    return (
      date1.getDate() === date2.getDate() &&
      date1.getMonth() === date2.getMonth() &&
      date1.getFullYear() === date2.getFullYear()
    );
  }

  // Hàm điều hướng tháng trước/sau
  function navigateGanttMonth(direction) {
    const newDate = new Date(currentGanttDate);
    newDate.setMonth(newDate.getMonth() + direction);
    currentGanttDate = newDate;
    renderGanttChart();

    // Thêm timeout ngắn để đảm bảo DOM đã được cập nhật trước khi thiết lập lại event listeners
    setTimeout(() => {
      setupGanttEventListeners();
    }, 50);
  }

  // Hàm tìm kiếm trong Gantt chart
  function searchGantt(searchTerm) {
    if (!searchTerm) {
      // Hiển thị lại tất cả
      document.querySelectorAll(".gantt-project-group").forEach((group) => {
        group.style.display = "block";
        group.querySelectorAll(".gantt-item").forEach((item) => {
          item.style.display = "flex";
        });
      });
      return;
    }

    const lowerSearchTerm = searchTerm.toLowerCase();
    const projectsToShow = new Set();

    // Lặp qua từng project group
    document.querySelectorAll(".gantt-project-group").forEach((group) => {
      const projectItem = group.querySelector(
        '.gantt-item[data-type="project"]',
      );
      const taskItems = group.querySelectorAll('.gantt-item[data-type="task"]');

      let projectMatches = false;
      let hasMatchingTasks = false;

      // Kiểm tra project có match không
      if (projectItem) {
        const projectText = projectItem
          .querySelector(".gantt-item-label")
          .textContent.toLowerCase();
        projectMatches = projectText.includes(lowerSearchTerm);
      }

      // Kiểm tra tasks có match không
      taskItems.forEach((taskItem) => {
        const taskText = taskItem
          .querySelector(".gantt-item-label")
          .textContent.toLowerCase();
        const taskMatches = taskText.includes(lowerSearchTerm);

        if (taskMatches) {
          hasMatchingTasks = true;
          taskItem.style.display = "flex";
        } else {
          taskItem.style.display = "none";
        }
      });

      // Hiển thị project group nếu:
      // 1. Project name matches, hoặc
      // 2. Có ít nhất 1 task matches
      if (projectMatches || hasMatchingTasks) {
        group.style.display = "block";
        if (projectItem) {
          projectItem.style.display = "flex";
        }

        // Nếu project matches thì hiện tất cả tasks
        if (projectMatches) {
          taskItems.forEach((taskItem) => {
            taskItem.style.display = "flex";
          });
        }
      } else {
        group.style.display = "none";
      }
    });
  }

  // Thêm vào hàm setupEventListeners
  function setupGanttEventListeners() {
    // Điều hướng tháng - gỡ bỏ event listener cũ nếu có
    const prevMonthBtn = document.getElementById("prev-month");
    const nextMonthBtn = document.getElementById("next-month");

    if (prevMonthBtn) {
      prevMonthBtn.replaceWith(prevMonthBtn.cloneNode(true));
      document
        .getElementById("prev-month")
        .addEventListener("click", () => navigateGanttMonth(-1));
    }

    if (nextMonthBtn) {
      nextMonthBtn.replaceWith(nextMonthBtn.cloneNode(true));
      document
        .getElementById("next-month")
        .addEventListener("click", () => navigateGanttMonth(1));
    }

    // Tìm kiếm
    const searchInput = document.getElementById("gantt-search");
    if (searchInput) {
      searchInput.removeEventListener("input", handleGanttSearch);
      searchInput.addEventListener("input", handleGanttSearch);
    }
  }

  // Thêm hàm mới này để xử lý sự kiện tìm kiếm
  function handleGanttSearch(e) {
    searchGantt(e.target.value);
  }

  function formatDateForGantt(dateInput) {
    if (!dateInput) return "";
    try {
      const date = new Date(dateInput);
      if (isNaN(date.getTime())) return "";

      const day = String(date.getDate()).padStart(2, "0");
      const month = String(date.getMonth() + 1).padStart(2, "0");

      return `${day}/${month}`;
    } catch (e) {
      return "";
    }
  }

  function getStatusIcon(status) {
    const statusLower = (status || "").toLowerCase();
    if (statusLower.includes("hoàn thành")) return "text-green-500";
    if (statusLower.includes("đang")) return "text-blue-500";
    if (statusLower.includes("tạm dừng")) return "text-yellow-500";
    return "text-gray-400"; // Chưa bắt đầu
  }

  // Thêm hàm mới sau các hàm utility
  function formatTaskLinks(linksText) {
    if (!linksText) return "";

    // Tách các link theo dòng mới
    const links = linksText.split("\n").filter((link) => link.trim() !== "");

    if (links.length === 0) return "";

    return links
      .map((link, index) => {
        // Tạo thẻ a với target="_blank" để mở trong tab mới
        return `<a href="${link}" target="_blank" class="text-blue-600 hover:underline">Link ${index + 1}</a>`;
      })
      .join(" | ");
  }

  /**
   * Check if user can copy resource
   */
  function canUserCopyResource(type, id) {
    // Copy permissions same as create permissions
    if (type === "project") {
      return (
        isAdmin() ||
        isManager() ||
        allProjects.some(
          (p) => p[COL.P_ID] === id && p[COL.P_MANAGER] === currentUser.name,
        )
      );
    }
    if (type === "task") {
      return canUserCreateTask();
    }
    return false;
  }

  /**
   * Open copy modal
   */
  function openCopyModal(type, id, originalName) {
    const modalId = `copy-${type}-modal`;
    const defaultName = `Bản sao ${originalName}`;

    const modalHTML = `
        <div id="${modalId}" class="modal">
            <div class="modal-content max-w-md">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-xl font-bold text-gray-900">Tạo bản sao ${type === "project" ? "dự án" : "nhiệm vụ"}</h3>
                    <button type="button" class="close-modal text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <form id="copy-${type}-form">
                    <div class="form-group">
                        <label class="form-label">Tên ${type === "project" ? "dự án" : "nhiệm vụ"} mới *</label>
                        <input type="text" name="newName" class="form-input" required value="${defaultName}">
                    </div>
                    
                    <div class="flex justify-end space-x-3 mt-6">
                        <button type="button" class="btn-secondary close-modal">Hủy</button>
                        <button type="submit" class="btn-primary">Tạo bản sao</button>
                    </div>
                </form>
            </div>
        </div>
    `;

    document.getElementById("modals-container").innerHTML = modalHTML;

    const modal = document.getElementById(modalId);
    modal.classList.add("active");

    // Setup form submission
    const form = modal.querySelector("form");
    form.addEventListener("submit", function (e) {
      e.preventDefault();
      const newName = form.newName.value.trim();
      if (newName) {
        handleCopy(type, id, newName);
      }
    });

    // Setup close handlers
    const closeButtons = modal.querySelectorAll(".close-modal");
    closeButtons.forEach((btn) => {
      btn.addEventListener("click", (e) => {
        e.preventDefault();
        closeModal(modalId);
      });
    });

    // Focus on input and select text
    setTimeout(() => {
      const input = modal.querySelector('input[name="newName"]');
      if (input) {
        input.focus();
        input.select();
      }
    }, 300);
  }

  /**
   * Handle copy operation
   */
  function handleCopy(type, id, newName) {
    if (!isAuthenticated) {
      showToast("Vui lòng đăng nhập", "error");
      return;
    }

    const form = document.getElementById(`copy-${type}-form`);
    const submitBtn = form.querySelector('button[type="submit"]');

    // Set button loading state
    setButtonLoading(submitBtn, true);

    let apiMethod = "";
    if (type === "project") apiMethod = "copyProjectWithAuth";
    else if (type === "task") apiMethod = "copyTaskWithAuth";

    google.script.run
      .withSuccessHandler(function (response) {
        setButtonLoading(submitBtn, false);
        if (response.success) {
          showToast(
            response.message || `Đã tạo bản sao ${type} thành công!`,
            "success",
          );
          closeModal(`copy-${type}-modal`);
          refreshData(); // Refresh data
        } else {
          showToast(response.error || "Có lỗi xảy ra", "error");
        }
      })
      .withFailureHandler(function (error) {
        setButtonLoading(submitBtn, false);
        showToast("Lỗi: " + error.message, "error");
      })
      [apiMethod](id, newName);
  }

  function renderTaskPriorityChart() {
    const ctx = document.getElementById("task-priority-chart");
    const message = document.getElementById("priority-chart-message");

    if (!ctx) return;

    // Destroy existing chart
    if (window.taskPriorityChart) {
      window.taskPriorityChart.destroy();
    }

    if (!allTasks || allTasks.length === 0) {
      message.textContent = "Không có dữ liệu nhiệm vụ";
      message.classList.remove("hidden");
      return;
    }

    message.classList.add("hidden");

    // Count tasks by priority
    const priorityCounts = {
      Thấp: 0,
      "Trung bình": 0,
      Cao: 0,
    };

    allTasks.forEach((task) => {
      const priority = task[COL.T_PRIORITY] || "Trung bình";
      if (priority.toLowerCase().includes("thấp")) {
        priorityCounts["Thấp"]++;
      } else if (priority.toLowerCase().includes("cao")) {
        priorityCounts["Cao"]++;
      } else {
        priorityCounts["Trung bình"]++;
      }
    });

    window.taskPriorityChart = new Chart(ctx, {
      type: "pie",
      data: {
        labels: Object.keys(priorityCounts),
        datasets: [
          {
            data: Object.values(priorityCounts),
            backgroundColor: [
              "rgba(34, 197, 94, 0.8)", // Thấp - Green
              "rgba(59, 130, 246, 0.8)", // Trung bình - Blue
              "rgba(239, 68, 68, 0.8)", // Cao - Red
            ],
            borderColor: [
              "rgba(34, 197, 94, 1)",
              "rgba(59, 130, 246, 1)",
              "rgba(239, 68, 68, 1)",
            ],
            borderWidth: 2,
            hoverOffset: 8,
          },
        ],
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        cutout: 0,
        plugins: {
          legend: {
            position: "bottom",
            labels: {
              padding: 15,
              usePointStyle: true,
              font: {
                size: 11,
              },
            },
          },
          tooltip: {
            callbacks: {
              label: function (context) {
                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                const percentage = Math.round((context.parsed / total) * 100);
                return `${context.label}: ${context.parsed} (${percentage}%)`;
              },
            },
          },
        },
        animation: {
          duration: 1000,
          easing: "easeOutCubic",
        },
      },
    });
  }

  function renderPriorityTasksMini() {
    const container = document.getElementById("priority-tasks-mini");
    if (!container) return;

    let userTasks = [];
    if (isAdmin()) {
      userTasks = allTasks;
    } else {
      const userProjects = getUserAllowedProjects();
      userTasks = allTasks.filter((task) => {
        if (task[COL.T_ASSIGNEE] === currentUser.name) return true;
        const projectId = task[COL.T_PID];
        const project = allProjects.find((p) => p[COL.P_ID] === projectId);
        if (project && project[COL.P_MANAGER] === currentUser.name) return true;
        return false;
      });
    }

    const highPriorityTasks = userTasks.filter((task) => {
      const priority = (task[COL.T_PRIORITY] || "").toLowerCase();
      const status = (task[COL.T_STATUS] || "").toLowerCase();
      return priority.includes("cao") && !status.includes("hoàn thành");
    });

    if (highPriorityTasks.length === 0) {
      container.innerHTML =
        '<div class="lg:col-span-2 text-center py-8 text-gray-500 text-sm">Không có nhiệm vụ ưu tiên cao</div>';
      return;
    }

    container.innerHTML = highPriorityTasks
      .map((task) => {
        const taskName = task[COL.T_NAME] || "Chưa có tên";
        const taskAssignee = task[COL.T_ASSIGNEE] || "Chưa gán";
        const taskDueDate = formatDateForDisplay(task[COL.T_DUE]);
        const taskCompletion = parseInt(task[COL.T_COMPLETION] || 0);
        const isOverdue = isTaskOverdue(task[COL.T_DUE]);

        const taskProjectId = task[COL.T_PID] || "N/A";
        const project = allProjects.find((p) => p[COL.P_ID] === taskProjectId);
        const projectName = project ? project[COL.P_NAME] : taskProjectId;
        const projectDisplay =
          projectName.length > 20
            ? projectName.substring(0, 20) + "..."
            : projectName;

        // SỬA: Thêm class task-clickable
        return `
      <div class="p-4 border border-orange-200 bg-gradient-to-br from-orange-50 to-red-50 rounded-lg hover:shadow-md transition-all duration-200 hover:border-orange-300 task-clickable cursor-pointer" data-id="${task[COL.T_ID]}">
        <div class="flex items-start justify-between mb-3">
          <h5 class="font-semibold text-gray-900 text-sm leading-tight flex-1 mr-2">${taskName}</h5>
          <div class="flex items-center space-x-2">
            ${isOverdue ? '<span class="status-badge status-overdue text-xs">Quá hạn</span>' : '<span class="status-badge priority-high text-xs">Cao</span>'}
            
            <div class="flex space-x-1">
              ${(() => {
                const project = allProjects.find(
                  (p) => p[COL.P_ID] === taskProjectId,
                );
                const isProjectManager =
                  project && project[COL.P_MANAGER] === currentUser.name;
                const canCopyDelete = isAdmin() || isProjectManager;

                // Kiểm tra xem có nên hiển thị nút nộp kết quả hay không
                const taskIsOverdue = isTaskOverdue(task[COL.T_DUE]);
                const canSubmitResult = taskIsOverdue
                  ? canUserSubmitResultForOverdueTask(task[COL.T_ID])
                  : isAdmin() ||
                    isProjectManager ||
                    task[COL.T_ASSIGNEE] === currentUser.name;

                return `
                  ${canSubmitResult ? `<button class="action-btn action-btn-view submit-result-btn" data-type="task" data-id="${task[COL.T_ID]}" data-name="${taskName}" title="Nộp kết quả"><i class="fas fa-upload"></i></button>` : ""}
                  ${canCopyDelete ? `<button class="action-btn action-btn-copy copy-btn" data-type="task" data-id="${task[COL.T_ID]}" data-name="${taskName}" title="Tạo bản sao"><i class="fas fa-copy"></i></button>` : ""}
                  ${canSubmitResult ? `<button class="action-btn action-btn-edit edit-btn" data-type="task" data-id="${task[COL.T_ID]}" title="Chỉnh sửa"><i class="fas fa-edit"></i></button>` : ""}
                  ${canCopyDelete ? `<button class="action-btn action-btn-delete delete-btn" data-type="task" data-id="${task[COL.T_ID]}" data-name="${taskName}" title="Xóa"><i class="fas fa-trash"></i></button>` : ""}
                `;
              })()}
            </div>
          </div>
        </div>
        
        <div class="text-xs text-gray-600 space-y-1 mb-3">
          <div class="flex items-center justify-between">
            <div class="flex items-center flex-1">
              <i class="fas fa-folder text-purple-500 mr-1 w-3"></i>
              <span class="truncate">${projectDisplay}</span>
            </div>
          </div>

          <div class="flex items-center justify-between">
            <div class="flex items-center flex-1">
              <i class="fas fa-user text-blue-500 mr-1 w-3"></i>
              <span class="truncate">${taskAssignee}</span>
            </div>
            <div class="flex items-center ml-2">
              <i class="fas fa-calendar ${isOverdue ? "text-red-500" : "text-green-500"} mr-1 w-3"></i>
              <span>${taskDueDate}</span>
            </div>
          </div>
        </div>
        
        <div class="flex items-center">
          <span class="text-xs font-semibold text-gray-700 min-w-[35px]">${taskCompletion}%</span>
          <div class="flex-1 h-2 bg-gray-200 rounded-full ml-2">
            <div class="h-full ${taskCompletion === 0 ? "bg-gray-400" : "bg-gradient-to-r from-orange-400 to-red-500"} rounded-full transition-all duration-500" style="width: ${Math.max(taskCompletion, 5)}%"></div>
          </div>
        </div>
      </div>
    `;
      })
      .join("");
  }

  function renderStaffPerformanceReport() {
    const container = document.getElementById("staff-performance-report");
    if (!container) return;

    // Calculate staff performance data
    const staffPerformanceData = allStaff
      .map((staff) => {
        const staffName = staff[COL.S_NAME];

        // Get tasks assigned to this staff member
        const staffTasks = allTasks.filter(
          (task) => task[COL.T_ASSIGNEE] === staffName,
        );

        // Calculate total tasks and completed tasks
        const totalTasks = staffTasks.length;
        const completedTasks = staffTasks.filter((task) =>
          (task[COL.T_STATUS] || "").toLowerCase().includes("hoàn thành"),
        ).length;

        // Calculate scores - handling both number and string values
        const taskScores = staffTasks
          .map((task) => {
            const score = task[COL.T_SCORE];
            if (score === undefined || score === null || score === "")
              return null;
            const numScore =
              typeof score === "string" ? parseFloat(score) : score;
            return isNaN(numScore) ? null : numScore;
          })
          .filter((score) => score !== null);

        const totalScore = taskScores.reduce((sum, score) => sum + score, 0);
        const averageScore =
          taskScores.length > 0 ? totalScore / taskScores.length : 0;
        const scoredTasks = taskScores.length;

        // Calculate completion rate
        const completionRate =
          totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;

        return {
          name: staffName,
          position: staff[COL.S_POS] || "Nhân viên",
          totalTasks,
          completedTasks,
          completionRate,
          totalScore: Math.round(totalScore * 100) / 100, // Round to 2 decimal places
          averageScore: Math.round(averageScore * 100) / 100, // Round to 2 decimal places
          scoredTasks,
        };
      })
      .filter((staff) => staff.totalTasks > 0); // Only show staff with tasks

    // Sort by average score descending
    staffPerformanceData.sort((a, b) => b.averageScore - a.averageScore);

    if (staffPerformanceData.length === 0) {
      container.innerHTML =
        '<div class="loading-card">Không có dữ liệu để hiển thị</div>';
      return;
    }

    // Generate table HTML
    const tableHTML = `
      <div class="glass-card overflow-x-auto">
        <table class="w-full border-collapse">
          <thead>
            <tr class="bg-gradient-to-r from-blue-50 to-indigo-50">
              <th class="border border-gray-200 px-4 py-3 text-left font-semibold text-gray-900">
                <div class="flex items-center">
                  <i class="fas fa-user text-blue-500 mr-2"></i>
                  Nhân viên
                </div>
              </th>
              <th class="border border-gray-200 px-4 py-3 text-left font-semibold text-gray-900">
                <div class="flex items-center">
                  <i class="fas fa-briefcase text-purple-500 mr-2"></i>
                  Chức vụ
                </div>
              </th>
              <th class="border border-gray-200 px-4 py-3 text-center font-semibold text-gray-900">
                <div class="flex items-center justify-center">
                  <i class="fas fa-tasks text-green-500 mr-2"></i>
                  Tổng NV
                </div>
              </th>
              <th class="border border-gray-200 px-4 py-3 text-center font-semibold text-gray-900">
                <div class="flex items-center justify-center">
                  <i class="fas fa-check-circle text-emerald-500 mr-2"></i>
                  Hoàn thành
                </div>
              </th>
              <th class="border border-gray-200 px-4 py-3 text-center font-semibold text-gray-900">
                <div class="flex items-center justify-center">
                  <i class="fas fa-percentage text-blue-500 mr-2"></i>
                  Tỷ lệ HT
                </div>
              </th>
              <th class="border border-gray-200 px-4 py-3 text-center font-semibold text-gray-900">
                <div class="flex items-center justify-center">
                  <i class="fas fa-star text-yellow-500 mr-2"></i>
                  Tổng điểm
                </div>
              </th>
              <th class="border border-gray-200 px-4 py-3 text-center font-semibold text-gray-900">
                <div class="flex items-center justify-center">
                  <i class="fas fa-trophy text-orange-500 mr-2"></i>
                  Điểm TB
                </div>
              </th>
              <th class="border border-gray-200 px-4 py-3 text-center font-semibold text-gray-900">
                <div class="flex items-center justify-center">
                  <i class="fas fa-chart-line text-indigo-500 mr-2"></i>
                  NV có điểm
                </div>
              </th>
            </tr>
          </thead>
          <tbody>
            ${staffPerformanceData
              .map((staff, index) => {
                const isTopPerformer = index < 3 && staff.averageScore > 0;
                const performanceClass = isTopPerformer
                  ? "bg-gradient-to-r from-yellow-50 to-orange-50"
                  : "";
                const completionColor =
                  staff.completionRate >= 80
                    ? "text-green-600 font-semibold"
                    : staff.completionRate >= 60
                      ? "text-blue-600"
                      : staff.completionRate >= 40
                        ? "text-orange-600"
                        : "text-red-600";

                const scoreColor =
                  staff.averageScore >= 80
                    ? "text-green-600 font-bold"
                    : staff.averageScore >= 70
                      ? "text-blue-600 font-semibold"
                      : staff.averageScore >= 60
                        ? "text-orange-600"
                        : staff.averageScore > 0
                          ? "text-red-600"
                          : "text-gray-500";

                const rankBadge =
                  index === 0 && staff.averageScore > 0
                    ? '<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800 ml-2"><i class="fas fa-crown mr-1"></i>Top 1</span>'
                    : index === 1 && staff.averageScore > 0
                      ? '<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-800 ml-2"><i class="fas fa-medal mr-1"></i>Top 2</span>'
                      : index === 2 && staff.averageScore > 0
                        ? '<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-orange-100 text-orange-800 ml-2"><i class="fas fa-award mr-1"></i>Top 3</span>'
                        : "";

                return `
                <tr class="hover:bg-gray-50 ${performanceClass} transition-colors duration-200">
                  <td class="border border-gray-200 px-4 py-3">
                    <div class="flex items-center">
                      <div class="w-8 h-8 rounded-full bg-gradient-to-r from-blue-500 to-purple-500 flex items-center justify-center text-white text-sm font-semibold mr-3">
                        ${staff.name.charAt(0).toUpperCase()}
                      </div>
                      <div>
                        <div class="font-medium text-gray-900">${staff.name}${rankBadge}</div>
                      </div>
                    </div>
                  </td>
                  <td class="border border-gray-200 px-4 py-3 text-sm text-gray-600">${staff.position}</td>
                  <td class="border border-gray-200 px-4 py-3 text-center">
                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                      ${staff.totalTasks}
                    </span>
                  </td>
                  <td class="border border-gray-200 px-4 py-3 text-center">
                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">
                      ${staff.completedTasks}
                    </span>
                  </td>
                  <td class="border border-gray-200 px-4 py-3 text-center">
                    <div class="flex items-center justify-center">
                      <span class="${completionColor} text-sm font-medium">${staff.completionRate}%</span>
                      <div class="w-12 h-2 bg-gray-200 rounded-full ml-2">
                        <div class="h-full bg-gradient-to-r from-green-400 to-green-600 rounded-full" style="width: ${staff.completionRate}%"></div>
                      </div>
                    </div>
                  </td>
                  <td class="border border-gray-200 px-4 py-3 text-center">
                    <span class="${scoreColor} text-sm">${staff.totalScore > 0 ? staff.totalScore : "--"}</span>
                  </td>
                  <td class="border border-gray-200 px-4 py-3 text-center">
                    <div class="flex items-center justify-center">
                      <span class="${scoreColor} text-lg font-bold">${staff.averageScore > 0 ? staff.averageScore : "--"}</span>
                      ${staff.averageScore > 0 ? '<i class="fas fa-star text-yellow-400 ml-1 text-xs"></i>' : ""}
                    </div>
                  </td>
                  <td class="border border-gray-200 px-4 py-3 text-center">
                    <span class="text-sm text-gray-600">${staff.scoredTasks} / ${staff.totalTasks}</span>
                    <div class="w-12 h-2 bg-gray-200 rounded-full mx-auto mt-1">
                      <div class="h-full bg-gradient-to-r from-yellow-400 to-orange-500 rounded-full" 
                           style="width: ${staff.totalTasks > 0 ? (staff.scoredTasks / staff.totalTasks) * 100 : 0}%"></div>
                    </div>
                  </td>
                </tr>
              `;
              })
              .join("")}
          </tbody>
        </table>
        
        <div class="mt-4 p-4 bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg border">
          <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 text-center">
            <div>
              <div class="text-lg font-bold text-blue-600">${staffPerformanceData.length}</div>
              <div class="text-xs text-gray-600">Nhân viên có NV</div>
            </div>
            <div>
              <div class="text-lg font-bold text-green-600">${staffPerformanceData.reduce((sum, s) => sum + s.totalTasks, 0)}</div>
              <div class="text-xs text-gray-600">Tổng nhiệm vụ</div>
            </div>
            <div>
              <div class="text-lg font-bold text-emerald-600">${staffPerformanceData.reduce((sum, s) => sum + s.completedTasks, 0)}</div>
              <div class="text-xs text-gray-600">Đã hoàn thành</div>
            </div>
            <div>
              <div class="text-lg font-bold text-orange-600">${Math.round((staffPerformanceData.reduce((sum, s) => sum + s.totalScore, 0) / Math.max(staffPerformanceData.filter((s) => s.scoredTasks > 0).length, 1)) * 100) / 100}</div>
              <div class="text-xs text-gray-600">Điểm TB chung</div>
            </div>
          </div>
        </div>
      </div>
    `;

    container.innerHTML = tableHTML;
  }

  function renderTimelineProgressChart() {
    const ctx = document.getElementById("timeline-progress-chart");
    const message = document.getElementById("timeline-chart-message");

    if (!ctx) return;

    // Destroy existing chart
    if (window.timelineProgressChart) {
      window.timelineProgressChart.destroy();
    }

    if (!allTasks || allTasks.length === 0) {
      message.textContent = "Không có dữ liệu nhiệm vụ";
      message.classList.remove("hidden");
      return;
    }

    message.classList.add("hidden");

    // Get tasks completed in last 30 days
    const last30Days = new Date();
    last30Days.setDate(last30Days.getDate() - 30);

    // Create timeline data for last 30 days
    const timelineData = {};
    const labels = [];

    // Initialize last 30 days with 0 values
    for (let i = 29; i >= 0; i--) {
      const date = new Date();
      date.setDate(date.getDate() - i);
      const dateStr = date.toISOString().split("T")[0];
      const displayDate = date.getDate() + "/" + (date.getMonth() + 1);
      timelineData[dateStr] = 0;
      labels.push(displayDate);
    }

    // Count completed tasks by date
    allTasks.forEach((task) => {
      const status = (task[COL.T_STATUS] || "").toLowerCase();
      const reportDate = task[COL.T_REPORT_DATE];

      if (status.includes("hoàn thành") && reportDate) {
        try {
          const completedDate = new Date(reportDate);
          const dateStr = completedDate.toISOString().split("T")[0];
          if (timelineData.hasOwnProperty(dateStr)) {
            timelineData[dateStr]++;
          }
        } catch (e) {
          // Skip invalid dates
        }
      }
    });

    const data = Object.values(timelineData);

    window.timelineProgressChart = new Chart(ctx, {
      type: "line",
      data: {
        labels: labels,
        datasets: [
          {
            label: "Nhiệm vụ hoàn thành",
            data: data,
            borderColor: "rgba(16, 185, 129, 1)",
            backgroundColor: "rgba(16, 185, 129, 0.1)",
            borderWidth: 3,
            fill: true,
            tension: 0.4,
            pointBackgroundColor: "rgba(16, 185, 129, 1)",
            pointBorderColor: "#fff",
            pointBorderWidth: 2,
            pointRadius: 4,
            pointHoverRadius: 6,
          },
        ],
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            display: false,
          },
          tooltip: {
            callbacks: {
              title: function (context) {
                return `Ngày ${context[0].label}`;
              },
              label: function (context) {
                return `${context.parsed.y} nhiệm vụ hoàn thành`;
              },
            },
          },
        },
        scales: {
          x: {
            display: true,
            title: {
              display: true,
              text: "30 ngày gần đây",
            },
            ticks: {
              maxTicksLimit: 7,
              font: {
                size: 10,
              },
            },
          },
          y: {
            beginAtZero: true,
            title: {
              display: true,
              text: "Số lượng nhiệm vụ",
            },
            ticks: {
              stepSize: 1,
              callback: function (value) {
                return Math.floor(value);
              },
            },
          },
        },
        animation: {
          duration: 1000,
          easing: "easeOutCubic",
        },
      },
    });
  }

  function renderProjectComparisonChart() {
    const ctx = document.getElementById("project-comparison-chart");
    const message = document.getElementById("comparison-chart-message");

    if (!ctx) return;

    // Destroy existing chart
    if (window.projectComparisonChart) {
      window.projectComparisonChart.destroy();
    }

    if (
      !allProjects ||
      allProjects.length === 0 ||
      !allTasks ||
      allTasks.length === 0
    ) {
      message.textContent = "Không có dữ liệu để so sánh";
      message.classList.remove("hidden");
      return;
    }

    message.classList.add("hidden");

    // Prepare project comparison data (top 5 projects with most tasks)
    const projectStats = allProjects
      .map((project) => {
        const projectId = project[COL.P_ID];
        const projectName = project[COL.P_NAME] || projectId;

        const projectTasks = allTasks.filter(
          (task) => task[COL.T_PID] === projectId,
        );
        const totalTasks = projectTasks.length;
        const completedTasks = projectTasks.filter((task) =>
          (task[COL.T_STATUS] || "").toLowerCase().includes("hoàn thành"),
        ).length;
        const completionRate =
          totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;

        return {
          name:
            projectName.length > 15
              ? projectName.substring(0, 15) + "..."
              : projectName,
          totalTasks,
          completedTasks,
          completionRate,
        };
      })
      .filter((project) => project.totalTasks > 0) // Only projects with tasks
      .sort((a, b) => b.totalTasks - a.totalTasks) // Sort by total tasks desc
      .slice(0, 5); // Top 5 projects

    if (projectStats.length === 0) {
      message.textContent = "Chưa có dự án nào có nhiệm vụ";
      message.classList.remove("hidden");
      return;
    }

    window.projectComparisonChart = new Chart(ctx, {
      type: "bar",
      data: {
        labels: projectStats.map((p) => p.name),
        datasets: [
          {
            label: "Tổng nhiệm vụ",
            data: projectStats.map((p) => p.totalTasks),
            backgroundColor: "rgba(59, 130, 246, 0.8)",
            borderColor: "rgba(59, 130, 246, 1)",
            borderWidth: 1,
            borderRadius: 6,
            yAxisID: "y",
          },
          {
            label: "Tỷ lệ hoàn thành (%)",
            data: projectStats.map((p) => p.completionRate),
            type: "line",
            borderColor: "rgba(239, 68, 68, 1)",
            backgroundColor: "rgba(239, 68, 68, 0.1)",
            borderWidth: 3,
            pointBackgroundColor: "rgba(239, 68, 68, 1)",
            pointBorderColor: "#fff",
            pointBorderWidth: 2,
            pointRadius: 5,
            pointHoverRadius: 7,
            tension: 0.4,
            yAxisID: "y1",
          },
        ],
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: {
          mode: "index",
          intersect: false,
        },
        plugins: {
          legend: {
            position: "top",
            labels: {
              usePointStyle: true,
              font: {
                size: 11,
              },
            },
          },
          tooltip: {
            callbacks: {
              label: function (context) {
                if (context.dataset.label === "Tổng nhiệm vụ") {
                  const projectData = projectStats[context.dataIndex];
                  return `${context.dataset.label}: ${context.parsed.y} (Hoàn thành: ${projectData.completedTasks})`;
                } else {
                  return `${context.dataset.label}: ${context.parsed.y}%`;
                }
              },
            },
          },
        },
        scales: {
          x: {
            ticks: {
              maxRotation: 45,
              minRotation: 0,
              font: {
                size: 10,
              },
            },
          },
          y: {
            type: "linear",
            display: true,
            position: "left",
            title: {
              display: true,
              text: "Số lượng nhiệm vụ",
            },
            beginAtZero: true,
            ticks: {
              stepSize: 1,
              callback: function (value) {
                return Math.floor(value);
              },
            },
          },
          y1: {
            type: "linear",
            display: true,
            position: "right",
            title: {
              display: true,
              text: "Tỷ lệ (%)",
            },
            beginAtZero: true,
            max: 100,
            grid: {
              drawOnChartArea: false,
            },
            ticks: {
              callback: function (value) {
                return value + "%";
              },
            },
          },
        },
        animation: {
          duration: 1000,
          easing: "easeOutCubic",
        },
      },
    });
  }

  // Optimistic UI Updates
  function addOptimisticUpdate(type, data, tempId = null) {
    if (type === "project") {
      const newProject = {
        [COL.P_ID]: tempId || `TEMP_${Date.now()}`,
        [COL.P_NAME]: data.name,
        [COL.P_DESC]: data.description || "",
        [COL.P_MANAGER]: data.manager || "",
        [COL.P_START]: data.startDate,
        [COL.P_END]: data.endDate,
        [COL.P_STATUS]: data.status || "Chưa bắt đầu",
      };
      allProjects.unshift(newProject);
      renderProjects();
    } else if (type === "task") {
      const newTask = {
        [COL.T_ID]: tempId || `TEMP_${Date.now()}`,
        [COL.T_PID]: data.projectId,
        [COL.T_NAME]: data.name,
        [COL.T_DESC]: data.description || "",
        [COL.T_ASSIGNEE]: data.assignee || "",
        [COL.T_STATUS]: data.status || "Chưa bắt đầu",
        [COL.T_PRIORITY]: data.priority || "Trung bình",
        [COL.T_START]: data.startDate,
        [COL.T_DUE]: data.dueDate,
        [COL.T_COMPLETION]: parseInt(data.completion || 0),
      };
      allTasks.unshift(newTask);
      renderTasks();
    } else if (type === "staff") {
      const newStaff = {
        [COL.S_ID]: tempId || `TEMP_${Date.now()}`,
        [COL.S_NAME]: data.name,
        [COL.S_EMAIL]: data.email || "",
        [COL.S_POS]: data.position || "",
        [COL.S_ROLE]: data.role || "Nhân viên",
      };
      allStaff.unshift(newStaff);
      renderStaff();
    }
  }

  function updateOptimisticUpdate(type, id, data) {
    if (type === "project") {
      const index = allProjects.findIndex((p) => p[COL.P_ID] === id);
      if (index !== -1) {
        allProjects[index] = {
          ...allProjects[index],
          ...{
            [COL.P_NAME]: data.name,
            [COL.P_DESC]: data.description || "",
            [COL.P_MANAGER]: data.manager || "",
            [COL.P_START]: data.startDate,
            [COL.P_END]: data.endDate,
            [COL.P_STATUS]: data.status,
          },
        };

        // Render lại các phần liên quan đến Project
        renderProjects();
        renderProjectStats();
        renderStats();

        // THÊM: Nếu đang ở Gantt thì vẽ lại Gantt ngay lập tức
        if (currentSection === "gantt") {
          renderGanttChart();
        }
      }
    } else if (type === "task") {
      const index = allTasks.findIndex((t) => t[COL.T_ID] === id);
      if (index !== -1) {
        allTasks[index] = {
          ...allTasks[index],
          ...{
            [COL.T_NAME]: data.name,
            [COL.T_PID]: data.projectId,
            [COL.T_DESC]: data.description || "",
            [COL.T_ASSIGNEE]: data.assignee || "",
            [COL.T_STATUS]: data.status,
            [COL.T_PRIORITY]: data.priority,
            [COL.T_START]: data.startDate,
            [COL.T_DUE]: data.dueDate,
            [COL.T_COMPLETION]: parseInt(data.completion || 0),
          },
        };

        // Render lại các phần liên quan đến Task
        renderTasks();
        renderProjects();
        renderProjectStats();
        renderTaskStats();
        renderStats();

        // THÊM: Nếu đang ở Gantt thì vẽ lại Gantt ngay lập tức
        if (currentSection === "gantt") {
          renderGanttChart();
        }
      }
    } else if (type === "staff") {
      const index = allStaff.findIndex((s) => s[COL.S_ID] === id);
      if (index !== -1) {
        allStaff[index] = {
          ...allStaff[index],
          ...{
            [COL.S_NAME]: data.name,
            [COL.S_EMAIL]: data.email || "",
            [COL.S_POS]: data.position || "",
            [COL.S_ROLE]: data.role,
          },
        };
        renderStaff();
      }
    }
  }

  function validateStaffData(name, email, isEdit = false, currentId = null) {
    const errors = [];

    // Kiểm tra trùng tên
    const duplicateName = allStaff.find(
      (staff) =>
        staff[COL.S_NAME].toLowerCase() === name.toLowerCase() &&
        (!isEdit || staff[COL.S_ID] !== currentId),
    );
    if (duplicateName) {
      errors.push("Tên nhân viên đã tồn tại");
    }

    // Kiểm tra trùng email (chỉ khi email không rỗng)
    if (email && email.trim() !== "") {
      const duplicateEmail = allStaff.find(
        (staff) =>
          staff[COL.S_EMAIL].toLowerCase() === email.toLowerCase() &&
          (!isEdit || staff[COL.S_ID] !== currentId),
      );
      if (duplicateEmail) {
        errors.push("Email đã được sử dụng");
      }
    }

    return errors;
  }

  function showStaffValidationError(errors) {
    const errorContainer = document.getElementById("staff-validation-error");
    if (errors.length > 0) {
      errorContainer.innerHTML = errors
        .map((error) => `<div class="text-red-600 text-sm">${error}</div>`)
        .join("");
      errorContainer.classList.remove("hidden");
    } else {
      errorContainer.classList.add("hidden");
    }
  }

  function renderTaskStats() {
    const userTasks = isAdmin()
      ? allTasks
      : allTasks.filter((task) => {
          if (task[COL.T_ASSIGNEE] === currentUser.name) return true;
          const projectId = task[COL.T_PID];
          const project = allProjects.find((p) => p[COL.P_ID] === projectId);
          return project && project[COL.P_MANAGER] === currentUser.name;
        });

    const stats = {
      pending: userTasks.filter((t) =>
        (t[COL.T_STATUS] || "").toLowerCase().includes("chưa"),
      ).length,
      active: userTasks.filter((t) =>
        (t[COL.T_STATUS] || "").toLowerCase().includes("đang"),
      ).length,
      completed: userTasks.filter((t) =>
        (t[COL.T_STATUS] || "").toLowerCase().includes("hoàn thành"),
      ).length,
      paused: userTasks.filter((t) =>
        (t[COL.T_STATUS] || "").toLowerCase().includes("tạm dừng"),
      ).length,
    };

    document.getElementById("tasks-pending-count").innerHTML =
      `<i class="fas fa-pause-circle text-sm"></i>${stats.pending}`;
    document.getElementById("tasks-active-count").innerHTML =
      `<i class="fas fa-play-circle text-sm"></i>${stats.active}`;
    document.getElementById("tasks-completed-count").innerHTML =
      `<i class="fas fa-check-circle text-sm"></i>${stats.completed}`;
    document.getElementById("tasks-paused-count").innerHTML =
      `<i class="fas fa-pause text-sm"></i>${stats.paused}`;
  }

  function renderProjectStats() {
    const userProjects = getUserAllowedProjects();

    const stats = {
      pending: userProjects.filter((p) =>
        (p[COL.P_STATUS] || "").toLowerCase().includes("chưa"),
      ).length,
      active: userProjects.filter((p) =>
        (p[COL.P_STATUS] || "").toLowerCase().includes("đang"),
      ).length,
      completed: userProjects.filter((p) =>
        (p[COL.P_STATUS] || "").toLowerCase().includes("hoàn thành"),
      ).length,
      paused: userProjects.filter((p) =>
        (p[COL.P_STATUS] || "").toLowerCase().includes("tạm dừng"),
      ).length,
      canceled: userProjects.filter((p) =>
        (p[COL.P_STATUS] || "").toLowerCase().includes("hủy bỏ"),
      ).length,
    };

    document.getElementById("projects-pending-count").innerHTML =
      `<i class="fas fa-pause-circle text-sm"></i>${stats.pending}`;
    document.getElementById("projects-active-count").innerHTML =
      `<i class="fas fa-play-circle text-sm"></i>${stats.active}`;
    document.getElementById("projects-completed-count").innerHTML =
      `<i class="fas fa-check-circle text-sm"></i>${stats.completed}`;
    document.getElementById("projects-paused-count").innerHTML =
      `<i class="fas fa-pause text-sm"></i>${stats.paused}`;
    document.getElementById("projects-canceled-count").innerHTML =
      `<i class="fas fa-times-circle text-sm"></i>${stats.canceled}`;
  }

  function loadChatMessages() {
    google.script.run
      .withSuccessHandler(function (messages) {
        renderChatMessages(messages);
        // Cập nhật badge với số lượng tin nhắn
        updateChatBadge(messages.length);
      })
      .withFailureHandler(function (error) {
        console.error("Error loading chat:", error);
      })
      .getChatMessages();
  }

  function updateChatBadge(messageCount) {
    const badge = document.getElementById("chat-badge");
    if (badge) {
      if (messageCount > 0) {
        badge.textContent = messageCount;
        badge.classList.remove("hidden");
      } else {
        badge.classList.add("hidden");
      }
    }
  }

  function renderChatMessages(messages) {
    const container = document.getElementById("chat-messages");
    if (!messages || messages.length === 0) {
      container.innerHTML =
        '<div class="text-center text-gray-500 text-sm">Chưa có tin nhắn nào</div>';
      return;
    }

    container.innerHTML = messages
      .map((msg) => {
        const isMyMessage = msg.user === currentUser.name;
        return `
      <div class="flex items-start gap-3 ${isMyMessage ? "flex-row-reverse" : ""}">
        <div class="w-8 h-8 rounded-full bg-gradient-to-r from-blue-500 to-purple-500 flex items-center justify-center text-white text-xs font-semibold">
          ${msg.avatar}
        </div>
        <div class="flex-1 ${isMyMessage ? "text-right" : ""}">
          <div class="flex items-center gap-2 mb-1 ${isMyMessage ? "justify-end" : ""}">
            <span class="font-medium text-sm text-gray-900">${msg.user}</span>
            <span class="text-xs text-gray-500">${formatChatTime(msg.timestamp, msg.chatDate)}</span>
          </div>
          <div class="text-sm text-gray-700 ${isMyMessage ? "bg-blue-100 rounded-lg px-3 py-2 inline-block" : ""}">${formatChatMessage(msg.message)}</div>
        </div>
      </div>
    `;
      })
      .join("");

    container.scrollTop = container.scrollHeight;
  }

  function formatChatMessage(message) {
    // Replace @mentions with styled spans
    return message.replace(
      /@(\w+)/g,
      '<span class="bg-blue-100 text-blue-800 px-1 rounded">@$1</span>',
    );
  }

  function formatChatTime(timestamp, chatDate) {
    const today = new Date().toDateString();
    const yesterday = new Date();
    yesterday.setDate(yesterday.getDate() - 1);

    let dayLabel = "";
    if (chatDate === today) {
      dayLabel = "";
    } else if (chatDate === yesterday.toDateString()) {
      dayLabel = "Hôm qua ";
    } else {
      const date = new Date(chatDate);
      dayLabel = `${date.getDate()}/${date.getMonth() + 1} `;
    }

    if (typeof timestamp === "string" && timestamp.match(/^\d{1,2}:\d{2}$/)) {
      return dayLabel + timestamp;
    }

    try {
      const date = new Date(timestamp);
      if (isNaN(date.getTime())) return timestamp;

      const hours = String(date.getHours()).padStart(2, "0");
      const minutes = String(date.getMinutes()).padStart(2, "0");
      return dayLabel + `${hours}:${minutes}`;
    } catch (e) {
      return timestamp;
    }
  }

  function sendChatMessage() {
    const input = document.getElementById("chat-input");
    const message = input.value.trim();

    if (!message) return;

    const sendBtn = document.getElementById("send-chat-btn");
    sendBtn.disabled = true;
    input.disabled = true;

    // Optimistic update - Hiển thị message ngay bên phải
    const tempMessage = {
      id: "temp-" + Date.now(),
      user: currentUser.name,
      message: message,
      timestamp: new Date().toLocaleTimeString("vi-VN", {
        hour: "2-digit",
        minute: "2-digit",
      }),
      avatar: currentUser.name
        .split(" ")
        .map((n) => n[0])
        .join("")
        .toUpperCase()
        .slice(0, 2),
      chatDate: new Date().toDateString(),
    };

    // ← SỬA: Thêm class flex-row-reverse và text-right để hiển thị bên phải
    const container = document.getElementById("chat-messages");
    const tempDiv = document.createElement("div");
    tempDiv.id = "temp-message";
    tempDiv.innerHTML = `
    <div class="flex items-start gap-3 flex-row-reverse">
      <div class="w-8 h-8 rounded-full bg-gradient-to-r from-blue-500 to-purple-500 flex items-center justify-center text-white text-xs font-semibold">
        ${tempMessage.avatar}
      </div>
      <div class="flex-1 text-right">
        <div class="flex items-center gap-2 mb-1 justify-end">
          <span class="font-medium text-sm text-gray-900">${tempMessage.user}</span>
          <span class="text-xs text-gray-500">${tempMessage.timestamp}</span>
        </div>
        <div class="text-sm text-gray-700 bg-blue-100 rounded-lg px-3 py-2 inline-block">${formatChatMessage(message)}</div>
      </div>
    </div>
  `;
    container.appendChild(tempDiv);
    container.scrollTop = container.scrollHeight;
    input.value = "";

    google.script.run
      .withSuccessHandler(function (response) {
        if (response.success) {
          // Xóa temp message và load lại chat
          const tempMsg = document.getElementById("temp-message");
          if (tempMsg) tempMsg.remove();
          loadChatMessages();
        } else {
          // Rollback nếu lỗi
          const tempMsg = document.getElementById("temp-message");
          if (tempMsg) tempMsg.remove();
          showToast(response.error, "error");
        }
        sendBtn.disabled = false;
        input.disabled = false;
        input.focus();
      })
      .withFailureHandler(function (error) {
        // Rollback nếu lỗi
        const tempMsg = document.getElementById("temp-message");
        if (tempMsg) tempMsg.remove();
        showToast("Lỗi gửi tin nhắn: " + error.message, "error");
        sendBtn.disabled = false;
        input.disabled = false;
      })
      .sendChatMessage(message);
  }

  function handleQuickCompleteTask(e) {
    if (e.target.matches(".quick-complete-checkbox")) {
      const checkbox = e.target;
      const taskId = checkbox.dataset.id;
      const taskName = checkbox.dataset.name;

      if (!checkbox.checked) return; // Chỉ xử lý khi check vào
      e.preventDefault(); // Ngăn check ngay lập tức

      // Gọi Popup Custom thay vì confirm()
      showConfirmDialog(
        "Hoàn thành nhiệm vụ?",
        `Bạn có chắc chắn muốn đánh dấu "${taskName}" là đã hoàn thành không?`,
        function () {
          // Khi bấm Yes
          // 1. Optimistic UI
          checkbox.checked = true;
          checkbox.disabled = true;
          showToast("Đang cập nhật trạng thái...", "info");

          // Tìm task hiện tại
          const task = allTasks.find((t) => t[COL.T_ID] === taskId);
          if (task) {
            // CHUẨN BỊ DỮ LIỆU GỬI LÊN SERVER (QUAN TRỌNG: Gửi đủ các trường ngày tháng)
            // Lưu ý: task[COL.T_START] đang là chuỗi hiển thị (VD: 09/04/2025),
            // ta cần gửi nguyên trạng hoặc parse về YYYY-MM-DD nếu code.gs yêu cầu.
            // Ở đây ta gửi nguyên chuỗi hiển thị vì code.gs có hàm parseDate xử lý được.

            const updateData = {
              id: taskId,
              projectId: task[COL.T_PID],
              name: task[COL.T_NAME],
              status: "Hoàn thành",
              completion: 100,
              description: task[COL.T_DESC] || "",
              assignee: task[COL.T_ASSIGNEE] || "",
              priority: task[COL.T_PRIORITY] || "Trung bình",
              startDate: task[COL.T_START], // Gửi lại ngày bắt đầu cũ để không bị mất
              dueDate: task[COL.T_DUE], // Gửi lại hạn chót cũ
              reportDate: formatDateToISOString(new Date()), // Gửi ngày hoàn thành là hôm nay (YYYY-MM-DD)
              target: task[COL.T_TARGET] || "",
              resultLinks: task[COL.T_RESULT_LINKS] || "",
              output: task[COL.T_OUTPUT] || "",
              notes: task[COL.T_NOTES] || "",
            };

            // Cập nhật giao diện tạm thời
            updateOptimisticUpdate("task", taskId, updateData);

            // Gửi lên Server
            google.script.run
              .withSuccessHandler(function (response) {
                if (response.success) {
                  showToast("Nhiệm vụ đã hoàn thành!", "success");
                  // render lại để đảm bảo đồng bộ
                  if (currentSection === "tasks") {
                    // filterTasks(); // Tùy chọn: gọi lại nếu cần
                  } else if (currentSection === "gantt") {
                    renderGanttChart();
                  }
                  renderStats();
                  renderProjectStats();
                  renderProjects();
                } else {
                  checkbox.checked = false;
                  checkbox.disabled = false;
                  showToast(response.error || "Lỗi cập nhật", "error");
                  refreshData();
                }
              })
              .withFailureHandler(function (error) {
                checkbox.checked = false;
                checkbox.disabled = false;
                showToast("Lỗi kết nối: " + error.message, "error");
              })
              .updateTaskWithAuth(taskId, updateData);
          }
        },
        function () {
          // Khi bấm No/Cancel
          checkbox.checked = false;
        },
      );
    }
  }

  // Hàm hỗ trợ convert ngày sang YYYY-MM-DD để gửi lên server
  function formatDateToISOString(date) {
    if (!date) return "";
    const d = new Date(date);
    if (isNaN(d.getTime())) return "";
    return (
      d.getFullYear() +
      "-" +
      String(d.getMonth() + 1).padStart(2, "0") +
      "-" +
      String(d.getDate()).padStart(2, "0")
    );
  }

  // Hàm hiển thị Popup xác nhận đẹp
  function showConfirmDialog(title, message, onConfirm, onCancel) {
    // Tạo HTML modal nếu chưa có
    if (!document.getElementById("custom-confirm-modal")) {
      const modalHTML = `
            <div id="custom-confirm-modal" class="confirm-modal-overlay">
                <div class="confirm-modal-box">
                    <div class="w-12 h-12 rounded-full bg-green-100 mx-auto mb-4 flex items-center justify-center">
                        <i class="fas fa-check text-green-600 text-xl"></i>
                    </div>
                    <h3 id="confirm-title" class="text-lg font-bold text-gray-900 mb-2"></h3>
                    <p id="confirm-message" class="text-gray-500 text-sm mb-6"></p>
                    <div class="flex space-x-3 justify-center">
                        <button id="btn-cancel-confirm" class="px-4 py-2 bg-gray-100 text-gray-700 rounded-xl font-medium hover:bg-gray-200 transition-colors">Hủy bỏ</button>
                        <button id="btn-yes-confirm" class="px-6 py-2 bg-green-600 text-white rounded-xl font-medium hover:bg-green-700 shadow-lg shadow-green-500/30 transition-all">Xác nhận</button>
                    </div>
                </div>
            </div>
        `;
      document.body.insertAdjacentHTML("beforeend", modalHTML);
    }

    const modal = document.getElementById("custom-confirm-modal");
    const titleEl = document.getElementById("confirm-title");
    const msgEl = document.getElementById("confirm-message");
    const btnYes = document.getElementById("btn-yes-confirm");
    const btnNo = document.getElementById("btn-cancel-confirm");

    titleEl.textContent = title;
    msgEl.textContent = message;
    modal.classList.add("active");

    // Clone button để xóa event listener cũ
    const newBtnYes = btnYes.cloneNode(true);
    const newBtnNo = btnNo.cloneNode(true);
    btnYes.parentNode.replaceChild(newBtnYes, btnYes);
    btnNo.parentNode.replaceChild(newBtnNo, btnNo);

    newBtnYes.addEventListener("click", () => {
      modal.classList.remove("active");
      if (onConfirm) onConfirm();
    });

    newBtnNo.addEventListener("click", () => {
      modal.classList.remove("active");
      if (onCancel) onCancel();
    });
  }

  // --- Click vào dòng để sửa ---
  document.addEventListener("click", function (e) {
    // 1. XỬ LÝ CLICK VÀO DÒNG NHIỆM VỤ (Mở Edit Task)
    const taskItem = e.target.closest(".task-clickable");
    if (taskItem) {
      // Bỏ qua nếu click vào nút, link hoặc checkbox
      if (
        e.target.closest("button") ||
        e.target.closest("a") ||
        e.target.matches('input[type="checkbox"]') ||
        e.target.closest(".quick-complete-checkbox")
      ) {
        return;
      }

      const taskId = taskItem.dataset.id;

      // Logic giữ ngữ cảnh Modal chi tiết dự án
      if (document.getElementById("project-details-modal")) {
        const projectDetailsModal = document.getElementById(
          "project-details-modal",
        );
        const headerText = projectDetailsModal.querySelector("h3").textContent;
        const projectName = headerText
          .replace("Chi tiết dự án: ", "")
          .split(" (")[0];
        const task = allTasks.find((t) => t[COL.T_ID] === taskId);
        if (task) {
          openedFromProjectDetails = {
            projectId: task[COL.T_PID],
            projectName: projectName,
          };
        }
      }

      if (canUserEditResource("task", taskId)) {
        openEditModal("task", taskId);
      }
      return; // Dừng xử lý để tránh conflict
    }

    // 2. XỬ LÝ CLICK VÀO BOX DỰ ÁN (Mở Chi tiết dự án) --> [MỚI THÊM]
    const projectCard = e.target.closest(".project-clickable");
    if (projectCard) {
      // Bỏ qua nếu click vào các nút thao tác trên card
      if (
        e.target.closest("button") ||
        e.target.closest(".action-btn") ||
        e.target.closest("a")
      ) {
        return;
      }

      const projectId = projectCard.dataset.id;
      const projectName = projectCard.dataset.name;

      showProjectDetailsModal(projectId, projectName);
    }
  });

  // Đăng ký sự kiện toàn cục
  document.addEventListener("dragstart", function (e) {
    if (e.target.classList.contains("draggable-item")) {
      draggedItem = e.target;
      draggedProjectId = e.target.dataset.projectId;
      e.target.classList.add("dragging");
      // Cho phép di chuyển
      e.dataTransfer.effectAllowed = "move";
    }
  });

  document.addEventListener("dragend", function (e) {
    if (e.target.classList.contains("draggable-item")) {
      e.target.classList.remove("dragging");
      draggedItem = null;
      draggedProjectId = null;

      // Xóa style placeholder nếu còn sót
      document
        .querySelectorAll(".drag-placeholder")
        .forEach((el) => el.remove());
    }
  });

  document.addEventListener("dragover", function (e) {
    e.preventDefault(); // Cần thiết để cho phép drop

    // Chỉ xử lý nếu đang kéo item hợp lệ
    if (!draggedItem) return;

    // Tìm container (tbody hoặc div danh sách)
    const container = e.target.closest(
      ".gantt-project-tasks, tbody, .space-y-3",
    );
    if (!container) return;

    // Tìm item bên dưới chuột
    const afterElement = getDragAfterElement(container, e.clientY);

    // CHỈ CHO PHÉP KÉO THẢ CÙNG DỰ ÁN
    // Kiểm tra item bên dưới chuột có cùng project ID không
    const targetItem = e.target.closest(".draggable-item");
    if (targetItem) {
      const targetProjectId = targetItem.dataset.projectId;
      if (targetProjectId !== draggedProjectId) return; // Khác dự án thì không cho drop
    } else {
      // Nếu drop vào khoảng trắng, kiểm tra xem container đó có thuộc project đó không
      // (Logic này tùy thuộc vào cấu trúc HTML của bạn, ở đây ta check targetItem là đủ an toàn)
    }

    if (afterElement == null) {
      container.appendChild(draggedItem);
    } else {
      // Kiểm tra lại afterElement cũng phải cùng project
      if (afterElement.dataset.projectId === draggedProjectId) {
        container.insertBefore(draggedItem, afterElement);
      }
    }
  });

  // --- Thay thế toàn bộ sự kiện 'drop' ---
  document.addEventListener("drop", function (e) {
    e.preventDefault();
    if (!draggedItem) return;

    const container = draggedItem.parentElement;
    if (!container) return;

    // 1. Lấy danh sách ID mới từ giao diện sau khi thả
    const newOrderIds = [];
    let items = [];

    // Xác định loại container để query đúng thẻ
    if (container.tagName === "TBODY") {
      items = container.querySelectorAll("tr.draggable-item"); // Tab Nhiệm vụ
    } else {
      items = container.querySelectorAll(".draggable-item"); // Gantt/Modal
    }

    items.forEach((item) => {
      // Chỉ lấy item thuộc dự án đang kéo
      if (item.dataset.projectId === draggedProjectId) {
        newOrderIds.push(item.dataset.id);
      }
    });

    // 2. Lấy thứ tự gốc từ dữ liệu (allTasks) để so sánh
    // Lọc ra các task của dự án này
    const projectTasks = allTasks.filter(
      (t) => t[COL.T_PID] === draggedProjectId,
    );

    // Tạo Set các ID đang hiển thị để lọc nhanh
    const visibleIdsSet = new Set(newOrderIds);

    // Lấy danh sách ID theo thứ tự gốc, nhưng chỉ giữ lại các ID đang hiển thị trên màn hình
    // Điều này giúp so sánh chính xác kể cả khi bạn đang lọc danh sách
    const originalRelativeOrder = projectTasks
      .map((t) => t[COL.T_ID])
      .filter((id) => visibleIdsSet.has(id));

    // 3. So sánh: Nếu chuỗi JSON khác nhau nghĩa là thứ tự đã thay đổi
    const isChanged =
      JSON.stringify(newOrderIds) !== JSON.stringify(originalRelativeOrder);

    if (isChanged && newOrderIds.length > 1) {
      // Có thay đổi -> Gọi server lưu
      handleReorderTasks(draggedProjectId, newOrderIds);
    } else {
      // Không thay đổi -> Chỉ dọn dẹp giao diện, KHÔNG hiện thông báo, KHÔNG gọi server
      if (draggedItem) draggedItem.classList.remove("dragging");
      draggedItem = null;
      draggedProjectId = null;

      // Xóa các đường kẻ placeholder nếu còn sót
      document
        .querySelectorAll(".drag-placeholder")
        .forEach((el) => el.remove());
    }
  });

  // Hàm tính toán vị trí thả
  function getDragAfterElement(container, y) {
    const draggableElements = [
      ...container.querySelectorAll(".draggable-item:not(.dragging)"),
    ];

    return draggableElements.reduce(
      (closest, child) => {
        const box = child.getBoundingClientRect();
        const offset = y - box.top - box.height / 2;
        if (offset < 0 && offset > closest.offset) {
          return { offset: offset, element: child };
        } else {
          return closest;
        }
      },
      { offset: Number.NEGATIVE_INFINITY },
    ).element;
  }

  // Hàm gọi Server cập nhật thứ tự (Đã nâng cấp đồng bộ 3 nơi)
  function handleReorderTasks(projectId, newOrderIds) {
    // 1. CẬP NHẬT DỮ LIỆU CỤC BỘ (allTasks)
    // Tạo map các task của project này
    const projectTasks = allTasks.filter((t) => t[COL.T_PID] === projectId);
    const taskMap = new Map(projectTasks.map((t) => [t[COL.T_ID], t]));

    // Xóa các task cũ của project này trong allTasks để chuẩn bị xếp lại
    allTasks = allTasks.filter((t) => t[COL.T_PID] !== projectId);

    // Thêm lại các task theo thứ tự mới
    newOrderIds.forEach((id) => {
      if (taskMap.has(id)) {
        allTasks.push(taskMap.get(id));
        taskMap.delete(id);
      }
    });
    // Thêm lại các task sót (nếu có - trường hợp lỗi data)
    taskMap.forEach((task) => allTasks.push(task));

    // 2. CẬP NHẬT TAB NHIỆM VỤ (Vẽ lại ngay lập tức)
    renderTasks();

    // 3. CẬP NHẬT TAB GANTT (Nếu đang mở tab này)
    if (currentSection === "gantt") {
      renderGanttChart();
    }

    // 4. CẬP NHẬT MODEL CHI TIẾT DỰ ÁN (Nếu đang mở) -> [MỚI THÊM]
    const modal = document.getElementById("project-details-modal");
    if (modal && modal.classList.contains("active")) {
      // Kiểm tra xem Modal đang mở có đúng là dự án đang bị thay đổi thứ tự không
      // (Dựa vào text trên header modal có chứa ID dự án)
      const modalHeader = modal.querySelector("h3");
      if (modalHeader && modalHeader.textContent.includes(projectId)) {
        const taskContainer = modal.querySelector(".max-h-96.overflow-y-auto");
        if (taskContainer) {
          // Lấy danh sách task mới đã sắp xếp từ allTasks
          const updatedTasks = allTasks.filter(
            (t) => t[COL.T_PID] === projectId,
          );

          if (updatedTasks.length > 0) {
            // Vẽ lại HTML danh sách nhiệm vụ trong Modal
            const listHTML = `<div class="space-y-3">
                        ${updatedTasks.map((task) => createTaskListItem(task)).join("")}
                    </div>`;
            taskContainer.innerHTML = listHTML;
          }
        }
      }
    }

    // 5. GỌI SERVER LƯU LẠI
    showToast("Đang lưu thứ tự...", "info");
    google.script.run
      .withSuccessHandler(() => {
        showToast("Đã lưu vị trí mới", "success");
      })
      .withFailureHandler((err) => {
        showToast("Lỗi lưu vị trí: " + err.message, "error");
        refreshData(); // Tải lại dữ liệu cũ nếu lỗi
      })
      .reorderTasks(projectId, newOrderIds);
  }

  function openStatListModal(type, filterType, title) {
    // 1. Lọc dữ liệu dựa trên loại box được click
    let items = [];

    if (type === "project") {
      // Lấy tất cả dự án (sắp xếp mới nhất lên đầu)
      items = [...allProjects].reverse();
    } else if (type === "task") {
      if (filterType === "all") {
        items = [...allTasks];
      } else if (filterType === "active") {
        // Đang làm = Đang thực hiện + Chưa bắt đầu + Tạm dừng
        items = allTasks.filter((t) => {
          const s = (t[COL.T_STATUS] || "").toLowerCase();
          return (
            s.includes("đang") || s.includes("chưa") || s.includes("tạm dừng")
          );
        });
      } else if (filterType === "overdue") {
        // Quá hạn
        items = allTasks.filter(
          (t) =>
            isTaskOverdue(t[COL.T_DUE]) &&
            !(t[COL.T_STATUS] || "").toLowerCase().includes("hoàn thành"),
        );
      }
    }

    currentStatListData = items; // Lưu để dùng cho search

    // 2. Tạo HTML Modal
    const modalHTML = `
        <div id="stat-list-modal" class="modal active">
            <div class="modal-content" style="max-width: 600px; height: 80vh; display: flex; flex-direction: column;">
                <div class="flex items-center justify-between mb-4 flex-shrink-0">
                    <h3 class="text-xl font-bold text-gray-900">${title} <span class="text-sm text-gray-500 font-normal">(${items.length})</span></h3>
                    <button type="button" class="close-modal text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <div class="mb-4 relative flex-shrink-0">
                    <input type="text" id="stat-list-search" placeholder="Tìm kiếm..." 
                           class="w-full pl-10 pr-4 py-2 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500/20 transition-all">
                    <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                </div>

                <div id="stat-list-container" class="overflow-y-auto flex-1 pr-1 space-y-2">
                    </div>
            </div>
        </div>
    `;

    // 3. Hiển thị Modal
    // Xóa modal cũ nếu có
    const oldModal = document.getElementById("stat-list-modal");
    if (oldModal) oldModal.remove();

    document.body.insertAdjacentHTML("beforeend", modalHTML);

    // Render danh sách ban đầu
    renderStatListItems(type, items);

    // 4. Xử lý sự kiện Search
    document
      .getElementById("stat-list-search")
      .addEventListener("input", (e) => {
        const term = e.target.value.toLowerCase();
        const filtered = currentStatListData.filter((item) => {
          const name = type === "project" ? item[COL.P_NAME] : item[COL.T_NAME];
          const id = type === "project" ? item[COL.P_ID] : item[COL.T_ID];
          return (
            (name && name.toLowerCase().includes(term)) ||
            (id && id.toLowerCase().includes(term))
          );
        });
        renderStatListItems(type, filtered);
      });

    // 5. Xử lý đóng modal
    const modal = document.getElementById("stat-list-modal");
    modal.querySelector(".close-modal").addEventListener("click", () => {
      modal.remove();
    });
  }

  function renderStatListItems(type, items) {
    const container = document.getElementById("stat-list-container");
    if (!items || items.length === 0) {
      container.innerHTML =
        '<div class="text-center py-8 text-gray-500">Không có dữ liệu</div>';
      return;
    }

    container.innerHTML = items
      .map((item) => {
        if (type === "project") {
          // --- Render Item Dự án ---
          const pId = item[COL.P_ID];
          const pName = item[COL.P_NAME];
          const pStatus = item[COL.P_STATUS];
          const pManager = item[COL.P_MANAGER] || "N/A";
          const pStart = formatDateForDisplay(item[COL.P_START]);
          const pEnd = formatDateForDisplay(item[COL.P_END]);

          const pTasks = allTasks.filter((t) => t[COL.T_PID] === pId);
          const totalPct = pTasks.reduce(
            (sum, t) => sum + parseInt(t[COL.T_COMPLETION] || 0),
            0,
          );
          const prog =
            pTasks.length > 0 ? Math.round(totalPct / pTasks.length) : 0;

          return `
                <div class="stat-list-item rounded-xl border border-gray-100 hover:border-blue-200 bg-white p-3 mb-2 shadow-sm transition-all" 
                     onclick="showProjectDetailsModal('${pId}', '${pName}')">
                    
                    <div class="flex justify-between items-start mb-2">
                        <div>
                            <div class="font-bold text-gray-800 text-sm">${pName} <span class="text-gray-400 font-normal text-xs ml-1">(${pId})</span></div>
                            <div class="text-xs text-gray-500 mt-1 flex items-center gap-3">
                                <span><i class="fas fa-user-tie mr-1 text-purple-500"></i>${pManager}</span>
                                <span><i class="fas fa-calendar-alt mr-1 text-blue-500"></i>${pStart} - ${pEnd}</span>
                            </div>
                        </div>
                        <span class="status-badge ${getStatusClass(pStatus)}">${pStatus}</span>
                    </div>

                    <div class="flex items-center gap-2">
                        <div class="flex-1 h-1.5 bg-gray-100 rounded-full overflow-hidden">
                            <div class="h-full bg-blue-500 rounded-full" style="width: ${prog}%"></div>
                        </div>
                        <span class="text-xs font-medium text-gray-600 min-w-[30px] text-right">${prog}%</span>
                    </div>
                </div>
            `;
        } else {
          // --- Render Item Nhiệm vụ ---
          const tId = item[COL.T_ID];
          const tName = item[COL.T_NAME];
          const tStatus = item[COL.T_STATUS];
          const tPriority = item[COL.T_PRIORITY];
          const tAssignee = item[COL.T_ASSIGNEE] || "N/A";
          const tDue = formatDateForDisplay(item[COL.T_DUE]);
          const tCompletion = parseInt(item[COL.T_COMPLETION] || 0);
          const isOverdue =
            isTaskOverdue(item[COL.T_DUE]) &&
            !tStatus.toLowerCase().includes("hoàn thành");

          const project = allProjects.find(
            (p) => p[COL.P_ID] === item[COL.T_PID],
          );
          const pName = project ? project[COL.P_NAME] : item[COL.T_PID];

          return `
                <div class="stat-list-item rounded-xl border border-gray-100 hover:border-blue-200 bg-white p-3 mb-2 shadow-sm transition-all ${isOverdue ? "border-l-4 border-l-red-500" : ""}" 
                     onclick="if(canUserEditResource('task', '${tId}')) openEditModal('task', '${tId}')">
                    
                    <div class="flex justify-between items-start mb-1">
                        <div class="flex-1 pr-2">
                            <div class="font-semibold text-gray-800 text-sm leading-snug">${tName}</div>
                        </div>
                        
                        <div class="flex items-center gap-2 shrink-0">
                            <span class="status-badge ${getStatusClass(tStatus)}">${tStatus}</span>
                            ${isOverdue ? '<span class="status-badge status-overdue">Quá hạn</span>' : ""}
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-y-1 text-xs text-gray-500 mt-1 mb-2">
                        <div class="col-span-2 flex items-center text-gray-600 font-medium">
                            <i class="fas fa-folder-open mr-1.5 text-yellow-500"></i>${pName}
                        </div>
                        <div class="flex items-center">
                            <i class="fas fa-user mr-1.5 text-blue-400"></i>${tAssignee}
                        </div>
                        <div class="flex items-center justify-end">
                            <i class="fas fa-clock mr-1.5 ${isOverdue ? "text-red-500" : "text-green-500"}"></i>${tDue}
                        </div>
                    </div>

                    <div class="flex items-center gap-2">
                        <div class="flex-1 h-1.5 bg-gray-100 rounded-full overflow-hidden">
                            <div class="h-full ${tCompletion === 100 ? "bg-green-500" : "bg-blue-500"} rounded-full" style="width: ${tCompletion}%"></div>
                        </div>
                        <span class="text-xs font-medium text-gray-600 min-w-[30px] text-right">${tCompletion}%</span>
                    </div>
                </div>
            `;
        }
      })
      .join("");
  }
</script>
