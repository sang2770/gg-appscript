<script>
  // === SUBMIT RESULT FUNCTIONS ===

  function canUserSubmitResult(taskId) {
    if (!isAuthenticated) return false;

    // Admin có thể nộp kết quả cho tất cả
    if (isAdmin()) return true;

    const task = allTasks.find((t) => t[COL.T_ID] === taskId);
    if (!task) return false;

    // Người được giao nhiệm vụ có thể nộp kết quả
    if (task[COL.T_ASSIGNEE] === currentUser.name) return true;

    // Người quản lý dự án có thể nộp kết quả
    const project = allProjects.find((p) => p[COL.P_ID] === task[COL.T_PID]);
    if (project && project[COL.P_MANAGER] === currentUser.name) return true;
    return false;
  }

  // Helper function to get progress color based on completion percentage
  function getProgressColor(completion) {
    if (completion === 0) return "bg-gray-300";
    if (completion < 25) return "bg-red-500";
    if (completion < 50) return "bg-orange-500";
    if (completion < 75) return "bg-yellow-500";
    if (completion < 100) return "bg-green-500";
    return "bg-green-600";
  }

  function getProgressGradient(completion) {
    if (completion === 0) return "bg-gray-300";
    if (completion < 25) return "bg-gradient-to-r from-red-400 to-red-500";
    if (completion < 50)
      return "bg-gradient-to-r from-orange-400 to-orange-500";
    if (completion < 75)
      return "bg-gradient-to-r from-yellow-400 to-yellow-500";
    if (completion < 100) return "bg-gradient-to-r from-green-400 to-green-500";
    return "bg-gradient-to-r from-green-500 to-green-600";
  }

  function getProgressTextColor(completion) {
    if (completion === 0) return "text-gray-600";
    if (completion < 25) return "text-red-600";
    if (completion < 50) return "text-orange-600";
    if (completion < 75) return "text-yellow-600";
    return "text-green-600";
  }

  function openSubmitResultModal(taskId, taskName) {
    const task = allTasks.find((t) => t[COL.T_ID] === taskId);
    if (!task) {
      showToast("Không tìm thấy nhiệm vụ", "error");
      return;
    }

    const currentResultLinks = task[COL.T_RESULT_LINKS] || "";
    const existingImages = task[COL.T_IMAGES] || [];

    // Check if the task is overdue
    const dueDate = new Date(task[COL.T_DUE]);
    const today = new Date();
    const isOverdue = dueDate < today;

    let existingImagesHTML = "";
    if (existingImages && existingImages.length > 0) {
      existingImagesHTML = `
        <div class="mb-4 existing-images-container">
          <h4 class="text-sm font-medium text-gray-700 mb-3">Hình ảnh hiện có:</h4>
          <div class="grid grid-cols-2 gap-3">
            ${existingImages
              .map(
                (img, index) => `
              <div class="existing-image-item border rounded-lg p-2 bg-white">
                <div class="relative">
                  <img src="${img.type === "base64" ? img.data : img.data}" 
                       class="w-full h-24 object-cover rounded border" 
                       alt="Existing image ${index + 1}"
                       onclick="viewImageFullSize('${img.data.replace(/'/g, "\\'")}', '${img.description}')"
                       style="cursor: pointer;">
                  <button 
                    type="button" 
                    onclick="removeExistingImage(${index})"
                    class="absolute top-1 right-1 bg-red-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs hover:bg-red-600"
                  >
                    ×
                  </button>
                </div>
                <p class="text-xs text-gray-500 mt-1 truncate">${img.description || `Hình ảnh ${index + 1}`}</p>
              </div>
            `,
              )
              .join("")}
          </div>
        </div>
      `;
    }
    const modalHTML = `
      <div id="submit-result-modal" class="modal">
        <div class="modal-content max-w-2xl">
          <div class="flex items-center justify-between mb-6">
            <h3 class="text-xl font-bold text-gray-900">Nộp kết quả: ${taskName}</h3>
            <button type="button" class="close-modal text-gray-400 hover:text-gray-600">
              <i class="fas fa-times"></i>
            </button>
          </div>
          
          <form id="submit-result-form" class="space-y-6">
            <div class="form-group">
              <label class="form-label required">Link kết quả</label>
              <textarea 
                name="resultLinks" 
                class="form-textarea" 
                rows="4"
                placeholder="Nhập các link kết quả (mỗi link một dòng)"
                ${isOverdue ? "disabled" : ""}
                >${currentResultLinks}</textarea>
              <div class="text-xs text-gray-500 mt-1">Mỗi link trên một dòng</div>
            </div>
            <div class="form-group">
              <label class="form-label">Hình ảnh minh họa</label>
              ${existingImagesHTML}
              <div class="space-y-3">
                <div id="image-upload-container" class="space-y-3">
                  <!-- Image upload slots will be added here -->
                </div>
                 ${
                   isOverdue
                     ? ""
                     : `
                  <button 
                  type="button" 
                  id="add-image-btn"
                  class="btn-secondary w-full"
                 
                >
                  <i class="fas fa-plus mr-2"></i>Thêm hình ảnh mới
                </button>
                 `
                 }
               
                <div class="text-xs text-gray-500 bg-blue-50 p-3 rounded-lg">
                  <i class="fas fa-info-circle mr-2 text-blue-500"></i>
                  <div class="space-y-1">
                    <div><strong>Tùy chọn tải lên:</strong></div>
                    <div>• <strong>Chọn file:</strong> Tự động chuyển thành Base64</div>
                    <div>• <strong>Nhập link:</strong> Google Drive, Imgur, hoặc URL hình ảnh khác</div>
                  </div>
                </div>
              </div>
            </div>
            
            <div class="form-group">
              <label class="form-label">Cập nhật tiến độ (%)</label>
              <div class="flex items-center space-x-4">
                <div class="flex-1 relative">
                  <input 
                    type="range" 
                    name="completion" 
                    min="0" 
                    max="100" 
                    value="${parseInt(task[COL.T_COMPLETION] || 0)}"
                    class="w-full h-3 rounded-lg appearance-none cursor-pointer"
                    id="completion-slider"
                    style="background: linear-gradient(to right, #ef4444 0%, #f97316 25%, #eab308 50%, #22c55e 75%, #22c55e 100%); outline: none;"
                    ${isOverdue ? "disabled" : ""}
                  />
                </div>
                <div class="text-lg font-semibold min-w-[4rem] px-3 py-2 rounded-lg shadow-sm border" id="completion-display">
                  <span id="completion-value">${parseInt(task[COL.T_COMPLETION] || 0)}</span>%
                </div>
              </div>
              <div class="flex justify-between text-xs text-gray-500 mt-2">
                <span>0%</span>
                <span class="text-red-500">25% Bắt đầu</span>
                <span class="text-orange-500">50% Đang làm</span>
                <span class="text-yellow-500">75% Sắp xong</span>
                <span class="text-green-500">100% Hoàn thành</span>
              </div>
            </div>

            ${
              isAdmin() || isManager()
                ? `
            <div class="form-group">
              <label class="form-label">Chấm điểm</label>
              <div class="flex items-center space-x-4">
                <input 
                  type="number" 
                  name="score" 
                  min="0" 
                  max="100" 
                  value="${task[COL.T_SCORE] || ""}"
                  placeholder="Nhập điểm (0-100)"
                  class="form-input w-full"
                />
                <button 
                  type="button" 
                  class="btn-primary"
                  onclick="submitScore('${taskId}')"
                >
                  <i class="fas fa-check mr-2"></i>Chấm điểm
                </button>
              </div>
            </div>
            `
                : ""
            }
            
            <div class="flex justify-end space-x-3">
              <button type="button" class="btn-secondary close-modal">Hủy</button>
              ${
                isOverdue
                  ? ""
                  : `<button type="submit" class="btn-primary">
                <i class="fas fa-upload mr-2"></i>Nộp kết quả
              </button>`
              }
              
            </div>
          </form>
          ${isOverdue ? '<div class="text-red-500 text-sm mt-4 bg-red-50 p-3 rounded-lg border border-red-200"><i class="fas fa-exclamation-triangle mr-2"></i>Nhiệm vụ đã quá hạn, không thể nộp kết quả. Tuy nhiên, vẫn có thể chấm điểm.</div>' : ""}
        </div>
      </div>
    `;

    document.getElementById("modals-container").innerHTML = modalHTML;

    const modal = document.getElementById("submit-result-modal");
    modal.classList.add("active");

    // Store existing images data in modal for later processing
    modal.dataset.existingImages = JSON.stringify(existingImages);

    // Setup completion slider with color coding
    const slider = modal.querySelector("#completion-slider");
    const valueDisplay = modal.querySelector("#completion-value");
    const completionDisplay = modal.querySelector("#completion-display");

    function updateCompletionDisplay(value) {
      valueDisplay.textContent = value;

      // Update slider track color
      const percentage = (value / 100) * 100;
      slider.style.background = `linear-gradient(to right, 
        #ef4444 0%, #ef4444 ${Math.min(percentage, 25)}%, 
        #f97316 25%, #f97316 ${Math.min(percentage, 50)}%, 
        #eab308 50%, #eab308 ${Math.min(percentage, 75)}%, 
        #22c55e 75%, #22c55e 100%)`;

      // Update display colors based on completion percentage
      if (value === 0) {
        completionDisplay.className =
          "text-lg font-semibold min-w-[4rem] px-3 py-2 rounded-lg shadow-sm border bg-gray-100 text-gray-600";
      } else if (value < 25) {
        completionDisplay.className =
          "text-lg font-semibold min-w-[4rem] px-3 py-2 rounded-lg shadow-sm border bg-red-50 text-red-600";
      } else if (value < 50) {
        completionDisplay.className =
          "text-lg font-semibold min-w-[4rem] px-3 py-2 rounded-lg shadow-sm border bg-orange-50 text-orange-600";
      } else if (value < 75) {
        completionDisplay.className =
          "text-lg font-semibold min-w-[4rem] px-3 py-2 rounded-lg shadow-sm border bg-yellow-50 text-yellow-600";
      } else if (value < 100) {
        completionDisplay.className =
          "text-lg font-semibold min-w-[4rem] px-3 py-2 rounded-lg shadow-sm border bg-green-50 text-green-600";
      } else {
        completionDisplay.className =
          "text-lg font-semibold min-w-[4rem] px-3 py-2 rounded-lg shadow-sm border bg-green-100 text-green-700";
      }
    }

    // Initialize display
    updateCompletionDisplay(parseInt(task[COL.T_COMPLETION] || 0));

    if (slider) {
      slider.addEventListener("input", function () {
        updateCompletionDisplay(parseInt(this.value));
      });
    }

    // Setup image upload functionality
    setupImageUpload();

    // Setup form submission
    const form = modal.querySelector("#submit-result-form");
    if (form) {
      form.addEventListener("submit", function (e) {
        e.preventDefault();
        handleSubmitResult(taskId, task, form);
      });
    }

    // Setup close handlers
    const closeButtons = modal.querySelectorAll(".close-modal");
    closeButtons.forEach((btn) => {
      btn.addEventListener("click", (e) => {
        e.preventDefault();
        closeModal("submit-result-modal");
      });
    });
  }

  function setupImageUpload() {
    const container = document.getElementById("image-upload-container");
    const addBtn = document.getElementById("add-image-btn");
    if (!container || !addBtn) return;
    let imageCount = 0;

    function addImageSlot() {
      imageCount++;
      const slotHTML = `
        <div class="image-upload-slot border rounded-lg p-4 space-y-3 bg-gray-50" data-index="${imageCount}">
          <div class="flex items-center justify-between">
            <h4 class="font-medium text-gray-700">Hình ảnh ${imageCount}</h4>
            <button 
              type="button" 
              class="remove-image-btn text-red-500 hover:text-red-700 p-1"
              onclick="removeImageSlot(${imageCount})"
            >
              <i class="fas fa-times"></i>
            </button>
          </div>
          
          <div class="space-y-2">
            <!-- File Upload Option -->
            <div>
              <label class="text-sm font-medium text-gray-600 block mb-1">
                <i class="fas fa-upload mr-2"></i>Chọn file ảnh
              </label>
              <div class="relative">
                <input 
                  type="file" 
                  name="image_file_${imageCount}"
                  accept="image/*"
                  class="hidden"
                  id="file-input-${imageCount}"
                  onchange="handleFileUpload(this, ${imageCount})"
                />
                <label 
                  for="file-input-${imageCount}"
                  class="cursor-pointer flex items-center justify-center w-full p-3 border-2 border-dashed border-gray-300 rounded-lg hover:border-blue-400 hover:bg-blue-50 transition-colors"
                >
                  <div class="text-center">
                    <i class="fas fa-cloud-upload-alt text-2xl text-gray-400 mb-1"></i>
                    <div class="text-sm text-gray-600">Nhấn để chọn ảnh</div>
                    <div class="text-xs text-gray-500">PNG, JPG, GIF (max 5MB)</div>
                  </div>
                </label>
              </div>
            </div>
            
            <div class="text-center text-gray-400 font-medium">- HOẶC -</div>
            
            <!-- URL Input Option -->
            <div>
              <label class="text-sm font-medium text-gray-600 block mb-1">
                <i class="fas fa-link mr-2"></i>Nhập link ảnh
              </label>
              <input 
                type="url" 
                name="image_url_${imageCount}" 
                placeholder="https://example.com/image.jpg"
                class="form-input w-full"
                onchange="handleUrlInput(this, ${imageCount})"
                onblur="handleUrlInput(this, ${imageCount})"
              />
            </div>
            
            <!-- Preview Area -->
            <div id="preview-${imageCount}" class="preview-area hidden">
              <div class="relative">
                <img id="preview-img-${imageCount}" class="w-full h-32 object-cover rounded-lg border" alt="Preview">
                <button 
                  type="button" 
                  onclick="clearImagePreview(${imageCount})"
                  class="absolute top-2 right-2 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs hover:bg-red-600"
                >
                  ×
                </button>
              </div>
              <div id="image-info-${imageCount}" class="text-xs text-gray-500 mt-1"></div>
            </div>
          </div>
        </div>
      `;
      container.insertAdjacentHTML("beforeend", slotHTML);

      if (imageCount >= 4) {
        addBtn.style.display = "none";
      }
    }

    // Global functions for handling file upload and preview
    window.handleFileUpload = function (input, slotIndex) {
      const file = input.files[0];
      if (!file) return;

      // Validate file size (5MB limit)
      if (file.size > 5 * 1024 * 1024) {
        showToast("File quá lớn! Vui lòng chọn file nhỏ hơn 5MB", "error");
        input.value = "";
        return;
      }

      // Validate file type
      if (!file.type.startsWith("image/")) {
        showToast("Vui lòng chọn file hình ảnh!", "error");
        input.value = "";
        return;
      }

      const reader = new FileReader();
      reader.onload = function (e) {
        const base64Data = e.target.result; // Extract Base64 data

        // Clear URL input when file is uploaded
        const urlInput = document.querySelector(
          `input[name="image_url_${slotIndex}"]`,
        );
        if (urlInput) urlInput.value = "";

        // Show loading indicator
        showToast("Đang tải ảnh lên...", "info");

        // Call Google Apps Script function to upload image
        google.script.run
          .withSuccessHandler(function (response) {
            if (!response || !response.url) {
              showToast(
                "Lỗi khi tải ảnh lên!" + JSON.stringify(response),
                "error",
              );
              return;
            }
            driveLink = response.url;
            // Show preview
            showImagePreview(
              slotIndex,
              driveLink,
              `File: ${file.name} (${(file.size / 1024).toFixed(1)}KB)`,
            );

            // Store the Drive link in a hidden input
            let hiddenInput = document.getElementById(`image_url_${slotIndex}`);
            if (!hiddenInput) {
              hiddenInput = document.createElement("input");
              hiddenInput.type = "hidden";
              hiddenInput.id = `image_url_${slotIndex}`;
              hiddenInput.name = `image_url_${slotIndex}`;
              input.parentNode.appendChild(hiddenInput);
            }
            hiddenInput.value = driveLink;

            showToast("Tải ảnh lên thành công!", "success");
          })
          .withFailureHandler(function (error) {
            showToast("Lỗi khi tải ảnh lên: " + error.message, "error");
          })
          .uploadImageToDrive(base64Data, file.name);
      };
      reader.readAsDataURL(file);
    };

    window.handleUrlInput = function (input, slotIndex) {
      const url = input.value.trim();
      if (!url) return;

      // Clear file input when URL is entered
      const fileInput = document.getElementById(`file-input-${slotIndex}`);
      if (fileInput) fileInput.value = "";

      // Clear base64 data
      const hiddenInput = document.getElementById(`base64-${slotIndex}`);
      if (hiddenInput) hiddenInput.remove();

      // Validate URL format
      try {
        new URL(url);
      } catch {
        showToast("URL không hợp lệ!", "error");
        input.value = "";
        return;
      }

      // Show preview for valid image URLs
      if (isImageUrl(url)) {
        showImagePreview(slotIndex, url, `Link: ${url}`);
      } else {
        showToast(
          "Link không phải hình ảnh. Vui lòng sử dụng link trực tiếp đến file ảnh.",
          "warning",
        );
      }
    };

    window.isImageUrl = function (url) {
      return (
        /\.(jpg|jpeg|png|gif|bmp|webp|svg)(\?.*)?$/i.test(url) ||
        url.includes("drive.google.com") ||
        url.includes("imgur.com") ||
        url.includes("images") ||
        url.includes("photo")
      );
    };

    window.showImagePreview = function (slotIndex, src, info) {
      const previewArea = document.getElementById(`preview-${slotIndex}`);
      const previewImg = document.getElementById(`preview-img-${slotIndex}`);
      const imageInfo = document.getElementById(`image-info-${slotIndex}`);

      previewImg.src = src;
      imageInfo.textContent = info;
      previewArea.classList.remove("hidden");
    };

    window.clearImagePreview = function (slotIndex) {
      const previewArea = document.getElementById(`preview-${slotIndex}`);
      const fileInput = document.getElementById(`file-input-${slotIndex}`);
      const urlInput = document.querySelector(
        `input[name="image_url_${slotIndex}"]`,
      );
      const hiddenInput = document.getElementById(`base64-${slotIndex}`);

      previewArea.classList.add("hidden");
      if (fileInput) fileInput.value = "";
      if (urlInput) urlInput.value = "";
      if (hiddenInput) hiddenInput.remove();
    };

    // Remove image slot function (global)
    window.removeImageSlot = function (index) {
      const slot = document.querySelector(`[data-index="${index}"]`);
      if (slot) {
        slot.remove();
        imageCount--;
        if (imageCount < 4 && addBtn) {
          addBtn.style.display = "";
        }
      }
    };

    if (addBtn) {
      addBtn.addEventListener("click", addImageSlot);
    }

    // Add first slot by default
    addImageSlot();
  }

  // Global functions for handling existing images
  window.viewImageFullSize = function (imageSrc, description) {
    const modalHTML = `
      <div id="image-viewer-modal" class="modal">
        <div class="modal-content max-w-4xl">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-semibold text-gray-900">${description || "Xem hình ảnh"}</h3>
            <button type="button" class="close-modal text-gray-400 hover:text-gray-600">
              <i class="fas fa-times"></i>
            </button>
          </div>
          <div class="text-center">
            <img src="${imageSrc}" class="max-w-full max-h-96 mx-auto rounded-lg border shadow-lg" alt="Full size image">
          </div>
          <div class="flex justify-end mt-4">
            <button type="button" class="btn-secondary close-modal">Đóng</button>
          </div>
        </div>
      </div>
    `;

    document.getElementById("modals-container").innerHTML = modalHTML;
    const viewerModal = document.getElementById("image-viewer-modal");
    viewerModal.classList.add("active");

    // Setup close handlers
    const closeButtons = viewerModal.querySelectorAll(".close-modal");
    closeButtons.forEach((btn) => {
      btn.addEventListener("click", () => closeModal("image-viewer-modal"));
    });
  };

  window.removeExistingImage = function (imageIndex) {
    if (confirm("Bạn có chắc chắn muốn xóa hình ảnh này?")) {
      const modal = document.getElementById("submit-result-modal");
      const existingImages = JSON.parse(modal.dataset.existingImages || "[]");

      // Remove image from array
      existingImages.splice(imageIndex, 1);

      // Update stored data
      modal.dataset.existingImages = JSON.stringify(existingImages);

      // Refresh the existing images display
      refreshExistingImagesDisplay(existingImages);

      showToast("Đã xóa hình ảnh", "success");
    }
  };

  function refreshExistingImagesDisplay(existingImages) {
    const existingImagesContainer = document.querySelector(
      ".existing-images-container",
    );
    if (!existingImagesContainer) return;

    if (existingImages.length === 0) {
      existingImagesContainer.remove();
      return;
    }

    existingImagesContainer.innerHTML = `
      <h4 class="text-sm font-medium text-gray-700 mb-3">Hình ảnh hiện có:</h4>
      <div class="grid grid-cols-2 gap-3">
        ${existingImages
          .map(
            (img, index) => `
          <div class="existing-image-item border rounded-lg p-2">
            <div class="relative">
              <img src="${img.type === "base64" ? img.data : img.data}" 
                   class="w-full h-24 object-cover rounded border" 
                   alt="Existing image ${index + 1}"
                   onclick="viewImageFullSize('${img.data.replace(/'/g, "\\'")}', '${img.description}')"
                   style="cursor: pointer;">
              <button 
                type="button" 
                onclick="removeExistingImage(${index})"
                class="absolute top-1 right-1 bg-red-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs hover:bg-red-600"
              >
                ×
              </button>
            </div>
            <p class="text-xs text-gray-500 mt-1 truncate">${img.description || `Hình ảnh ${index + 1}`}</p>
          </div>
        `,
          )
          .join("")}
      </div>
    `;
  }

  function handleSubmitResult(taskId, task, form) {
    const formData = new FormData(form);
    const resultLinks = formData.get("resultLinks").trim() || "";
    const completion = parseInt(formData.get("completion") || 0);

    // Get existing images from modal data
    const modal = document.getElementById("submit-result-modal");
    const existingImages = JSON.parse(modal.dataset.existingImages || "[]");

    // Collect new image data (both URLs and base64)
    const newImages = [];
    const imageUrlInputs = form.querySelectorAll('input[name^="image_url_"]');
    const imageBase64Inputs = form.querySelectorAll(
      'input[name^="image_base64_"]',
    );

    // Process URL images
    imageUrlInputs.forEach((input, index) => {
      const url = input.value.trim();
      if (url) {
        newImages.push({
          type: "url",
          data: url,
          description: `Hình ảnh mới ${newImages.length + 1} (Link)`,
        });
      }
    });

    // Process base64 images
    imageBase64Inputs.forEach((input, index) => {
      const base64Data = input.value.trim();
      if (base64Data) {
        newImages.push({
          type: "base64",
          data: base64Data,
          description: `Hình ảnh mới ${newImages.length + 1} (Upload)`,
        });
      }
    });

    // Combine existing images with new images
    const allImages = [...existingImages, ...newImages];

    // Prepare update data using COL constants
    const updateData = {
      id: taskId,
      projectId: task[COL.T_PID],
      name: task[COL.T_NAME],
      completion: 100,
      description: task[COL.T_DESC] || "",
      assignee: task[COL.T_ASSIGNEE] || "",
      priority: task[COL.T_PRIORITY] || "Trung bình",
      startDate: task[COL.T_START], // Gửi lại ngày bắt đầu cũ để không bị mất
      dueDate: task[COL.T_DUE], // Gửi lại hạn chót cũ
      reportDate: formatDateToISOString(new Date()), // Gửi ngày hoàn thành là hôm nay (YYYY-MM-DD)
      target: task[COL.T_TARGET] || "",
      output: task[COL.T_OUTPUT] || "",
      notes: task[COL.T_NOTES] || "",
      resultLinks: resultLinks,
      completion: completion,
      images: allImages,
    };

    // Auto update status based on completion with enhanced logic
    if (completion >= 100) {
      updateData["status"] = "Hoàn thành";
      updateData["reportDate"] = formatDate(new Date());
    } else if (completion >= 75) {
      updateData["status"] = "Gần hoàn thành";
    } else if (completion >= 25) {
      updateData["status"] = "Đang thực hiện";
    } else if (completion > 0) {
      updateData["status"] = "Bắt đầu";
    }

    const submitBtn = form.querySelector('button[type="submit"]');
    setButtonLoading(submitBtn, true);

    google.script.run
      .withSuccessHandler(function (response) {
        setButtonLoading(submitBtn, false);
        if (response.success) {
          showToast("Nộp kết quả thành công!", "success");
          closeModal("submit-result-modal");
          refreshData(); // Refresh to show updated data
        } else {
          showToast(response.error || "Lỗi khi nộp kết quả", "error");
        }
      })
      .withFailureHandler(function (error) {
        setButtonLoading(submitBtn, false);
        showToast("Lỗi: " + error.message, "error");
      })
      .updateTaskWithAuth(taskId, updateData);
  }

  function submitScore(taskId) {
    const modal = document.getElementById("submit-result-modal");
    const scoreInput = modal.querySelector('input[name="score"]');
    const score = parseInt(scoreInput.value);

    if (isNaN(score) || score < 0 || score > 100) {
      showToast("Vui lòng nhập điểm hợp lệ (0-100)", "error");
      return;
    }

    const submitBtn = modal.querySelector(
      `button[onclick="submitScore('${taskId}')"]`,
    );
    setButtonLoading(submitBtn, true);

    google.script.run
      .withSuccessHandler(function (response) {
        setButtonLoading(submitBtn, false);
        if (response.success) {
          showToast("Chấm điểm thành công!", "success");
          closeModal("submit-result-modal");
          refreshData(); // Refresh to show updated data
        } else {
          showToast(response.error || "Lỗi khi chấm điểm", "error");
        }
      })
      .withFailureHandler(function (error) {
        setButtonLoading(submitBtn, false);
        showToast("Lỗi: " + error.message, "error");
      })
      .submitTaskScore(taskId, score);
  }
</script>
